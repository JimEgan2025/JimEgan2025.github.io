<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Texas-NM Arctic Ridge: Final Master Lab</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0e14; color: #eee; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #map { height: 55vh; width: 100%; border-bottom: 3px solid #00ffcc; }
        .dashboard { flex: 1; padding: 10px; overflow-y: auto; background: #0f1218; }
        
        .cheaters-box { background: #1a1a2e; border: 2px solid #ff4444; border-left: 8px solid #ff4444; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.9em; color: #58a6ff; line-height: 1.4; }
        .stability-key { background: #161b22; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.75em; border: 1px solid #30363d; color: #8b949e; }
        
        .controls { background: #1c2128; padding: 10px; border-radius: 6px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; border: 1px solid #30363d; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(155px, 1fr)); gap: 8px; }
        
        .card { background: #161b22; padding: 8px; border-radius: 6px; border: 1px solid #30363d; font-size: 0.8em; border-top: 5px solid #3e94ff; }
        .vizcaya { border: 2px solid #00ffcc !important; background: #0d2a2a !important; border-top: 5px solid #00ffcc !important; }
        .nm-tag { border-top: 5px solid #ffaa00 !important; }

        /* TALL WIND ARROWS (.75 Scale) */
        .marker-body { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; background: rgba(62, 148, 255, 0.85); cursor: pointer; }
        .wind-arrow { font-size: 42px; font-weight: 900; color: white; text-shadow: 2px 2px 4px #000; }
        
        .metric { font-weight: bold; color: #fff; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="dashboard">
        <div id="cheaters-box" class="cheaters-box">
            <strong>üõ∞Ô∏è PILOT SYNOPSIS:</strong> 1038mb (30.65") Ridge Analysis. 
            <span id="synopsis">Calculating stability...</span>
        </div>

        <div class="controls">
            <b>12HR FORECAST:</b> <input type="range" id="ts" min="0" max="12" value="0" style="flex-grow:1;">
            <span id="hourVal" style="color:#ff4444; font-weight:bold; min-width:40px;">NOW</span>
        </div>

        <div id="city-grid" class="grid"></div>

        <div class="stability-key">
            <strong>üß† STABILITY DECODER:</strong><br>
            ‚Ä¢ <b>CAPE (Thunderstorm Fuel):</b> Measures energy available for rising air. Under this 30.60"+ Ridge, CAPE is <b>0</b> because air is sinking.<br>
            ‚Ä¢ <b>LI (Lifted Index):</b> +8 or higher means "Rock Solid" stability. Values below 0 indicate storm potential.
        </div>
    </div>

<script>
    const map = L.map('map').setView([31.0, -100.0], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    const markers = L.layerGroup().addTo(map);

    const locations = [
        { name: "Vizcaya", lat: 30.587, lon: -97.64, hub: true },
        { name: "Clovis", lat: 34.40, lon: -103.20, nm: true },
        { name: "Roswell", lat: 33.39, lon: -104.52, nm: true },
        { name: "Amarillo", lat: 35.22, lon: -101.83 },
        { name: "Childress", lat: 34.42, lon: -100.20 },
        { name: "Lubbock", lat: 33.57, lon: -101.88 },
        { name: "Wichita Falls", lat: 33.91, lon: -98.49 },
        { name: "Dallas", lat: 32.77, lon: -96.79 },
        { name: "Abilene", lat: 32.44, lon: -99.73 },
        { name: "Waco", lat: 31.54, lon: -97.14 },
        { name: "San Angelo", lat: 31.46, lon: -100.43 },
        { name: "Midland", lat: 31.99, lon: -102.07 },
        { name: "Pecos", lat: 31.42, lon: -103.49 },
        { name: "Fort Stockton", lat: 30.89, lon: -102.87 },
        { name: "Del Rio", lat: 29.36, lon: -100.89 },
        { name: "Austin", lat: 30.26, lon: -97.74 },
        { name: "Houston", lat: 29.76, lon: -95.36 },
        { name: "Corpus Christi", lat: 27.80, lon: -97.39 },
        { name: "Brownsville", lat: 25.90, lon: -97.50 }
    ];

    let cache = {};

    async function load() {
        for (let l of locations) {
            try {
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${l.lat}&longitude=${l.lon}&hourly=temperature_2m,dewpoint_2m,wind_direction_10m,pressure_msl,cape,lifted_index&timezone=auto&forecast_days=2&temperature_unit=fahrenheit`);
                cache[l.name] = await r.json();
            } catch(e) { console.error(l.name + " failed"); }
        }
        draw(0);
    }

    function draw(off) {
        const hr = new Date().getHours() + parseInt(off);
        markers.clearLayers();
        const grid = document.getElementById('city-grid');
        grid.innerHTML = '';

        locations.forEach(c => {
            const d = cache[c.name]?.hourly;
            if(!d || d.temperature_2m[hr] === undefined) return;

            const t = Math.round(d.temperature_2m[hr]);
            const dp = Math.round(d.dewpoint_2m[hr]);
            const p = (d.pressure_msl[hr] * 0.02953).toFixed(2);
            const wd = d.wind_direction_10m[hr];
            const cape = Math.round(d.cape[hr] || 0);
            const li = Math.round(d.lifted_index[hr] || 12);

            const icon = L.divIcon({
                className: '',
                html: `<div class="marker-body" style="${c.hub ? 'border-color:#00ffcc;' : ''} ${c.nm ? 'border-color:#ffaa00;' : ''}">
                        <div class="wind-arrow" style="transform: rotate(${wd+180}deg);">‚Üë</div>
                       </div>`,
                iconSize: [52, 52], iconAnchor: [26, 26]
            });

            L.marker([c.lat, c.lon], {icon}).addTo(markers)
             .bindPopup(`<b>${c.name}</b><br>Press: ${p}"<br>CAPE: ${cape}<br>LI: +${li}`);

            const card = document.createElement('div');
            card.className = `card ${c.hub ? 'vizcaya' : ''} ${c.nm ? 'nm-tag' : ''}`;
            card.innerHTML = `
                <strong>${c.name}</strong><br>
                Baro: <span class="metric">${p}"</span><br>
                Temp: <span class="metric">${t}¬∞F</span> | DP: <span class="metric" style="color:#58a6ff">${dp}¬∞F</span><br>
                <span style="font-size:0.85em; color:#ff7b72">CAPE: ${cape} | LI: +${li}</span>
            `;
            grid.appendChild(card);

            if(c.hub) {
                document.getElementById('synopsis').innerText = `HUB STATUS: Vizcaya Pressure at ${p}". High Plains air (NM Orange Tags) is exceptionally dry at ${dp}¬∞F. Combined with CAPE 0, the ridge is creating absolute vertical suppression.`;
            }
        });
        document.getElementById('hourVal').innerText = off == 0 ? "NOW" : "+"+off+"H";
    }

    load();
    document.getElementById('ts').oninput = (e) => draw(e.target.value);
</script>
</body>
</html>
