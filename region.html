<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gulf OPS v11.0 - Texas Regional Focus</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{
  --bg:#020617; --panel:#0f172a; --border:#1e293b; --text:#e5e7eb;
  --muted:#94a3b8; --ok:#22c55e; --warn:#ef4444; --watch:#fde047; --risk:#f97316; --marine:#06b6d4;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui;overflow:hidden;}
header{padding:0 16px;background:#020617;border-bottom:2px solid var(--border);display:flex;justify-content:space-between;align-items:center;height:50px;}
.grid{display:grid;grid-template-columns:1fr 320px;height:calc(100vh - 50px);}
#map{height:100%;background:#020617;}
.side{display:flex;flex-direction:column;gap:8px;padding:8px;overflow-y:auto;border-left:1px solid var(--border);}
.card{background:var(--panel);border-radius:6px;padding:12px;border:1px solid var(--border);flex-shrink:0;}
.card h2{margin:0 0 4px;font-size:0.65rem;text-transform:uppercase;color:var(--muted);border-bottom:1px solid rgba(255,255,255,0.05);}
.big{font-size:1.4rem;font-weight:900;line-height:1.1;letter-spacing:-0.5px;}
.small{font-size:0.75rem;color:var(--muted);margin-top:4px;}
.warn{color:var(--warn);} .marine{color:var(--marine); font-weight:bold;}
button{background:#1e293b;color:var(--text);border:1px solid var(--border);border-radius:4px;padding:5px 10px;cursor:pointer;font-size:0.7rem;font-weight:600;}
button.active{background:var(--risk);color:white;border-color:white;}
#timestamp{font-family:monospace; font-size: 0.75rem; color: var(--muted); background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px;}
</style>
</head>
<body>
<header>
  <div style="display:flex; align-items:center; gap:15px;">
    <h1 style="font-size:1.1rem; margin:0;">REGIONAL OPS <span style="color:var(--risk)">v11.0</span></h1>
    <div id="timestamp">SYNCING LIVE...</div>
  </div>
  <div style="display:flex; gap:5px;">
    <button id="btnSST" onclick="toggleLayer('sst', this)">OCEAN TEMP</button>
    <button id="btnSPC" class="active" onclick="toggleLayer('spc', this)">SPC / MD</button>
    <button id="btnRadar" class="active" onclick="toggleLayer('radar', this)">RADAR</button>
    <button id="btnHaz" class="active" onclick="toggleLayer('hazards', this)">HAZARDS/MARINE</button>
  </div>
</header>
<div class="grid">
  <div id="map"></div>
  <div class="side">
    <div class="card"><h2>Mission Status (TX Sector)</h2><div class="big" id="gogo">STABLE</div><div class="small" id="gogoDetail">All Land Operations Clear</div></div>
    <div class="card"><h2>Severe Warnings</h2><div id="warnings" class="small">Scanning...</div></div>
    <div class="card"><h2>Marine (Gulf Early Warning)</h2><div id="marine" class="small">Scanning...</div></div>
    <div class="card" style="flex-grow:1"><h2>Advisories & Watches</h2><div id="watches" class="small">--</div></div>
  </div>
</div>

<script>
const map = L.map('map', {zoomControl: false, minZoom: 4}).setView([31.0, -97.0], 6); // Centered on Texas
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

const sstLayer = L.tileLayer.wms("https://nowcoast.noaa.gov/arcgis/services/nowcoast/analysis_ocean_sfc_sst_time/MapServer/WmsServer", {
  layers: "1", format: 'image/png', transparent: true, opacity: 0.5
});

const radar = L.tileLayer.wms("https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi", {
  layers: "nexrad-n0r", format: 'image/png', transparent: true, opacity: 0.4
}).addTo(map);

const hazardLayer = L.layerGroup().addTo(map);

// REFINED MARINE ZONES: Coordinates for Actual Coastal Areas
const coastPoly = {
  "LA": [[29.7, -93.8], [28.8, -93.8], [28.5, -89.4], [29.3, -89.1], [30.1, -89.6]],
  "TX-Upper": [[29.7, -94.2], [29.2, -94.7], [28.0, -94.0], [28.5, -93.0]],
  "TX-Lower": [[28.5, -96.5], [26.0, -97.2], [26.0, -96.5], [28.0, -95.5]],
  "FL": [[30.4, -87.4], [29.5, -87.4], [29.5, -83.5], [30.1, -83.5]]
};

async function fetchAlerts() {
  try {
    const res = await fetch("https://api.weather.gov/alerts/active?area=TX,NM,OK,AR,LA,MS,AL,FL");
    const data = await res.json();
    hazardLayer.clearLayers();
    const ui = { warn: document.getElementById("warnings"), marine: document.getElementById("marine"), watch: document.getElementById("watches") };
    Object.values(ui).forEach(div => div.innerHTML = "Clear");
    let txRisk = false;

    data.features.forEach(a => {
      const p = a.properties;
      const k = p.event.toLowerCase(), state = p.areaDesc.split(';')[0].substring(0,2);
      
      if(a.geometry) {
        let color = k.includes("tornado") ? "#ff0000" : (k.includes("severe") ? "#ffff00" : "#06b6d4");
        L.geoJSON(a, { style: { color: color, weight: 3, fillOpacity: 0.3 } }).addTo(hazardLayer);
      } else if (k.includes("craft") || k.includes("gale") || k.includes("marine")) {
        // Map the alert to the refined coastline polygons
        let poly = coastPoly[state];
        if (state === "TX") poly = coastPoly["TX-Upper"]; // Default to upper for simplicity
        if(poly) L.polygon(poly, {color: '#06b6d4', fillOpacity: 0.4, weight: 1}).addTo(hazardLayer);
      }

      if (k.includes("marine") || k.includes("craft")) {
        if(ui.marine.innerText === "Clear") ui.marine.innerHTML = "";
        ui.marine.innerHTML += `<div class="alert-item marine">${p.event} [${state}]</div>`;
      } else if(k.includes("warning")) {
        if(ui.warn.innerText === "Clear") ui.warn.innerHTML = "";
        ui.warn.innerHTML += `<div class="alert-item warn">${p.event} [${state}]</div>`;
        if(state === "TX") txRisk = true;
      } else {
        if(ui.watch.innerText === "Clear") ui.watch.innerHTML = "";
        ui.watch.innerHTML += `<div class="alert-item watch">${p.event} [${state}]</div>`;
      }
    });

    document.getElementById("gogo").innerText = txRisk ? "STORM ALERT" : "STABLE";
    document.getElementById("gogo").className = txRisk ? "big warn" : "big ok";
    document.getElementById("timestamp").innerText = "SYNC: " + new Date().toLocaleTimeString();
  } catch(e) { console.error("Alert Sync Error"); }
}

function toggleLayer(type, btn) {
    btn.classList.toggle('active');
    const active = btn.classList.contains('active');
    if(type === 'radar') active ? map.addLayer(radar) : map.removeLayer(radar);
    if(type === 'hazards') active ? map.addLayer(hazardLayer) : map.removeLayer(hazardLayer);
    if(type === 'sst') active ? map.addLayer(sstLayer) : map.removeLayer(sstLayer);
}

fetchAlerts();
setInterval(fetchAlerts, 300000);
</script>
</body>
</html>
