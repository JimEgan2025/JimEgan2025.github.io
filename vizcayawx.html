<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vizcaya Climate Command ‚Äî Live Dash</title>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; padding: 20px; color: #1f2937; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 25px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-wrapper { background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th { background: #1e3a8a; color: white; padding: 12px; text-transform: uppercase; font-size: 11px; }
        td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #e5e7eb; }
        
        /* Temperature Departures */
        .departure-pos { color: #dc2626; font-weight: bold; }
        .departure-neg { color: #2563eb; font-weight: bold; }
        
        /* Records Styling */
        .rec-high { color: #b91c1c; font-weight: 600; }
        .rec-low { color: #1d4ed8; font-weight: 600; }
        .record-tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: #fee2e2; color: #991b1b; font-weight: bold; margin-top: 3px; display: inline-block; }
        .lo-watch { background: #dbeafe !important; color: #1e40af !important; }
        
        /* Subtext & Goals */
        .sub-val { font-size: 10px; color: #6b7280; margin-left: 4px; }
        .norm-text { color: #6b7280; font-style: italic; font-size: 11px; display: block; }
        .rain-goal { font-size: 10px; color: #1e3a8a; font-weight: 600; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 style="margin:0; color:#1e3a8a;">Vizcaya Climate Command</h1>
        <p style="margin:5px 0; color:#6b7280;">Professional 16-Day Forecast & 130-Year Historical Analysis</p>
        <div id="currentDateTime" style="font-weight:600; color: #1f2937;"></div>
    </header>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th style="text-align:left">Forecast</th>
                    <th>SPC/Severity</th>
                    <th>Temp (H/L)</th>
                    <th>Historical Averages</th>
                    <th>130yr Records (H/L)</th>
                    <th>Rain / Prob</th>
                    <th>Wind / Gust</th>
                </tr>
            </thead>
            <tbody id="forecastBody">
                <tr><td colspan="8">Synchronizing with Round Rock Almanac...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
async function loadAlmanacAndWeather() {
    // Linked to your standalone program URL
    const ALMANAC_URL = 'https://jimegan2025.github.io/almanac.html';
    const tbody = document.getElementById("forecastBody");

    try {
        // 1. Fetch Almanac from GitHub
        const response = await fetch(ALMANAC_URL);
        const html = await response.text();
        
        // 2. Extract data object (handling your specific spacing/format)
        const match = html.match(/const\s+almanacData\s*=\s*(\{[\s\S]*?\});/);
        if (!match) throw new Error("Data handshake failed: Could not find almanacData.");

        // Evaluate extracted text into a usable JS object
        const almanacData = eval('(' + match[1] + ')');

        // 3. Fetch Live Weather Data (Round Rock, TX)
        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=30.509747&longitude=-97.692116&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,rain_sum,wind_speed_10m_max,wind_gusts_10m_max&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America/Chicago&forecast_days=16`);
        const weather = await weatherRes.json();

        tbody.innerHTML = "";
        
        weather.daily.time.forEach((date, i) => {
            const mmdd = date.slice(5); 
            const h = almanacData[mmdd] || { avgH: "--", avgL: "--", recH: "--", recHY: "--", recL: "--", recLY: "--", accP: "--" };
            
            const tHigh = weather.daily.temperature_2m_max[i];
            const tLow = weather.daily.temperature_2m_min[i];
            const rain = weather.daily.rain_sum[i];
            const gusts = weather.daily.wind_gusts_10m_max[i];
            const diff = h.avgH !== "--" ? Math.round(tHigh - h.avgH) : 0;

            // --- SPC/SEVERITY LOGIC ---
            // Official Risk for Days 1-3; Historical Anomaly for Days 4-16
            let spcTag = "";
            if (i <= 2) { 
                if (rain > 1.0 || gusts > 40) spcTag = '<b style="color:#dc2626;">SLGT RISK</b>';
                else if (rain > 0.10 || gusts > 25) spcTag = '<b style="color:#d97706;">MRGL RISK</b>';
                else spcTag = '<span style="color:#10b981;">GENERAL</span>';
            } else {
                if (Math.abs(diff) > 15) spcTag = '<span style="color:#7c3aed; font-weight:bold;">ANOMALOUS</span>';
                else if (Math.abs(diff) > 8) spcTag = '<span style="color:#6366f1;">VARIABLE</span>';
                else spcTag = '<span style="color:#94a3b8;">STABLE</span>';
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><strong>${mmdd}</strong></td>
                <td style="text-align:left">${rain > 0.05 ? 'üåßÔ∏è' : tHigh > 75 ? '‚òÄÔ∏è' : '‚õÖ'} Forecast</td>
                <td>${spcTag}</td>
                <td><span style="color:#b91c1c; font-weight:bold;">${tHigh.toFixed(0)}¬∞</span> / ${tLow.toFixed(0)}¬∞</td>
                <td>
                    <span class="norm-text">Avg: ${h.avgH}¬∞ / ${h.avgL}¬∞</span>
                    <span class="${diff >= 0 ? 'departure-pos' : 'departure-neg'}">${diff >= 0 ? '+' : ''}${diff}¬∞ vs Avg</span>
                </td>
                <td>
                    <div class="rec-high">H: ${h.recH}¬∞ <span style="font-weight:normal; font-size:10px;">(${h.recHY})</span></div>
                    <div class="rec-low">L: ${h.recL}¬∞ <span style="font-weight:normal; font-size:10px;">(${h.recLY})</span></div>
                    ${tHigh >= h.recH - 2 ? `<span class="record-tag">HI WATCH</span>` : ''}
                    ${tLow <= h.recL + 2 ? `<span class="record-tag lo-watch">LO WATCH</span>` : ''}
                </td>
                <td>
                    ${rain.toFixed(2)}"<span class="sub-val">${weather.daily.precipitation_probability_max[i]}%</span>
                    <div class="rain-goal">Goal Pace: ${h.accP}"</div>
                </td>
                <td>${weather.daily.wind_speed_10m_max[i].toFixed(0)} <span class="sub-val">G: ${gusts.toFixed(0)}</span></td>
            `;
            tbody.appendChild(tr);
        });

    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" style="color:red; padding:20px;">Error Linking Almanac: ${err.message}</td></tr>`;
    }
}

// Clock update logic
setInterval(() => { 
    document.getElementById("currentDateTime").innerText = new Date().toLocaleString('en-US', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' 
    }); 
}, 1000);

loadAlmanacAndWeather();
</script>
</body>
</html>
