<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Texas All-Hazards Live OPS Dashboard v11</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#020617; --panel:#0f172a; --border:#1e293b; --text:#e5e7eb;
  --muted:#94a3b8; --ok:#22c55e; --warn:#dc2626; --watch:#fde047;
  --risk:#fb923c;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui;}
header{padding:10px 16px;background:#020617;border-bottom:3px solid var(--risk);display:flex;justify-content:space-between;align-items:center;}
h1{margin:0;font-size:1.4rem;}
.grid{display:grid;grid-template-columns:2.5fr 1fr;height:calc(100vh - 56px);}
#map{height:100%;}
.side{display:grid;grid-template-rows:repeat(8,1fr);gap:8px;padding:8px;}
.card{background:var(--panel);border-radius:12px;padding:10px;box-shadow:0 10px 25px rgba(0,0,0,.5);}
.card h2{margin:0 0 6px;font-size:.9rem;color:var(--risk);}
.big{font-size:1.6rem;font-weight:800;}
.small{font-size:.8rem;color:var(--muted);}
.ok{color:var(--ok);font-weight:700;}
.warn{color:var(--warn);font-weight:800;}
.watch{color:var(--watch);font-weight:700;}
.md-entry{cursor:pointer;margin:2px 0;padding:3px;border-radius:4px;}
.md-entry:hover{background:#1f2937;}
.loading{color:var(--muted);font-style:italic;}
button{background:#020617;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:5px 8px;cursor:pointer;}
img{border-radius:8px;max-width:100%;}
</style>
</head>

<body>
<header>
<h1>ðŸŒŽ Texas All-Hazards Live OPS Dashboard v11</h1>
<div>
  <button onclick="toggleRadar()">Radar</button>
  <button onclick="toggleVelocity()">Velocity</button>
</div>
</header>

<div class="grid">
  <div id="map"></div>
  <div class="side">

    <div class="card">
      <h2>GO / NO-GO STATUS</h2>
      <div class="big loading" id="gogo">LOADINGâ€¦</div>
      <div class="small" id="gogoDetail">Waiting for live dataâ€¦</div>
    </div>

    <div class="card">
      <h2>SPC Convective Outlook</h2>
      <img id="spcImg" src="https://www.spc.noaa.gov/products/outlook/day1otlk_1.png">
      <div class="small">SPC Day 1 Outlook</div>
    </div>

    <div class="card">
      <h2>Active Warnings</h2>
      <div id="warnings" class="loading">LOADINGâ€¦</div>
    </div>

    <div class="card">
      <h2>Active Watches</h2>
      <div id="watches" class="loading">LOADINGâ€¦</div>
    </div>

    <div class="card">
      <h2>Mesoscale Discussions</h2>
      <div id="mds" class="loading">LOADINGâ€¦</div>
    </div>

    <div class="card">
      <h2>Marine / Coastal Alerts</h2>
      <div id="marine" class="loading">LOADINGâ€¦</div>
    </div>

    <div class="card">
      <h2>Tropical / NHC</h2>
      <div id="tropical" class="loading">LOADINGâ€¦</div>
    </div>

    <div class="card">
      <h2>Overnight / Next-Shift Risk</h2>
      <div class="big" id="overnightRisk">EVALUATINGâ€¦</div>
      <div class="small" id="overnightDetail"></div>
    </div>

  </div>
</div>

<script>
// ---------------- MAP ----------------
const map = L.map('map').setView([30.5, -99],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);

// Radar & Velocity
let radar = L.tileLayer.wms(
  "https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",
  {layers:"nexrad-n0r", transparent:true, opacity:.65}
).addTo(map);

let velocity = L.tileLayer.wms(
  "https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi",
  {layers:"nexrad-n0q", transparent:true, opacity:.65}
);

// ---------------- FETCH LIVE ALERTS ----------------
async function fetchAlerts(){
  try {
    const resp = await fetch("https://api.weather.gov/alerts/active?area=TX");
    const alerts = await resp.json();

    const warnEl = document.getElementById("warnings");
    const watchEl = document.getElementById("watches");
    const marineEl = document.getElementById("marine");
    const tropEl = document.getElementById("tropical");
    const mdEl = document.getElementById("mds");

    warnEl.innerHTML=""; watchEl.innerHTML=""; marineEl.innerHTML=""; tropEl.innerHTML=""; mdEl.innerHTML="";

    let noGo = false;

    alerts.features.forEach(a => {
      const text = a.properties.event;
      const key = text.toLowerCase();
      const li = document.createElement("div");

      // Warnings
      if(key.includes("warning") && !key.includes("marine") && !key.includes("tropical")){
        li.className="warn"; li.innerText=text; warnEl.appendChild(li); noGo=true;
      }

      // Watches
      else if(key.includes("watch") && !key.includes("marine") && !key.includes("tropical")){
        li.className="watch"; li.innerText=text; watchEl.appendChild(li);
      }

      // Marine / Coastal
      if(key.includes("marine") || key.includes("gale") || key.includes("storm")){
        li.className="watch"; li.innerText=text; marineEl.appendChild(li); noGo=true;
      }

      // Tropical / NHC
      if(key.includes("tropical") || key.includes("hurricane")){
        li.className="warn"; li.innerText=text; tropEl.appendChild(li); noGo=true;
      }

      // Mesoscale Discussions links
      if(key.includes("mesoscale")){
        const mdLink = a.properties.link || "#";
        const mdEntry = document.createElement("div");
        mdEntry.className="md-entry watch";
        mdEntry.innerText=text;
        mdEntry.onclick = ()=> window.open(mdLink,"_blank");
        mdEl.appendChild(mdEntry);
      }
    });

    const gogoEl = document.getElementById("gogo");
    gogoEl.innerText=noGo?"NO-GO":"GO";
    gogoEl.className=noGo?"big warn":"big ok";

  } catch(e){
    console.error("Alerts fetch error:", e);
    setTimeout(fetchAlerts,5000);
  }
}

// ---------------- OVERNIGHT / NEXT SHIFT ----------------
function evaluateOvernight(){
  const h = new Date().getHours();
  const night = (h >=18 || h<=6);
  document.getElementById("overnightRisk").innerText = night?"ELEVATED":"MONITOR";
  document.getElementById("overnightDetail").innerText = night
    ?"Overnight hazards possible (storms / freeze / coastal)"
    :"Await daytime hazard evolution";
}

// ---------------- TOGGLE LAYERS ----------------
function toggleRadar(){ map.hasLayer(radar)?map.removeLayer(radar):map.addLayer(radar); }
function toggleVelocity(){ map.hasLayer(velocity)?map.removeLayer(velocity):map.addLayer(velocity); }

// ---------------- INITIAL LOAD ----------------
fetchAlerts(); evaluateOvernight();
setInterval(fetchAlerts,300000); // 5 min
setInterval(evaluateOvernight,3600000); // 1 hr
</script>

</body>
</html>


