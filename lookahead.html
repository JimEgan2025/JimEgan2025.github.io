<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round Rock Weather Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; color: #1c1e21; margin: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
        
        .almanac-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 40px; }
        .almanac-card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; background: #fff; text-align: center; }
        .almanac-card.warmer { border-top: 5px solid #ff4d4f; background: #fff2f0; }
        .almanac-card.cooler { border-top: 5px solid #1890ff; background: #e6f7ff; }
        .date-label { font-weight: bold; font-size: 1rem; color: #333; }
        .temp-row { display: flex; justify-content: space-around; margin: 8px 0; }
        .temp-val { display: flex; flex-direction: column; font-size: 1.1rem; font-weight: bold; }
        .temp-val small { font-size: 0.65rem; color: #666; text-transform: uppercase; font-weight: normal; }
        .departure { font-size: 0.8rem; font-weight: bold; }

        .chart-container { position: relative; height: 300px; margin-bottom: 30px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; align-items: flex-end; }
        .status-box { padding: 10px; border-radius: 5px; font-size: 0.85rem; margin-bottom: 10px; display: none; }
        .error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; display: block; }
        .loading { background: #e6f7ff; border: 1px solid #91d5ff; color: #1890ff; display: block; }
        
        button { padding: 10px 20px; background: #004085; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        h3 { color: #333; border-left: 5px solid #004085; padding-left: 10px; margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Weather Intelligence</h1>
        <div id="status" class="status-box">Ready</div>
    </div>

    <div class="controls">
        <div style="display:flex; flex-direction:column; font-size:0.8rem;">
            <label>Lat/Lon</label>
            <input type="text" id="coords" value="30.5871, -97.641" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
        </div>
        <button onclick="updateDashboard()">Refresh Forecast</button>
    </div>

    <div id="almanac-section">
        <h3>10-Day Almanac (Expected vs. Normal)</h3>
        <div id="almanac" class="almanac-grid"></div>
    </div>

    <h3>35-Day Temperature Trend</h3>
    <div class="chart-container"><canvas id="tempChart"></canvas></div>

    <h3>35-Day Cumulative Rainfall</h3>
    <div class="chart-container"><canvas id="precipChart"></canvas></div>
</div>

<script>
    let tempChart, precipChart;
    const DateTime = luxon.DateTime;

    function setStatus(msg, type) {
        const s = document.getElementById('status');
        s.innerText = msg;
        s.className = 'status-box ' + type;
    }

    async function updateDashboard() {
        setStatus("Fetching weather data...", "loading");
        
        const coords = document.getElementById('coords').value.split(',');
        const lat = coords[0].trim();
        const lon = coords[1].trim();
        const start = DateTime.now();

        // 1. Forecast URL (Ensemble)
        const fUrl = `https://ensemble-api.open-meteo.com/v1/ensemble?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation&models=gfs_seamless&temperature_unit=fahrenheit&precipitation_unit=inch&forecast_days=35`;
        
        // 2. Historical URLs (Last 3 years) - Using older years to avoid "partial data" errors
        const historicalYears = [2021, 2022, 2023]; 
        const hUrls = historicalYears.map(year => {
            const hStart = start.set({ year: year }).toISODate();
            const hEnd = start.plus({ days: 34 }).set({ year: year }).toISODate();
            return `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${hStart}&end_date=${hEnd}&hourly=temperature_2m,precipitation&temperature_unit=fahrenheit&precipitation_unit=inch`;
        });

        try {
            const fRes = await fetch(fUrl);
            if (!fRes.ok) throw new Error("Forecast API failed");
            const fData = await fRes.json();

            const hDataSets = [];
            for (const url of hUrls) {
                const res = await fetch(url);
                if (res.ok) hDataSets.push(await res.json());
            }

            if (hDataSets.length === 0) throw new Error("Could not load historical data");

            renderAlmanac(fData, hDataSets);
            renderCharts(fData, hDataSets);
            setStatus("Data Updated: " + DateTime.now().toLocaleString(DateTime.TIME_SIMPLE), "loading");
            setTimeout(() => setStatus("Ready", ""), 2000);

        } catch (e) {
            setStatus("Error: " + e.message, "error");
            console.error(e);
        }
    }

    function renderAlmanac(fData, hDataSets) {
        const container = document.getElementById('almanac');
        container.innerHTML = '';
        
        const fTempKeys = Object.keys(fData.hourly).filter(k => k.startsWith('temperature_2m_member'));
        // Use the 'precipitation' mean key directly if individual members are missing
        const fPrecipKey = fData.hourly.precipitation ? 'precipitation' : 'precipitation_member00';

        for (let d = 0; d < 10; d++) {
            const startIdx = d * 24;
            const endIdx = startIdx + 24;

            // Forecast Calculations
            const hourlyAverages = [];
            for (let i = startIdx; i < endIdx; i++) {
                const avg = fTempKeys.reduce((sum, k) => sum + fData.hourly[k][i], 0) / fTempKeys.length;
                hourlyAverages.push(avg);
            }
            const fHigh = Math.max(...hourlyAverages);
            const fRain = fData.hourly[fPrecipKey] ? fData.hourly[fPrecipKey].slice(startIdx, endIdx).reduce((a, b) => a + b, 0) : 0;

            // Historical Calculations
            let hHighs = [], hRains = [];
            hDataSets.forEach(ds => {
                if (ds.hourly && ds.hourly.temperature_2m) {
                    const slice = ds.hourly.temperature_2m.slice(startIdx, endIdx);
                    hHighs.push(Math.max(...slice));
                    hRains.push(ds.hourly.precipitation.slice(startIdx, endIdx).reduce((a, b) => a + b, 0));
                }
            });

            const nHigh = hHighs.reduce((a, b) => a + b, 0) / hHighs.length;
            const nRain = hRains.reduce((a, b) => a + b, 0) / hRains.length;
            const departure = fHigh - nHigh;

            const card = document.createElement('div');
            card.className = `almanac-card ${departure > 2 ? 'warmer' : (departure < -2 ? 'cooler' : '')}`;
            card.innerHTML = `
                <div class="date-label">${DateTime.fromISO(fData.hourly.time[startIdx]).toFormat('ccc, MMM d')}</div>
                <div class="temp-row">
                    <div class="temp-val"><small>Exp High</small>${Math.round(fHigh)}°</div>
                    <div class="temp-val" style="color:#888"><small>Normal</small>${Math.round(nHigh)}°</div>
                </div>
                <div class="departure" style="color:${departure > 0 ? '#d93025' : '#1a73e8'}">
                    ${departure > 0 ? '↑' : '↓'} ${Math.abs(departure).toFixed(1)}° vs Norm
                </div>
                <div style="font-size:0.75rem; margin-top:10px; border-top:1px solid #eee; padding-top:5px;">
                    Rain: ${fRain.toFixed(2)}" <small>(Avg: ${nRain.toFixed(2)}")</small>
                </div>
            `;
            container.appendChild(card);
        }
    }

    function renderCharts(fData, hDataSets) {
        const times = fData.hourly.time;
        const fTempKeys = Object.keys(fData.hourly).filter(k => k.startsWith('temperature_2m_member'));
        const fPrecipKey = fData.hourly.precipitation ? 'precipitation' : 'precipitation_member00';

        const tMean = [], tMin = [], tMax = [], htMean = [];
        const pMean = [], pMin = [], pMax = [], hpMean = [];

        let fPAcc = 0, hPAccs = new Array(hDataSets.length).fill(0);

        for (let i = 0; i < times.length; i++) {
            // Temperature
            const tVals = fTempKeys.map(k => fData.hourly[k][i]);
            tMean.push({ x: times[i], y: tVals.reduce((a,b)=>a+b,0) / tVals.length });
            tMin.push({ x: times[i], y: Math.min(...tVals) });
            tMax.push({ x: times[i], y: Math.max(...tVals) });

            const htVals = hDataSets.map(ds => ds.hourly.temperature_2m[i]);
            htMean.push({ x: times[i], y: htVals.reduce((a,b)=>a+b,0) / htVals.length });

            // Precipitation (Cumulative)
            fPAcc += (fData.hourly[fPrecipKey][i] || 0);
            pMean.push({ x: times[i], y: fPAcc });
            
            let hpSum = 0;
            hDataSets.forEach((ds, idx) => {
                hPAccs[idx] += (ds.hourly.precipitation[i] || 0);
                hpSum += hPAccs[idx];
            });
            hpMean.push({ x: times[i], y: hpSum / hDataSets.length });
        }

        draw('tempChart', tMean, tMin, tMax, htMean, 'Temp °F', '#007bff');
        draw('precipChart', pMean, null, null, hpMean, 'Rain Inches', '#28a745');
    }

    function draw(id, mean, min, max, hist, label, color) {
        const ctx = document.getElementById(id).getContext('2d');
        if (id === 'tempChart' && tempChart) tempChart.destroy();
        if (id === 'precipChart' && precipChart) precipChart.destroy();

        const ds = [
            { label: 'Normal', data: hist, borderColor: '#444', borderDash: [5,5], borderWidth: 2, pointRadius: 0, fill: false },
            { label: 'Forecast', data: mean, borderColor: color, borderWidth: 3, pointRadius: 0, fill: false }
        ];

        if (min && max) {
            ds.unshift({ label: 'Min', data: min, borderColor: 'transparent', pointRadius: 0, fill: false });
            ds.unshift({ label: 'Range', data: max, borderColor: 'transparent', backgroundColor: color.replace('1)', '0.1)'), fill: '-1', pointRadius: 0 });
        }

        const c = new Chart(ctx, {
            type: 'line',
            data: { datasets: ds },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'day' } } },
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }
            }
        });

        if (id === 'tempChart') tempChart = c; else precipChart = c;
    }

    updateDashboard();
</script>

</body>
</html>
