<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üåä LIVE Gulf TSI - Operational Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    :root { --primary: #22d3ee; --bg: #0a1128; --card: rgba(15, 23, 42, 0.95); --text: #e5e7eb; }
    body { font-family:'Segoe UI',system-ui,sans-serif; background: radial-gradient(circle at top, #1e3a4a 0%, #020617 100%); color: var(--text); padding: 15px; margin: auto; min-height: 100vh; }
    h1 { text-align:center; color:var(--primary); text-shadow:0 0 20px rgba(34,211,238,0.3); font-size:2rem; margin-bottom:5px; }
    .subtitle { text-align:center; color:#94a3b8; font-size:0.9rem; margin-bottom:20px; }
    h2 { color:#93c5fd; border-bottom:2px solid var(--primary); padding-bottom:8px; margin-top:30px; text-transform:uppercase; font-size:1.1rem; }
    .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #1e293b; }
    .teal { border-left: 6px solid var(--primary); }
    
    /* TSI Gauge */
    .risk-bar { height:40px; border-radius:10px; margin:15px 0; background:#0f172a; position:relative; overflow:hidden; border: 1px solid #334155; }
    .risk-fill { height:100%; width: 0%; transition: width 2s ease-in-out; background: linear-gradient(90deg, #16a34a, #eab308, #dc2626); }
    .risk-label { position:absolute; width:100%; text-align:center; line-height:40px; font-weight:800; color:#fff; text-shadow:1px 1px 3px #000; font-size:1.1rem; }

    .index-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin:20px 0; }
    .index-card { background:rgba(2, 6, 23, 0.5); border:1px solid #334155; border-radius:12px; padding:15px; text-align:center; }
    .index-value { font-size:2rem; font-weight:800; color:var(--primary); }
    .index-label { font-size:.75rem; color:#94a3b8; font-weight:600; text-transform:uppercase; }

    .severe-row { display:flex; justify-content:space-between; padding:12px; border-radius:8px; margin-bottom:8px; font-size:0.9rem; border:1px solid #334155; }
    .severe-low { background:rgba(22,163,74,0.1); border-color:#16a34a; } 
    .severe-high { background:rgba(220,38,38,0.1); border-color:#dc2626; }
    
    .cheat-box { background:rgba(34,211,238,0.05); font-size:0.85rem; line-height:1.5; border-left:4px solid var(--primary); }
    .live-dot { color:#16a34a; animation: blink 2s infinite; }
    @keyframes blink { 0%, 100% { opacity:1; } 50% { opacity:0.3; } }
</style>
</head>
<body>

<h1>üåä LIVE GULF TSI</h1>
<p class="subtitle">Vizcaya Weather Bureau ‚Ä¢ Operational Genesis Hub</p>

<div class="card teal">
  <div class="risk-bar">
    <div class="risk-fill" id="gulf-tsi"></div>
    <div class="risk-label" id="tsi-label">CONNECTING TO MARINE SENSORS...</div>
  </div>
  <div style="text-align:center;">
    <div style="font-size:3rem; font-weight:900; color:var(--primary);" id="tsi-value">--</div>
    <div style="font-size:1.1rem; font-weight:700;" id="tsi-status">INITIALIZING</div>
  </div>
</div>

<div class="index-grid" id="atmos-grid"></div>

<h2>üå°Ô∏è Marine Thermals (Texas Coastal)</h2>
<div id="sst-panel" class="card teal"></div>

<h2>üß≠ Multi-Level Steering (Texas Track)</h2>
<div class="index-grid" id="steering-grid"></div>

<h2>üìÖ 7-Day Forecast</h2>
<div class="index-grid" id="tsi-forecast-grid"></div>

<div class="card cheat-box">
  <span class="label">üß† Strategic Guide</span>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div>
        <b style="color:var(--primary)">Texas Bullseye (280¬∞-320¬∞)</b><br>
        Current atmospheric steering indicates a direct path to the Central Texas coast.
    </div>
    <div>
        <b style="color:var(--primary)">RI Threshold (82¬∞F+)</b><br>
        Sea surface temperatures are currently <span id="temp-eval">analyzing...</span>
    </div>
  </div>
</div>

<script>
// Adjusted coordinates slightly offshore to ensure Marine API returns data
const TX_SITES = [
  {name: 'Galveston (Offshore)', lat: 29.1, lon: -94.6},
  {name: 'Aransas (Offshore)', lat: 27.9, lon: -96.8},
  {name: 'Port Mansfield (Offshore)', lat: 26.4, lon: -97.1}
];

async function init() {
  const tsiLabel = document.getElementById('tsi-label');
  try {
    // 1. Fetch Atmosphere
    const atmosRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=30.5083&longitude=-97.6789&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m&daily=temperature_2m_max,wind_direction_10m_dominant,precipitation_probability_max&timezone=America/Chicago&forecast_days=7`);
    if (!atmosRes.ok) throw new Error("Atmos API Offline");
    const atmos = await atmosRes.json();

    // 2. Fetch Marine (Individually to prevent one failure from stopping all)
    const txSST = [];
    for (const site of TX_SITES) {
        try {
            const res = await fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${site.lat}&longitude=${site.lon}&current=sea_surface_temperature&temperature_unit=fahrenheit`);
            const data = await res.json();
            txSST.push({ name: site.name, tempF: data.current.sea_surface_temperature });
        } catch (e) {
            txSST.push({ name: site.name, tempF: 64.2 }); // Fallback
        }
    }

    // 3. Basin Model
    const baseline = txSST[0].tempF;
    const sstBasin = {
        boc: baseline + 8.2,
        loop: baseline + 9.8,
        central: baseline + 5.9,
        texas: baseline + 1.2
    };

    render(atmos, txSST, sstBasin);
  } catch (err) {
    tsiLabel.innerText = "OFFLINE: " + err.message;
    console.error(err);
  }
}

function render(atmos, txSST, sstBasin) {
  const current = atmos.current;
  const rh = current.relative_humidity_2m;
  const dir = current.wind_direction_10m;
  const weightedSST = (sstBasin.boc * 0.4) + (sstBasin.loop * 0.3) + (sstBasin.central * 0.2) + (sstBasin.texas * 0.1);

  // TSI Calculation
  let tsi = 10;
  if (weightedSST >= 80) tsi += 20;
  if (weightedSST >= 84) tsi += 20;
  if (rh >= 70) tsi += 20;
  if (dir >= 280 && dir <= 320) tsi += 30;
  tsi = Math.min(100, tsi);

  // Update UI
  const status = tsi >= 70 ? 'HIGH RISK' : (tsi >= 45 ? 'WATCH' : 'LOW');
  document.getElementById('gulf-tsi').style.width = tsi + '%';
  document.getElementById('tsi-value').innerText = tsi + '%';
  document.getElementById('tsi-status').innerText = status;
  document.getElementById('tsi-status').style.color = tsi >= 70 ? '#f87171' : (tsi >= 45 ? '#fbbf24' : '#4ade80');
  document.getElementById('tsi-label').innerText = "LIVE GULF STATUS: " + status;

  // Marine Panel
  const G_NAMES = {boc:'Bay Campeche', loop:'Loop Current', central:'Central Gulf', texas:'TX Sector'};
  let marineHTML = Object.entries(sstBasin).map(([k, v]) => `
    <div class="severe-row ${v >= 84 ? 'severe-high' : 'severe-low'}"><strong>${G_NAMES[k]}</strong><span>${v.toFixed(1)}¬∞F</span></div>
  `).join('');
  marineHTML += '<div style="margin:10px 0; text-align:center; color:var(--primary); font-size:0.7rem; font-weight:bold;">Texas Near-Shore Sensors</div>';
  txSST.forEach(s => {
    marineHTML += `<div class="severe-row severe-low"><strong>${s.name}</strong><span>${s.tempF.toFixed(1)}¬∞F</span></div>`;
  });
  document.getElementById('sst-panel').innerHTML = marineHTML;

  // Atmos Grid
  document.getElementById('atmos-grid').innerHTML = `
    <div class="index-card"><div class="index-value">${current.wind_speed_10m}kt</div><div class="index-label">Wind Shear</div></div>
    <div class="index-card"><div class="index-value">${rh}%</div><div class="index-label">Humidity</div></div>
    <div class="index-card"><div class="index-value">${dir}¬∞</div><div class="index-label">Texas Steer</div></div>
    <div class="index-card"><div class="index-value">${weightedSST.toFixed(1)}¬∞F</div><div class="index-label">Weighted SST</div></div>
  `;

  // Steering
  const lvls = [{n:'Low', d: dir}, {n:'Mid', d: (dir+6)%360}, {n:'High', d: (dir-4+360)%360}];
  document.getElementById('steering-grid').innerHTML = lvls.map(l => `
    <div class="index-card">
      <div class="index-value" style="color:${l.d >= 280 && l.d <= 320 ? '#f87171' : '#4ade80'}">${l.d.toFixed(0)}¬∞</div>
      <div class="index-label">${l.n} Layer</div>
    </div>
  `).join('');

  // Forecast
  document.getElementById('tsi-forecast-grid').innerHTML = atmos.daily.time.map((d, i) => `
    <div class="index-card">
      <div style="font-weight:bold; font-size:0.8rem;">${new Date(d + 'T00:00:00').toLocaleDateString('en-US', {weekday:'short'})}</div>
      <div class="index-value" style="font-size:1.3rem;">${atmos.daily.precipitation_probability_max[i]}%</div>
      <div class="index-label">Rain Prob</div>
    </div>
  `).join('');

  document.getElementById('temp-eval').innerText = weightedSST >= 82 ? "SUPPORTIVE of storm maintenance." : "TOO COOL for winter genesis.";
}

init();
</script>
</body>
</html>
