<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central TX Weather Dash</title>
    <style>
        :root { --danger: #d73a49; --bg: #f6f8fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #24292e; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; flex-shrink: 0; }
        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; overflow-y: auto; height: 50%; } body { overflow: auto; } }
        .panel { background: white; border: 1px solid #d1d5da; border-radius: 8px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .panel h2 { margin: 0 0 8px 0; font-size: 0.95rem; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .risk-card { padding: 8px; margin-top: 5px; border-radius: 4px; font-weight: bold; text-align: center; font-size: 0.8rem; border: 1px solid rgba(0,0,0,0.05); }
        .risk-NONE { background: #f0f0f0; color: #999; border-style: dashed; }
        .risk-MRGL { background: #c2e0c6; color: #1e4620; }
        .risk-SLGT { background: #fef2c0; color: #735c0f; }
        .active-alert { border-left: 4px solid var(--danger); padding: 6px; margin-bottom: 5px; background: #fff5f5; font-size: 0.8rem; font-weight: bold; }
        
        /* RADAR FILL FIX */
        .radar-panel { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .radar-box { flex-grow: 1; width: 100%; border-radius: 8px; overflow: hidden; position: relative; background: #000; }
        iframe { position: absolute; top:0; left:0; width:100%; height:100%; border:none; }
    </style>
</head>
<body>

    <h3 style="margin:5px 0 10px 0;">Central Texas Situation Room | <span id="timestamp" style="color:var(--danger)">Syncing...</span></h3>

    <div class="grid">
        <div class="panel">
            <h2>‚ö†Ô∏è Warnings</h2>
            <div id="nws-box">Checking...</div>
        </div>

        <div class="panel">
            <h2>üå™Ô∏è SPC Severe Risk</h2>
            <div id="spc-1" class="risk-card">Day 1: ...</div>
            <div id="spc-2" class="risk-card">Day 2: ...</div>
            <div id="spc-3" class="risk-card">Day 3: ...</div>
        </div>

        <div class="panel">
            <h2>üåßÔ∏è WPC Flood Risk</h2>
            <div id="wpc-1" class="risk-card">Day 1: ...</div>
            <div id="wpc-2" class="risk-card">Day 2: ...</div>
            <div id="wpc-3" class="risk-card">Day 3: ...</div>
        </div>
    </div>

    <div class="panel radar-panel">
        <div class="radar-box">
            <iframe src="https://embed.windy.com/embed2.html?lat=30.508&lon=-97.679&zoom=8&level=surface&overlay=radar&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1"></iframe>
        </div>
    </div>

    <script>
        const lat = 30.5083, lon = -97.6789;

        async function update() {
            document.getElementById('timestamp').innerText = new Date().toLocaleTimeString();
            
            // 1. NWS API
            try {
                const nRes = await fetch(`https://api.weather.gov/alerts/active?point=${lat},${lon}`);
                const nData = await nRes.json();
                document.getElementById('nws-box').innerHTML = nData.features?.length 
                    ? nData.features.map(f => `<div class="active-alert">${f.properties.event}</div>`).join('') 
                    : "<div style='color:#888; text-align:center;'>Clear</div>";
            } catch (e) {}

            // 2. Fetch SPC & WPC (Layers 1/9/17 and 0/1/2)
            fetchRisk("SPC", "outlooks/SPC_wx_outlks/MapServer/1", "spc-1");
            fetchRisk("SPC", "outlooks/SPC_wx_outlks/MapServer/9", "spc-2");
            fetchRisk("SPC", "outlooks/SPC_wx_outlks/MapServer/17", "spc-3");

            fetchRisk("WPC", "hazards/wpc_precip_hazards/MapServer/0", "wpc-1");
            fetchRisk("WPC", "hazards/wpc_precip_hazards/MapServer/1", "wpc-2");
            fetchRisk("WPC", "hazards/wpc_precip_hazards/MapServer/2", "wpc-3");
        }

        async function fetchRisk(type, path, elId) {
            const url = `https://mapservices.weather.noaa.gov/vector/rest/services/${path}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=*&f=pjson`;
            
            try {
                const r = await fetch(url);
                const d = await r.json();
                let risk = "NONE";

                if (d.features?.length > 0) {
                    const a = d.features[0].attributes;
                    // Scan all possible fields for a risk level
                    risk = a.LABEL || a.CATEGORY || a.TITLE || a.NAME || "NONE";
                }

                const clean = parseRisk(risk);
                const el = document.getElementById(elId);
                el.innerText = `Day ${elId.split('-')[1]}: ${clean}`;
                el.className = `risk-card risk-${clean}`;
            } catch (e) { console.error(e); }
        }

        function parseRisk(t) {
            t = t.toUpperCase();
            if (t.includes("MRGL") || t.includes("MARGINAL")) return "MRGL";
            if (t.includes("SLGT") || t.includes("SLIGHT")) return "SLGT";
            if (t.includes("ENH")) return "ENH";
            if (t.includes("TSTM") || t.includes("GEN")) return "TSTM";
            return "NONE";
        }

        update();
        setInterval(update, 600000); 
    </script>
</body>
</html>
