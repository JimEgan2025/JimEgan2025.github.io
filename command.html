<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTU Command Center v20.7</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { 
            --bg: #121212; --card: #1e1e24; --text: #e0e0e0; --accent: #00d2d3;
            --danger: #ff5252; --warning: #ff9f43; --safe: #2ecc71;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; overflow-x: hidden; }
        header { text-align: center; margin-bottom: 10px; }
        
        #alert-banner { background:#1e1e24; color:#aaa; text-align:center; padding:12px; font-weight:bold; margin: 5px auto; max-width:1200px; border-radius:5px; border: 1px solid #333; display:none; }

        .status-bar { display: flex; justify-content: center; gap: 20px; background: #2d3436; padding: 15px; border-radius: 8px; max-width: 900px; margin: 10px auto; border: 1px solid #444; flex-wrap: wrap; }
        .stat-item { text-align: center; min-width: 80px; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #fff; display: block; }
        .stat-label { font-size: 0.7rem; color: var(--accent); text-transform: uppercase; }

        nav { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { background: #2d3436; border: 1px solid #444; color: #aaa; padding: 8px 14px; cursor: pointer; font-weight: bold; border-radius: 4px; text-transform: uppercase; font-size: 0.75rem; }
        .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .card { background: var(--card); border-radius: 10px; padding: 15px; border: 1px solid #333; height: 380px; display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; height: auto; min-height: 400px; margin-bottom: 15px; }
        .card-header { border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; font-size: 1rem; font-weight: bold; color: #fff; }
        
        /* Fixed Chart Bug: Pointer-events must be auto for tooltips to work */
        .chart-wrapper { flex-grow: 1; position: relative; min-height: 0; width: 100%; pointer-events: auto; }
        canvas { width: 100% !important; height: 100% !important; }

        .wall-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .wall-panel { background: #000; border: 1px solid #444; border-radius: 8px; overflow: hidden; height: 500px; display: flex; flex-direction: column; }
        .wall-header { padding: 10px; font-size: 0.8rem; font-weight: bold; background: #2d3436; display: flex; justify-content: space-between; cursor: pointer; }
        
        iframe { width: 100%; height: 100%; border: none; }
        #map { height: 75vh; width: 100%; background: #111; border-radius: 8px; border: 1px solid #333; }
        .sat-img { width: 100%; height: 100%; object-fit: contain; background: #000; cursor: zoom-in; }
        
        /* Fullscreen Support */
        .wall-panel:fullscreen, .sat-img:fullscreen { background: #000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<header><h1>GTU COMMAND CENTER</h1></header>
<div id="alert-banner"></div>

<div class="status-bar">
    <div class="stat-item"><span class="stat-val" id="live-temp">--°</span><span class="stat-label">Temp</span></div>
    <div class="stat-item"><span class="stat-val" id="live-dew">--°</span><span class="stat-label">Dew</span></div>
    <div class="stat-item"><span class="stat-val" id="live-pressure">-- mb</span><span class="stat-label">Baro</span></div>
    <div class="stat-item"><span class="stat-val" id="live-wind">--</span><span class="stat-label">Wind</span></div>
</div>

<nav>
    <button class="tab-btn active" onclick="switchTab('tab-short', this)">Short Range</button>
    <button class="tab-btn" onclick="switchTab('tab-long', this)">Long Range</button>
    <button class="tab-btn" onclick="switchTab('tab-localradar', this)">Local Radar</button>
    <button class="tab-btn" onclick="switchTab('tab-radarwall', this)">TX Radar Wall</button>
    <button class="tab-btn" onclick="switchTab('tab-sat', this)">Sat Analysis</button>
</nav>

<div id="tab-short" class="tab-content active">
    <div class="container">
        <div class="card"><div class="card-header">Wind & Gusts</div><div class="chart-wrapper"><canvas id="windChart"></canvas></div></div>
        <div class="card"><div class="card-header">Temp & Dewpoint</div><div class="chart-wrapper"><canvas id="tempChart"></canvas></div></div>
        <div class="card"><div class="card-header">Rain Probability</div><div class="chart-wrapper"><canvas id="precipChart"></canvas></div></div>
        <div class="card"><div class="card-header">CAPE (Instability)</div><div class="chart-wrapper"><canvas id="capeChart"></canvas></div></div>
    </div>
</div>

<div id="tab-long" class="tab-content">
    <div class="container">
        <div class="card full-width"><div class="card-header">16-Day Temp Trend</div><div class="chart-wrapper"><canvas id="gfsTempChart"></canvas></div></div>
        <div class="card full-width"><div class="card-header">16-Day Rain (Accumulated)</div><div class="chart-wrapper"><canvas id="gfsRainChart"></canvas></div></div>
    </div>
</div>

<div id="tab-localradar" class="tab-content">
    <div class="full-width"><div id="map"></div></div>
</div>

<div id="tab-radarwall" class="tab-content"><div class="wall-grid" id="radar-wall-container"></div></div>

<div id="tab-sat" class="tab-content">
    <div class="wall-grid">
        <div class="wall-panel"><div class="wall-header" onclick="toggleExpand(this.nextElementSibling)">Visible</div><img id="sat-vis" class="sat-img" onclick="toggleExpand(this)"></div>
        <div class="wall-panel"><div class="wall-header" onclick="toggleExpand(this.nextElementSibling)">IR</div><img id="sat-ir" class="sat-img" onclick="toggleExpand(this)"></div>
        <div class="wall-panel"><div class="wall-header" onclick="toggleExpand(this.nextElementSibling)">Vapor</div><img id="sat-wv" class="sat-img" onclick="toggleExpand(this)"></div>
        <div class="wall-panel"><div class="wall-header" onclick="toggleExpand(this.nextElementSibling)">Lightning</div><img id="sat-lgt" class="sat-img" onclick="toggleExpand(this)"></div>
    </div>
</div>

<script>
    const LAT = 30.678, LON = -97.679;
    const TX_OFFICES = [
        {id:'kgrk', n:'Central TX'}, {id:'kewx', n:'Austin/SA'}, {id:'kfws', n:'Dallas/FW'},
        {id:'khgx', n:'Houston'}, {id:'kcrp', n:'Corpus Christi'}, {id:'kbro', n:'Brownsville'},
        {id:'ksjt', n:'San Angelo'}, {id:'kdyx', n:'Abilene'}, {id:'kmaf', n:'Midland'},
        {id:'klub', n:'Lubbock'}, {id:'kama', n:'Amarillo'}, {id:'kepz', n:'El Paso'}, {id:'kshv', n:'Shreveport'}
    ];

    let charts = {}, radarMap;

    // GLOBAL CHART SETTINGS FOR TOOLTIPS
    Chart.defaults.interaction.mode = 'index';
    Chart.defaults.interaction.intersect = false;
    Chart.defaults.plugins.tooltip.enabled = true;

    async function init() {
        await fetchLiveConditions(); 
        fetchHRRR(); 
        fetchGFS(); 
        refreshSat(); 
        initRadarWall();
        fetchAlerts();
        setInterval(fetchAlerts, 300000);
        setInterval(refreshSat, 600000);
    }

    function mkChart(id, type, labels, datasets) {
        if(charts[id]) charts[id].destroy();
        const ctx = document.getElementById(id).getContext('2d');
        charts[id] = new Chart(ctx, {
            type,
            data: { labels, datasets },
            options: { 
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#aaa', font: { size: 10 } } } },
                scales: { 
                    x: { ticks: { color: '#888', font: { size: 9 } }, grid: { color: '#333' } },
                    y: { ticks: { color: '#888', font: { size: 9 } }, grid: { color: '#333' } }
                }
            }
        });
    }

    async function fetchHRRR() {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,dewpoint_2m,precipitation_probability,wind_speed_10m,wind_gusts_10m,cape&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto&forecast_days=2`);
        const data = await res.json();
        const h = data.hourly;
        const labels = h.time.map(t => new Date(t).toLocaleTimeString([], {hour:'numeric'}));
        mkChart('windChart', 'line', labels, [{label:'Gusts', data:h.wind_gusts_10m, borderColor:'#f1c40f', pointRadius:0, tension:0.3}]);
        mkChart('tempChart', 'line', labels, [{label:'Temp', data:h.temperature_2m, borderColor:'#ff6b6b', pointRadius:0}, {label:'Dew', data:h.dewpoint_2m, borderColor:'#4ecdc4', pointRadius:0}]);
        mkChart('precipChart', 'bar', labels, [{label:'Rain %', data:h.precipitation_probability, backgroundColor:'rgba(52,152,219,0.5)'}]);
        mkChart('capeChart', 'bar', labels, [{label:'CAPE', data:h.cape, backgroundColor:'#2ecc71'}]);
    }

    async function fetchGFS() {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=auto&forecast_days=16&models=gfs_seamless`);
        const data = await res.json();
        const d = data.daily;
        mkChart('gfsTempChart', 'line', d.time, [{label:'Max', data:d.temperature_2m_max, borderColor:'#ff6b6b'}, {label:'Min', data:d.temperature_2m_min, borderColor:'#4ecdc4'}]);
        mkChart('gfsRainChart', 'bar', d.time, [{label:'Rain Total (in)', data:d.precipitation_sum, backgroundColor:'#3498db'}]);
    }

    function initRadarWall() {
        const container = document.getElementById('radar-wall-container');
        TX_OFFICES.forEach(o => {
            const div = document.createElement('div');
            div.className = 'wall-panel';
            div.innerHTML = `<div class="wall-header" onclick="toggleExpand(this.parentElement)">${o.n} <span>${o.id.toUpperCase()}</span></div>
                <iframe src="https://radar.weather.gov/station/${o.id}/standard" allowfullscreen loading="lazy"></iframe>`;
            container.appendChild(div);
        });
    }

    function initLocalRadar() {
        if(radarMap) return;
        radarMap = L.map('map').setView([LAT, LON], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(radarMap);
        
        // RainViewer API for Live Tile Overlay
        fetch("https://api.rainviewer.com/public/weather-maps.json")
            .then(res => res.json())
            .then(data => {
                const ts = data.radar.past[data.radar.past.length - 1].time;
                L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`, {
                    opacity: 0.6,
                    zIndex: 100
                }).addTo(radarMap);
            });
        
        L.circle([LAT, LON], {color: 'var(--accent)', radius: 2000}).addTo(radarMap).bindPopup("GTU");
    }

    function toggleExpand(el) {
        if (!document.fullscreenElement) el.requestFullscreen();
        else document.exitFullscreen();
    }
    
    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        if(id === 'tab-localradar') {
            setTimeout(initLocalRadar, 100); // Small delay ensures DOM is ready
        }
    }

    async function fetchAlerts() {
        try {
            const res = await fetch(`https://api.weather.gov/alerts/active?zone=TXZ173`);
            const data = await res.json();
            const banner = document.getElementById('alert-banner');
            if (data.features?.length > 0) {
                const a = data.features[0].properties;
                banner.style.display = "block";
                banner.innerText = `⚠️ ${a.event}: ${a.headline}`;
                banner.style.background = a.event.includes('Warning') ? "var(--danger)" : "var(--warning)";
                banner.style.color = "white";
            } else { banner.style.display = "none"; }
        } catch(e) {}
    }

    function refreshSat() {
        const t = Date.now();
        document.getElementById('sat-vis').src = `https://cdn.star.nesdis.noaa.gov/GOES19/ABI/SECTOR/sp/GEOCOLOR/latest.jpg?t=${t}`;
        document.getElementById('sat-ir').src = `https://cdn.star.nesdis.noaa.gov/GOES19/ABI/SECTOR/sp/13/latest.jpg?t=${t}`;
        document.getElementById('sat-wv').src = `https://cdn.star.nesdis.noaa.gov/GOES19/ABI/SECTOR/sp/08/latest.jpg?t=${t}`;
        document.getElementById('sat-lgt').src = `https://cdn.star.nesdis.noaa.gov/GOES19/GLM/SECTOR/sp/EXTENT3/latest.jpg?t=${t}`;
    }

    async function fetchLiveConditions() {
        try {
            const res = await fetch(`https://api.weather.gov/stations/KGTU/observations/latest`);
            const data = await res.json();
            const p = data.properties;
            document.getElementById('live-temp').innerText = Math.round(p.temperature.value * 1.8 + 32) + "°";
            document.getElementById('live-dew').innerText = Math.round(p.dewpoint.value * 1.8 + 32) + "°";
            document.getElementById('live-wind').innerText = `${Math.round(p.windSpeed.value * 0.62)} mph`;
            document.getElementById('live-pressure').innerText = Math.round(p.barometricPressure.value / 100) + " mb";
        } catch(e) {}
    }

    init();
</script>
</body>
</html>
</body>
</html>
