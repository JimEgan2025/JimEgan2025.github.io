<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Texas Weather Dashboard</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin:0; padding:20px; background:#f0f2f5; color:#1f2937; }
  .container { max-width:1200px; margin:0 auto; }
  header { background:#1e3a8a; color:#fff; padding:1rem 1.5rem; border-radius:12px; margin-bottom:2rem; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
  header h1 { margin:0; font-size:1.8rem; }
  .tabs { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
  .tab { padding:0.5rem 1rem; border-radius:6px; background:#e5e7eb; cursor:pointer; transition: all 0.2s; }
  .tab.active { background:#1e3a8a; color:#fff; }
  .tab:hover { background:#cbd5e1; }
  .content { display:none; }
  .content.active { display:block; }
  .card { background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:1.5rem; }
  .story-box { border-left:8px solid #1e3a8a; background:#f8fafc; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem; }
  .story-box h3 { margin-top:0; color:#1e3a8a; }
  .story-list { padding-left:20px; line-height:1.8; font-size:1.1rem; margin:0; }
  .alerts-box { background:#fef3f2; border-left:4px solid #ef4444; padding:1rem; border-radius:0 4px 4px 0; margin:1rem 0; }
  .alerts-box ul { margin:0.5rem 0; padding-left:1.2rem; }
  .alerts-box li { margin-bottom:0.6rem; line-height:1.5; }
  .no-alerts { color:#6b7280; font-style:italic; padding:1rem; background:#f8f9fa; border-radius:6px; }
  .narrative-lead-box { background:#fffbeb; border:2px solid #f59e0b; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem; line-height:1.7; font-size:1.1rem; color:#1f2937; }
  .region-group { margin-bottom:1rem; }
  .region-group strong { color:#1e3a8a; display:block; margin-bottom:0.4rem; font-size:1.05rem; }
  .key-msg-box { background:#f8fafc; border-left:4px solid #3b82f6; padding:1.25rem; margin-bottom:1rem; border-radius:0 4px 4px 0; line-height:1.65; }
  .error-msg { color:#dc2626; font-weight:bold; padding:1rem; background:#fee2e2; border-radius:8px; margin:1rem 0; }
  .timestamp { font-size:0.9rem; color:#6b7280; margin-top:0.75rem; display:block; }
  .refresh-btn { padding:0.5rem 1rem; background:#1e3a8a; color:white; border:none; border-radius:6px; cursor:pointer; margin-bottom:1rem; }
  .refresh-btn:hover { background:#1e40af; }
  .loading { color:#6b7280; font-style:italic; }
  .forecast-item { border-bottom:1px solid #f3f4f6; padding:0.75rem 0; }
  .forecast-header { display:flex; justify-content:space-between; font-weight:bold; font-size:1.1rem; }
  img.weather-layer { width:100%; border-radius:8px; display:block; margin-top:10px; }
  @media (max-width: 768px) { .tabs { justify-content:center; } }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Texas Weather Dashboard</h1>
    <p style="margin:0.5rem 0 0; font-size:0.95rem;">Real-time NWS data • Key messages + smart alerts</p>
  </header>

  <div class="tabs" id="tabsContainer"></div>
  <button class="refresh-btn" id="refreshBtn" style="display:none;">Refresh Current Tab</button>
  <div id="contentContainer"></div>
</div>

<script>
const CITIES = [
  { name:'Texas Summary', code:'TX', type:'summary' },
  { name:'Austin/San Antonio', code:'EWX', lat:30.2672, lon:-97.7431, radar:'KEWX', type:'city' },
  { name:'Houston', code:'HGX', lat:29.7604, lon:-95.3698, radar:'KHGX', type:'city' },
  { name:'Dallas/Fort Worth', code:'FWD', lat:32.7767, lon:-96.7970, radar:'KFWS', type:'city' },
  { name:'El Paso', code:'EPZ', lat:31.7619, lon:-106.4850, radar:'KEPZ', type:'city' },
  { name:'Amarillo', code:'AMA', lat:35.2210, lon:-101.8313, radar:'KAMA', type:'city' },
  { name:'Brownsville', code:'BRO', lat:25.9017, lon:-97.4975, radar:'KBRO', type:'city' },
  { name:'Corpus Christi', code:'CRP', lat:27.8006, lon:-97.3964, radar:'KCRP', type:'city' },
  { name:'San Angelo', code:'SJT', lat:31.4638, lon:-100.4370, radar:'KSJT', type:'city' },
  { name:'Beaumont', code:'LCH', lat:30.0802, lon:-94.1266, radar:'KLCH', type:'city' },
  { name:'Lubbock', code:'LUB', lat:33.5779, lon:-101.8552, radar:'KLBB', type:'city' },
  { name:'Midland', code:'MAF', lat:31.9974, lon:-102.0779, radar:'KMAF', type:'city' },
  { name:'Texarkana', code:'SHV', lat:33.4251, lon:-94.0477, radar:'KSHV', type:'city' }
];

const HEADERS = {
  'User-Agent': 'TexasWeatherDashboard/1.3 (personal; Jim.egan@gmail.com)',
  'Accept': 'application/geo+json, application/ld+json'
};

const REGION_GROUPS = [
  { name: 'North Texas', offices: ['Dallas/Fort Worth'] },
  { name: 'Panhandle & Northwest', offices: ['Amarillo', 'Lubbock'] },
  { name: 'West Texas', offices: ['El Paso', 'Midland'] },
  { name: 'Central / South Central', offices: ['Austin/San Antonio', 'San Angelo'] },
  { name: 'Coastal / Southeast', offices: ['Houston', 'Beaumont'] },
  { name: 'South Texas', offices: ['Brownsville', 'Corpus Christi'] },
  { name: 'Northeast / East Texas', offices: ['Texarkana'] }
];

let currentTabIndex = 0;

function init() {
  const tabs = document.getElementById('tabsContainer');
  const content = document.getElementById('contentContainer');

  CITIES.forEach((city, i) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (i === 0 ? ' active' : '');
    tab.textContent = city.name;
    tab.onclick = () => switchTab(i);
    tabs.appendChild(tab);

    const cont = document.createElement('div');
    cont.className = 'content' + (i === 0 ? ' active' : '');
    cont.id = 'content-' + i;
    content.appendChild(cont);
  });

  document.getElementById('refreshBtn').onclick = () => loadCityDataAsync(CITIES[currentTabIndex], currentTabIndex);
  CITIES.forEach((city, i) => loadCityDataAsync(city, i));
}

function switchTab(idx) {
  currentTabIndex = idx;
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
  document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
  document.getElementById('refreshBtn').style.display = idx === 0 ? 'none' : 'inline-block';
}

/* ==================== TEXAS SUMMARY ==================== */
async function loadTexasSummary(container) {
  container.innerHTML = `
    <h2>Texas Statewide Summary</h2>
    <div id="story-box" class="story-box loading">Compiling current weather story...</div>
    <div id="state-narrative-box" class="narrative-lead-box">Gathering key messages from NWS offices...</div>
    <div class="card"><h3>Satellite (GOES-16 GEOCOLOR)</h3><img class="weather-layer" src="https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/sp/GEOCOLOR/latest.jpg" alt="GOES-16 Satellite"></div>
    <div class="card"><h3>Radar Loop</h3><img class="weather-layer" src="https://cdn.tegna-media.com/wfaa/weather/animated-loops/comp/temp_880x495/state_tx_anim.gif" alt="Texas Radar Loop"></div>
  `;

  let officeMsgs = {};
  await Promise.allSettled(CITIES.slice(1).map(async city => {
    try {
      const res = await fetch(`https://api.weather.gov/products/types/AFD/locations/${city.code}/latest`, { headers: HEADERS });
      if (!res.ok) return;
      const data = await res.json();
      const msg = extractKeyMessages(data.productText);
      if (msg) officeMsgs[city.name] = msg;
    } catch (e) {}
  }));

  // Dynamic Weather Story
  const storyBox = document.getElementById('story-box');
  let storyHTML = '<h3>Current Texas Weather Story</h3><ul class="story-list">';
  let themes = { warm:0, humid:0, thunderstorm:0, severe:0, hail:0, wind:0, rainLow:0, fire:0, clearing:0 };
  let stormTiming = '', stormAreas = '';

  Object.entries(officeMsgs).forEach(([_, msg]) => {
    const lower = msg.toLowerCase();
    if (lower.includes('warm') || lower.includes('above normal')) themes.warm++;
    if (lower.includes('humid') || lower.includes('moisture') || lower.includes('fog')) themes.humid++;
    if (lower.includes('thunderstorm') || lower.includes('shower')) {
      themes.thunderstorm++;
      if (lower.includes('afternoon') || lower.includes('evening')) stormTiming = 'afternoon through evening';
      if (lower.includes('central') || lower.includes('south') || lower.includes('east')) stormAreas = 'Central, South-Central, and Eastern Texas';
    }
    if (lower.includes('severe') || lower.includes('marginal')) themes.severe++;
    if (lower.includes('hail')) themes.hail++;
    if (lower.includes('wind') || lower.includes('gust')) themes.wind++;
    if (lower.includes('low side') || lower.includes('less than')) themes.rainLow++;
    if (lower.includes('fire weather') || lower.includes('critical')) themes.fire++;
    if (lower.includes('clear') || lower.includes('breezy') || lower.includes('sunday')) themes.clearing++;
  });

  if (themes.warm > 1 || themes.humid > 1) storyHTML += `<li><strong>Warm & Humid Conditions:</strong> Well above-average temperatures (70s to mid-80s) and Gulf moisture persist across much of Texas.</li>`;
  if (themes.thunderstorm > 2 || themes.severe > 1) {
    let detail = 'Scattered to widespread showers and thunderstorms expected';
    if (stormTiming) detail += ` ${stormTiming}`;
    if (stormAreas) detail += ` across ${stormAreas}`;
    if (themes.severe > 1) detail += `; Marginal risk for severe weather (large hail, damaging winds possible)`;
    storyHTML += `<li><strong>Thunderstorm Threat:</strong> ${detail}.</li>`;
  }
  if (themes.rainLow > 1) storyHTML += `<li><strong>Rainfall:</strong> Amounts generally on the low side (mostly under 1 inch).</li>`;
  if (themes.fire > 1 || themes.clearing > 1) storyHTML += `<li><strong>Aftermath & Fire Weather:</strong> Storms taper overnight; Sunday brings clearing skies but breezy winds and elevated fire weather risks.</li>`;

  if (storyHTML === '<h3>Current Texas Weather Story</h3><ul class="story-list">') storyHTML += '<li><strong>General Conditions:</strong> Mild to warm weather across Texas with scattered showers possible.</li>';
  storyHTML += '</ul><p style="font-size:0.9rem; color:#6b7280; margin-top:0.8rem;">Synthesized from regional NWS key messages (as of ' + new Date().toLocaleTimeString() + ' CST).</p>';
  storyBox.innerHTML = storyHTML;
  storyBox.classList.remove('loading');

  // Consolidated key messages by region (restored)
  const narrativeBox = document.getElementById('state-narrative-box');
  let html = '<h3>Key Forecaster Messages Across Texas</h3>';
  REGION_GROUPS.forEach(group => {
    const msgs = group.offices.filter(o => officeMsgs[o]).map(o => `${o}: ${officeMsgs[o]}`);
    if (msgs.length) html += `<div class="region-group"><strong>${group.name}:</strong> ${msgs.join(' • ')}</div>`;
  });
  if (Object.keys(officeMsgs).length === 0) html += '<p class="error-msg">No key messages available right now. Try refreshing.</p>';
  else html += '<p style="font-size:0.9rem; color:#6b7280; margin-top:1rem;">Main impacts and hazards from each NWS office (grouped by region).</p>';
  narrativeBox.innerHTML = html;
}

function extractKeyMessages(text) {
  if (!text) return "";
  const match = text.match(/\.KEY\s*(MESSAGES|POINTS|SUMMARY|TAKEAWAYS)\.\.\.([\s\S]*?)(?=\.[A-Z0-9\s\/]+\.\.\.|&&)/i);
  if (!match) return "";
  return match[2].trim()
    .replace(/^- /gm, '')
    .replace(/\n\s*\n/g, ' ')
    .replace(/\n/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

/* ==================== CITY / OFFICE TABS ==================== */
async function loadCityDataAsync(city, idx) {
  const container = document.getElementById(`content-${idx}`);
  if (city.type === 'summary') {
    await loadTexasSummary(container);
    return;
  }

  container.innerHTML = `
    <div class="card">
      <h2>${city.name} Key Impacts Summary</h2>
      <div id="narrative-${idx}" class="key-msg-box loading">Loading key messages...</div>
    </div>
    <div class="card">
      <h2>Active Alerts for ${city.name} Area</h2>
      <div id="alerts-${idx}" class="alerts-box loading">Loading alerts...</div>
    </div>
    <div class="card">
      <h2>Current Conditions</h2>
      <div id="obs-${idx}" class="loading">Loading...</div>
    </div>
    <div class="card">
      <h2>7-Day Forecast (First 6 Periods)</h2>
      <div id="fc-${idx}" class="loading">Loading...</div>
    </div>
    <div class="card">
      <h2>Radar Loop (${city.radar})</h2>
      <img class="weather-layer" src="https://radar.weather.gov/ridge/standard/${city.radar}_loop.gif" alt="${city.name} Radar Loop">
    </div>
  `;

  try {
    const ptsRes = await fetch(`https://api.weather.gov/points/${city.lat},${city.lon}`, { headers: HEADERS });
    if (!ptsRes.ok) throw new Error('Point fetch failed');
    const pts = await ptsRes.json();

    // Forecast
    const fcRes = await fetch(pts.properties.forecast, { headers: HEADERS });
    const forecast = await fcRes.json();
    document.getElementById(`fc-${idx}`).innerHTML = forecast.properties.periods.slice(0, 6).map(p => `
      <div class="forecast-item">
        <div class="forecast-header"><span>${p.name}</span><span>${p.temperature}°${p.temperatureUnit}</span></div>
        <div>${p.shortForecast} — ${p.detailedForecast}</div>
        <small class="timestamp">Valid: ${new Date(p.startTime).toLocaleString([], {hour:'numeric', minute:'2-digit', weekday:'short'})}</small>
      </div>
    `).join('');

    // Observations
    const stnsRes = await fetch(pts.properties.observationStations, { headers: HEADERS });
    const stns = await stnsRes.json();
    if (stns.features.length > 0) {
      const obsRes = await fetch(`${stns.features[0].id}/observations/latest`, { headers: HEADERS });
      const obs = await obsRes.json();
      const p = obs.properties;
      const tempF = p.temperature?.value ? Math.round(p.temperature.value * 9/5 + 32) : '--';
      const feelF = p.heatIndex?.value ? Math.round(p.heatIndex.value * 9/5 + 32) : (p.windChill?.value ? Math.round(p.windChill.value * 9/5 + 32) : tempF);
      document.getElementById(`obs-${idx}`).innerHTML = `
        <b>${p.textDescription || 'Conditions N/A'}</b><br>
        Temp: ${tempF}°F (Feels like: ${feelF}°F)<br>
        Humidity: ${Math.round(p.relativeHumidity?.value || 0)}%<br>
        Wind: ${p.windSpeed?.value || '--'} mph ${p.windDirection?.value ? `from ${p.windDirection.value}°` : ''}<br>
        <small class="timestamp">Observed: ${new Date(p.timestamp).toLocaleString()}</small>
      `;
    }

    // AFD Key Messages
    const afdRes = await fetch(`https://api.weather.gov/products/types/AFD/locations/${city.code}/latest`, { headers: HEADERS });
    const afd = await afdRes.json();
    const keyMsg = extractKeyMessages(afd.productText);
    const narrativeBox = document.getElementById(`narrative-${idx}`);
    narrativeBox.innerHTML = keyMsg || 'No key messages section available in latest AFD.';
    narrativeBox.classList.remove('loading');
    narrativeBox.insertAdjacentHTML('beforeend', `<div class="timestamp">From AFD issued: ${new Date(afd.issuanceTime).toLocaleString()}</div>`);

    // Smart Alerts: Point first → Zone fallback
    const alertsBox = document.getElementById(`alerts-${idx}`);
    try {
      let features = [];

      // 1. Point query
      let res = await fetch(`https://api.weather.gov/alerts/active?point=${city.lat},${city.lon}`, { headers: HEADERS });
      if (res.ok) {
        const data = await res.json();
        features = data.features || [];
      }

      // 2. Fallback to forecast zone if nothing at point
      if (features.length === 0 && pts.properties.forecastZone) {
        const zoneID = pts.properties.forecastZone.split('/').pop();
        res = await fetch(`https://api.weather.gov/alerts/active?zone=${zoneID}`, { headers: HEADERS });
        if (res.ok) {
          const data = await res.json();
          features = data.features || [];
        }
      }

      if (features.length === 0) {
        alertsBox.innerHTML = '<div class="no-alerts">No active watches, warnings, or advisories affecting this area right now.</div>';
      } else {
        let html = '<ul>';
        features.forEach(f => {
          const p = f.properties;
          const expires = new Date(p.expires).toLocaleString([], {dateStyle:'short', timeStyle:'short'});
          html += `
            <li>
              <strong>${p.event}</strong> (${p.severity}) – ${p.areaDesc ? p.areaDesc.replace(/;/g, ', ') : 'Affected area'}<br>
              <em>${p.headline}</em><br>
              Urgency: ${p.urgency} | Expires: ${expires}
            </li>
          `;
        });
        html += '</ul><div class="timestamp">Alerts last updated: ' + new Date().toLocaleTimeString() + '</div>';
        alertsBox.innerHTML = html;
      }
    } catch (e) {
      alertsBox.innerHTML = `<p class="error-msg">Unable to load alerts right now.</p>`;
    }

  } catch (e) {
    console.error(e);
    container.innerHTML += `<p class="error-msg">Error loading data: ${e.message}. Try refreshing.</p>`;
  }
}

init();
</script>
</body>
</html>
