<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Texas Weather Dashboard</title>
<style>
  :root { --primary: #1e3a8a; --bg: #f0f2f5; --card: #ffffff; --text: #1f2937; --accent: #f59e0b; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; margin:0; padding:10px; background: var(--bg); color: var(--text); }
  .container { max-width:1200px; margin:0 auto; }
  
  header { background: var(--primary); color:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
  header h1 { margin:0; font-size:1.6rem; }
  
  .tabs { display:flex; overflow-x: auto; gap:10px; margin-bottom:15px; padding-bottom: 5px; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab { padding:10px 18px; border-radius:25px; background:#e5e7eb; cursor:pointer; transition: 0.2s; white-space: nowrap; font-weight: 600; font-size: 0.9rem; border: 1px solid transparent; }
  .tab.active { background: var(--primary); color:#fff; border-color: #fff; }

  .content { display:none; }
  .content.active { display:block; animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  .card { background: var(--card); padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:20px; }
  
  .story-box { border-left:10px solid var(--primary); background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px; }
  .story-box h3 { margin:0 0 10px 0; color: var(--primary); }
  .story-list { list-style: none; padding: 0; margin: 0; }
  .story-list li { margin-bottom:12px; line-height:1.6; font-size:1.05rem; display: flex; }
  .story-list li::before { content: "â–¶"; color: var(--primary); font-size: 0.8rem; margin-right: 12px; margin-top: 4px; }

  .narrative-lead-box { background:#fffbeb; border:2px solid var(--accent); padding:15px; border-radius:12px; margin-bottom:15px; line-height:1.6; font-size:0.95rem; white-space: pre-wrap; }
  .region-group { margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .region-group strong { color: var(--primary); font-size:1.1rem; display: block; margin-bottom: 5px; }

  .alerts-box { background:#fef3f2; border-left:5px solid #ef4444; padding:15px; border-radius:8px; margin:10px 0; font-size: 0.9rem; }
  .forecast-item { border-bottom:1px solid #f3f4f6; padding:12px 0; }
  .forecast-header { display:flex; justify-content:space-between; font-weight:bold; color: var(--primary); }
  
  img.weather-layer { width:100%; border-radius:8px; display:block; margin-top:10px; background: #000; min-height: 250px; }
  .refresh-btn { padding:10px 20px; background: var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; margin-bottom:20px; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Texas State Weather Dashboard</h1>
    <div id="currentTime" style="font-size: 0.85rem; opacity: 0.8;"></div>
  </header>

  <div class="tabs" id="tabsContainer"></div>
  <button class="refresh-btn" id="refreshBtn" style="display:none;">Refresh Current Data</button>
  
  <div id="contentContainer"></div>
</div>

<script>
const CITIES = [
  { name:'Texas Summary', code:'TX', type:'summary' },
  { name:'Austin/SAT', code:'EWX', lat:30.2672, lon:-97.7431, radar:'KEWX' },
  { name:'Houston', code:'HGX', lat:29.7604, lon:-95.3698, radar:'KHGX' },
  { name:'Dallas/FW', code:'FWD', lat:32.7767, lon:-96.7970, radar:'KFWS' },
  { name:'Amarillo', code:'AMA', lat:35.2210, lon:-101.8313, radar:'KAMA' },
  { name:'El Paso', code:'EPZ', lat:31.7619, lon:-106.4850, radar:'KEPZ' },
  { name:'Brownsville', code:'BRO', lat:25.9017, lon:-97.4975, radar:'KBRO' },
  { name:'Corpus Christi', code:'CRP', lat:27.8006, lon:-97.3964, radar:'KCRP' },
  { name:'San Angelo', code:'SJT', lat:31.4638, lon:-100.4370, radar:'KSJT' },
  { name:'Lubbock', code:'LUB', lat:33.5779, lon:-101.8552, radar:'KLBB' },
  { name:'Midland', code:'MAF', lat:31.9974, lon:-102.0779, radar:'KMAF' }
];

const HEADERS = { 'User-Agent': 'JimEganWxDash/4.0 (jim.egan@gmail.com)' };

const REGIONS = [
  { name: 'North / Panhandle', offices: ['Dallas/FW', 'Amarillo', 'Lubbock'] },
  { name: 'Central / West', offices: ['Austin/SAT', 'San Angelo', 'El Paso', 'Midland'] },
  { name: 'Gulf Coast / South', offices: ['Houston', 'Brownsville', 'Corpus Christi'] }
];

let currentTabIndex = 0;

function init() {
  const tabs = document.getElementById('tabsContainer');
  const content = document.getElementById('contentContainer');
  
  CITIES.forEach((city, i) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (i === 0 ? ' active' : '');
    tab.textContent = city.name;
    tab.onclick = () => switchTab(i);
    tabs.appendChild(tab);

    const cont = document.createElement('div');
    cont.className = 'content' + (i === 0 ? ' active' : '');
    cont.id = 'content-' + i;
    content.appendChild(cont);
    
    loadTabData(i);
  });

  document.getElementById('currentTime').textContent = "Updated: " + new Date().toLocaleString();
  document.getElementById('refreshBtn').onclick = () => loadTabData(currentTabIndex);
}

function switchTab(idx) {
  currentTabIndex = idx;
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
  document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
  document.getElementById('refreshBtn').style.display = idx === 0 ? 'none' : 'inline-block';
}

function extractKeyMessages(text) {
    if (!text) return "";
    let regex = /(?:\.|\s|^)KEY\s+MESSAGES[\.\s:]+([\s\S]*?)(?=\n\.[A-Z]|\n&&|\nSYNOPSIS|\nSHORT TERM|$)/i;
    let match = text.match(regex);
    if (!match) {
        regex = /(?:\.|\s|^)SYNOPSIS[\.\s:]+([\s\S]*?)(?=\n\.[A-Z]|\n&&|\nNEAR TERM|$)/i;
        match = text.match(regex);
    }
    if (!match) return "";
    return match[1].trim().replace(/^\s*-\s*/gm, 'â€¢ ').split('\n').filter(line => line.trim().length > 10).slice(0, 5).join('\n');
}

async function loadTabData(idx) {
  const city = CITIES[idx];
  const container = document.getElementById(`content-${idx}`);
  if (city.type === 'summary') { renderSummary(container); } 
  else { renderCity(city, container, idx); }
}

async function renderSummary(container) {
  container.innerHTML = `<div style="text-align:center; padding:40px;">ðŸ“¡ Analyzing Texas regional data...</div>`;
  let officeMsgs = {};
  const promises = CITIES.slice(1).map(async (office) => {
    try {
      const res = await fetch(`https://api.weather.gov/products/types/AFD/locations/${office.code}/latest`, { headers: HEADERS });
      const data = await res.json();
      const extracted = extractKeyMessages(data.productText);
      if (extracted) officeMsgs[office.name] = extracted;
    } catch (e) { console.warn(`Office ${office.name} down`); }
  });
  await Promise.allSettled(promises);

  const allText = Object.values(officeMsgs).join(' ').toLowerCase();
  const storyPoints = [];
  if (allText.includes('severe') || allText.includes('tornado') || allText.includes('hail')) storyPoints.push("<strong>Storm Watch:</strong> Regional offices are monitoring severe thunderstorm potential.");
  if (allText.includes('fire') || allText.includes('red flag')) storyPoints.push("<strong>Fire Weather:</strong> High fire danger in dry/windy sectors.");
  if (allText.includes('warm') || allText.includes('above normal')) storyPoints.push("<strong>Warming:</strong> Trend toward above-average temperatures expected.");
  if (storyPoints.length === 0) storyPoints.push("<strong>Quiet Pattern:</strong> State-wide weather remains seasonal and generally stable.");

  let regionHTML = `<div class="card"><h3>Regional Highlights</h3>`;
  REGIONS.forEach(reg => {
    const activeOffices = reg.offices.filter(o => officeMsgs[o]);
    if (activeOffices.length > 0) {
      regionHTML += `<div class="region-group"><strong>${reg.name}</strong>`;
      activeOffices.forEach(o => { regionHTML += `<div class="narrative-lead-box"><b>${o}:</b><br>${officeMsgs[o]}</div>`; });
      regionHTML += `</div>`;
    }
  });

  container.innerHTML = `
    <div class="story-box"><h3>Weather Story</h3><ul class="story-list">${storyPoints.map(p => `<li>${p}</li>`).join('')}</ul></div>
    
    <div class="card">
        <h3>Statewide Radar Loop</h3>
        <img class="weather-layer" src="https://cdn.tegna-media.com/wfaa/weather/animated-loops/comp/temp_880x495/state_tx_anim.gif" referrerpolicy="no-referrer">
    </div>

    <div class="card">
        <h3>Texas Sector Satellite (GEOCOLOR)</h3>
        <img class="weather-layer" src="https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/sp/GEOCOLOR/latest.jpg" referrerpolicy="no-referrer">
    </div>

    ${regionHTML}
  `;
}

async function renderCity(city, container, idx) {
  container.innerHTML = `<div style="text-align:center; padding:40px;">Fetching ${city.name} impacts...</div>`;
  try {
    const ptsRes = await fetch(`https://api.weather.gov/points/${city.lat},${city.lon}`, { headers: HEADERS });
    const pts = await ptsRes.json();
    const [fcRes, afdRes, alertRes] = await Promise.all([
        fetch(pts.properties.forecast, { headers: HEADERS }),
        fetch(`https://api.weather.gov/products/types/AFD/locations/${city.code}/latest`, { headers: HEADERS }),
        fetch(`https://api.weather.gov/alerts/active?point=${city.lat},${city.lon}`, { headers: HEADERS })
    ]);
    const fc = await fcRes.json();
    const afd = await afdRes.json();
    const alerts = await alertRes.json();
    const keyMsgs = extractKeyMessages(afd.productText);
    const alertHTML = alerts.features.length > 0 ? alerts.features.map(f => `<div class="alerts-box"><strong>${f.properties.event}</strong><br>${f.properties.headline}</div>`).join('') : '<div style="color:#666; padding:10px;">No active alerts.</div>';

    container.innerHTML = `
      <div class="card"><h3>Local Impacts</h3>${alertHTML}<div class="narrative-lead-box" style="margin-top:15px;">${keyMsgs || "Summary unavailable."}</div></div>
      <div class="card"><h3>Radar Loop (${city.radar})</h3>
        <img class="weather-layer" src="https://radar.weather.gov/ridge/standard/${city.radar}_loop.gif" referrerpolicy="no-referrer">
      </div>
      <div class="card"><h3>7-Day Outlook</h3>
        ${fc.properties.periods.slice(0, 6).map(p => `<div class="forecast-item"><div class="forecast-header"><span>${p.name}</span><span>${p.temperature}Â°${p.temperatureUnit}</span></div><div style="font-size:0.9rem;">${p.detailedForecast}</div></div>`).join('')}
      </div>
    `;
  } catch (e) { container.innerHTML = `<div class="card" style="color:red;">Error loading data.</div>`; }
}
init();
</script>
</body>
</html>
