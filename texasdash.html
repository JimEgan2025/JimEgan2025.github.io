<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Texas Weather Dashboard</title>
<style>
body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:0; padding:20px; background:#f0f2f5; color:#1f2937;}
.container { max-width:1200px; margin:0 auto;}
header { background:#1e3a8a; color:#fff; padding:1rem 1.5rem; border-radius:12px; margin-bottom:2rem; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);}
header h1 { margin:0; font-size:1.8rem;}
.tabs { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem;}
.tab { padding:0.5rem 1rem; border-radius:6px; background:#e5e7eb; cursor:pointer;}
.tab.active { background:#1e3a8a; color:#fff;}
.content { display:none; }
.content.active { display:block; }
.card { background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:1rem;}

/* Weather Story Highlight Box */
.story-box { border-left: 8px solid #1e3a8a; background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; }
.story-box h3 { margin-top: 0; color: #1e3a8a; }
.story-list { padding-left: 20px; line-height: 1.8; font-size: 1.1rem; margin: 0; }

/* Alert & Narrative Styling */
.hazard-map-container { text-align: center; }
.hazard-map-container img { width: 100%; max-width: 900px; border-radius: 8px; border: 1px solid #d1d5db; }
.narrative-lead-box { background:#fffbeb; border:2px solid #f59e0b; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem; line-height:1.7; font-size:1.1rem; color:#1f2937;}
.afd-summary-box { background:#f8fafc; border-left:4px solid #3b82f6; padding:1rem; margin-bottom:0.5rem; border-radius:0 4px 4px 0; line-height: 1.6;}
.forecast-item { border-bottom:1px solid #f3f4f6; padding:0.5rem 0; }
.forecast-header { display:flex; justify-content:space-between; font-weight: bold;}
img.weather-layer { width:100%; border-radius:8px; display: block; margin-top:10px;}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Texas Weather Dashboard</h1>
  </header>
  <div class="tabs" id="tabsContainer"></div>
  <div id="contentContainer"></div>
</div>

<script>
const CITIES = [
  { name:'Texas Summary', code:'TX', type:'summary' },
  { name:'Austin/San Antonio', code:'EWX', lat:30.2672, lon:-97.7431, radar:'KEWX', type:'city' },
  { name:'Houston', code:'HGX', lat:29.7604, lon:-95.3698, radar:'KHGX', type:'city' },
  { name:'Dallas/Fort Worth', code:'FWD', lat:32.7767, lon:-96.7970, radar:'KFWS', type:'city' },
  { name:'El Paso', code:'EPZ', lat:31.7619, lon:-106.4850, radar:'KEPZ', type:'city' },
  { name:'Amarillo', code:'AMA', lat:35.2210, lon:-101.8313, radar:'KAMA', type:'city' },
  { name:'Brownsville', code:'BRO', lat:25.9017, lon:-97.4975, radar:'KBRO', type:'city' },
  { name:'Corpus Christi', code:'CRP', lat:27.8006, lon:-97.3964, radar:'KCRP', type:'city' },
  { name:'San Angelo', code:'SJT', lat:31.4638, lon:-100.4370, radar:'KSJT', type:'city' },
  { name:'Beaumont', code:'LCH', lat:30.0802, lon:-94.1266, radar:'KLCH', type:'city' },
  { name:'Lubbock', code:'LUB', lat:33.5779, lon:-101.8552, radar:'KLBB', type:'city' },
  { name:'Midland', code:'MAF', lat:31.9974, lon:-102.0779, radar:'KMAF', type:'city' },
  { name:'Texarkana', code:'SHV', lat:33.4251, lon:-94.0477, radar:'KSHV', type:'city' }
];

const HEADERS = {'User-Agent':'TexasWeatherDash/1.1 (Jim.egan@gmail.com)','Accept':'application/geo+json'};

function init() {
  const tabs = document.getElementById('tabsContainer');
  const content = document.getElementById('contentContainer');
  CITIES.forEach((city,i)=>{
    const tab = document.createElement('div'); 
    tab.className='tab'+(i===0?' active':''); 
    tab.textContent=city.name;
    tab.onclick = () => switchTab(i);
    tabs.appendChild(tab);
    const cont = document.createElement('div'); 
    cont.className='content'+(i===0?' active':''); 
    cont.id='content-'+i; 
    content.appendChild(cont);
  });
  CITIES.forEach((city,i)=>loadCityDataAsync(city,i));
}

function switchTab(idx){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i==idx));
  document.querySelectorAll('.content').forEach((c,i)=>c.classList.toggle('active',i==idx));
}

function parseAFDNarrative(text){
  if (!text) return "";
  let lines = [];
  const section = text.match(/\.(?:KEY MESSAGES|SYNOPSIS)\.\.\.([\s\S]*?)(?=\.\w+|\n\n&&)/i);
  if (section) {
    lines = section[1].split('\n').map(l => l.trim()).filter(l => l.length > 5).map(l => l.replace(/^(Updated|Issued)\s+at.*$/i, '').trim()).filter(l => l.length > 0);
  } else {
    const disc = text.match(/\.DISCUSSION\.\.\.([\s\S]*?)(?=\n\n&&)/i);
    if (disc) lines = disc[1].split('\n').map(l => l.trim()).filter(l => l.length > 20).slice(0, 2);
  }
  return lines.length ? lines.join(' ') : "";
}

async function loadTexasSummary(container){
  container.innerHTML = `
    <h2>Texas Statewide Summary</h2>
    <div class="story-box">
      <h3>The Weather Story: Feb 12-14, 2026</h3>
      <ul class="story-list">
        <li><strong>The Warm-Up:</strong> Record warmth (upper 70s to low 80s) and thick sea fog persist through Friday morning.</li>
        <li><strong>The Storm (Sat):</strong> A Pacific front brings widespread storms and a Level 1 severe risk for Valentine's Day.</li>
        <li><strong>The Aftermath:</strong> Conditions clear Sunday, but breezy winds will increase fire weather concerns into next week.</li>
      </ul>
    </div>
    
    <div class="card hazard-map-container">
      <h3>Active Texas Hazards (Watches & Warnings)</h3>
      <img src="https://radar.weather.gov/ridge/standard/CONUS-COUNTY-HAZARDS_0.gif" alt="Texas Hazards Map">
      <p style="font-size: 0.85rem; color: #6b7280; margin-top: 10px;">Colors represent active NWS alerts: Red (Warning), Yellow (Watch), Tan (Advisory).</p>
    </div>

    <div id="state-narrative-box" class="narrative-lead-box">Gathering regional briefings...</div>

    <div class="card"><h3>Satellite (IR/WV)</h3><img class="weather-layer" src="https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/sp/GEOCOLOR/latest.jpg"></div>
    <div class="card"><h3>Radar Loop</h3><img class="weather-layer" src="https://cdn.tegna-media.com/wfaa/weather/animated-loops/comp/temp_880x495/state_tx_anim.gif"></div>
  `;

  let allSummaries = [];
  const fetchPromises = CITIES.slice(1).map(async city => {
    try {
      const res = await fetch(`https://api.weather.gov/products/types/AFD/locations/${city.code}`);
      const list = await res.json();
      const data = await (await fetch(list['@graph'][0]['@id'])).json();
      const text = parseAFDNarrative(data.productText);
      if (text) allSummaries.push(text);
    } catch (e) { console.error(`Failed ${city.code}`); }
  });

  await Promise.all(fetchPromises);
  const box = document.getElementById('state-narrative-box');
  if (allSummaries.length > 0) {
    box.innerHTML = `<h3>Regional Briefings</h3><p>Across Texas, we see ${allSummaries.join(' Additionally, ')}</p>`;
  } else {
    box.innerText = "Statewide narrative currently unavailable.";
  }
}

async function loadCityDataAsync(city,idx){
  const container = document.getElementById(`content-${idx}`);
  if(city.type === 'summary'){ await loadTexasSummary(container); return; }
  
  container.innerHTML = `
    <div class="card"><h2>Forecaster Narrative</h2><div id="narrative-${idx}" class="afd-summary-box">Loading...</div></div>
    <div class="card"><h2>Current Conditions</h2><div id="obs-${idx}">Loading...</div></div>
    <div class="card"><h2>7-Day Forecast</h2><div id="fc-${idx}">Loading...</div></div>
    <div class="card"><h2>Radar Loop</h2><img class="weather-layer" src="https://radar.weather.gov/ridge/standard/${city.radar}_loop.gif"></div>
  `;
  
  try {
    const pts = await fetchNWS(`https://api.weather.gov/points/${city.lat},${city.lon}`);
    const forecast = await fetchNWS(pts.properties.forecast);
    document.getElementById(`fc-${idx}`).innerHTML = forecast.properties.periods.slice(0, 6).map(p => `
      <div class="forecast-item">
        <div class="forecast-header"><span>${p.name}</span><span>${p.temperature}°${p.temperatureUnit}</span></div>
        <div>${p.detailedForecast}</div>
      </div>`).join('');
    const stns = await fetchNWS(pts.properties.observationStations);
    const latest = await fetchNWS(`${stns.features[0].id}/observations/latest`);
    const p = latest.properties;
    document.getElementById(`obs-${idx}`).innerHTML = `<b>${p.textDescription || 'N/A'}</b><br>Temp: ${p.temperature.value ? (p.temperature.value * 9/5 + 32).toFixed(0) : '--'}°F | Humidity: ${Math.round(p.relativeHumidity.value || 0)}%`;
    const afdList = await fetch(`https://api.weather.gov/products/types/AFD/locations/${city.code}`);
    const afdJson = await afdList.json();
    const afdFinal = await (await fetch(afdJson['@graph'][0]['@id'])).json();
    document.getElementById(`narrative-${idx}`).innerText = parseAFDNarrative(afdFinal.productText);
  } catch(e) { console.error(e); }
}

async function fetchNWS(url){ const res = await fetch(url, {headers: HEADERS}); return res.json(); }
init();
</script>
</body>
</html>
