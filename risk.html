<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vizcaya Risk Engine - Full Operational Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: system-ui, sans-serif;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
  max-width: 1000px;
  margin: auto;
}
h1,h2 { text-align: center; margin-bottom: 20px; }
.card {
  background: #111827;
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 24px rgba(0,0,0,.5);
  border-left: 6px solid #1e293b;
}
.safe  { border-left-color: #16a34a; }
.yellow{ border-left-color: #eab308; }
.orange{ border-left-color: #f97316; }
.red   { border-left-color: #dc2626; }
.label {
  font-weight: bold;
  color: #93c5fd;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 0.8rem;
  margin-bottom: 8px;
  display: block;
}
hr { border:1px solid #374151;margin:20px 0; }

/* Timeline UI */
.timeline-labels {
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
  font-size:12px;
  color:#9ca3af;
  width: 100vw;
  margin-left: 50%;
  transform: translateX(-50%);
}
#timeline-container {
  position: relative;
  border:1px solid #374151;
  background:#0a0f1d;
  border-radius: 8px;
  padding: 10px 0;
  width: 100vw;
  margin-left: 50%;
  transform: translateX(-50%);
  overflow: hidden;
  /* vertical grid lines every 1/7th of width */
  background-image: linear-gradient(to right, rgba(55,65,81,0.7) 1px, transparent 1px);
  background-size: calc(100% / 7) 100%;
}
.timeline-row {
  position: relative;
  height: 40px;
  border-bottom: 1px solid #1e293b;
  display: flex;
  align-items: center;
}
.timeline-row:last-child { border-bottom: none; }
.row-label {
  width: 80px;
  font-size: 11px;
  font-weight: bold;
  color: #93c5fd;
  text-align: right;
  padding-right: 10px;
  flex-shrink: 0;
}
.row-visual { position: relative; flex-grow: 1; height: 100%; }

.severe-row {
  display:flex;
  justify-content:space-between;
  padding:12px;
  border-radius:8px;
  margin-bottom:6px;
  font-size: 0.9rem;
}
.severe-low { background: rgba(22, 163, 74, 0.2); border: 1px solid #16a34a; }
.severe-mod { background: rgba(249, 115, 22, 0.2); border: 1px solid #f97316; }
.severe-high{ background: rgba(220, 38, 38, 0.2); border: 1px solid #dc2626; }

#severity-index {
  height:35px;
  border-radius:8px;
  margin-bottom:25px;
  background:#1e293b;
  position:relative;
  overflow:hidden;
  border: 1px solid #334155;
}
#severity-bar {
  height:100%; width:0%;
  background:#16a34a;
  transition:width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
}
#severity-text {
  position:absolute;
  width:100%;
  text-align:center;
  top:0;
  color:#fff;
  line-height:35px;
  font-weight:bold;
  text-shadow: 1px 1px 3px #000;
  font-size: 1.1rem;
}
#alerts { margin-bottom:20px; }
.alert-card {
  background:#7f1d1d;
  padding:15px;
  border-radius:8px;
  margin-bottom:10px;
  color:#fff;
  border-left: 8px solid #ef4444;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
#ai-telemetry { display: none; }
</style>
</head>
<body>

<h1>üå© VIZCAYA RISK ENGINE</h1>

<div id="severity-index">
  <div id="severity-bar"></div>
  <div id="severity-text">Synchronizing Global Models...</div>
</div>

<div id="alerts">Scanning National Weather Service...</div>

<h2>üóì Operational Hazard Timeline</h2>
<div class="timeline-labels" id="timeline-labels"></div>
<div id="timeline-container">
    <div class="timeline-row"><div class="row-label">FREEZE</div><div class="row-visual" id="row-freeze"></div></div>
    <div class="timeline-row"><div class="row-label">ICE/SLEET</div><div class="row-visual" id="row-ice"></div></div>
    <div class="timeline-row"><div class="row-label">SNOW</div><div class="row-visual" id="row-snow"></div></div>
    <div class="timeline-row"><div class="row-label">FOG</div><div class="row-visual" id="row-fog"></div></div>
    <div class="timeline-row"><div class="row-label">INSTAB</div><div class="row-visual" id="row-instab"></div></div>
    <div class="timeline-row"><div class="row-label">HEAT</div><div class="row-visual" id="row-heat"></div></div>
    <div class="timeline-row"><div class="row-label">HIGH WIND</div><div class="row-visual" id="row-wind"></div></div>
</div>

<div id="output">Generating Impact Analysis...</div>

<h2>‚ö° Severe Indices Analysis</h2>
<div id="severe-panel">Processing...</div>

<div class="card">
  <span class="label">Trigger Mechanisms</span>
  <ul style="font-size:0.9rem; line-height:1.5; padding-left: 1.2rem; margin: 0;">
    <li><strong>Freeze</strong>: Temperature at or below 32¬∞F for one or more consecutive hours.</li>
    <li><strong>Ice/Sleet</strong>: Temperature at or below 32¬∞F with precipitation probability ‚â• 20% in the same hour.</li>
    <li><strong>Snow</strong>: Hourly snowfall rate meeting or exceeding a small accumulation threshold (e.g., 0.1 units/hr).</li>
    <li><strong>Fog</strong>: Weather code indicating fog or depositing rime fog (codes 45 or 48).[web:6][web:108]</li>
    <li><strong>Instability</strong>: CAPE ‚â• 1000 J/kg together with Lifted Index ‚â§ -2, signaling a more unstable convective environment.[web:6][web:89][web:90][web:93][web:97][web:101]</li>
    <li><strong>Heat</strong>: Apparent temperature (heat index) at or above 95¬∞F, approximating elevated heat stress conditions.[web:6][web:111][web:116][web:119]</li>
    <li><strong>Excess Rain</strong>: Many hours with precipitation probability ‚â• 70%; for true flood risk, also consider NWS Flood Watches/Warnings and local hydrologic context.[web:6][web:59][web:63][web:66]</li>
  </ul>
</div>

<div id="ai-telemetry"></div>

<script>
const LAT = 30.5083;
const LON = -97.6789;

// Generic run finder
function findRuns(times, values, threshold, above = true){ 
    let runs = [], start = null, count = 0; 
    for (let i = 0; i < values.length; i++){ 
        let condition = above ? values[i] >= threshold : values[i] <= threshold; 
        if (condition){ 
            if (!start) start = new Date(times[i]); 
            count++; 
        } else { 
            if (start){
                runs.push({ start, end: new Date(times[i-1]), hours: count }); 
                start = null; 
                count = 0;
            }
        }
    } 
    if (start) runs.push({ start, end: new Date(times[times.length-1]), hours: count }); 
    return runs; 
}

// Ice runs
function findIceRuns(times, temp, precip, tempThreshold = 32, precipThreshold = 20){ 
    let runs = [], start = null, count = 0; 
    for (let i = 0; i < times.length; i++){ 
        if (temp[i] <= tempThreshold && (precip[i] || 0) >= precipThreshold){ 
            if (!start) start = new Date(times[i]); 
            count++; 
        } else { 
            if (start){
                runs.push({ start, end: new Date(times[i-1]), hours: count }); 
                start = null; 
                count = 0;
            }
        }
    } 
    if (start) runs.push({ start, end: new Date(times[times.length-1]), hours: count }); 
    return runs; 
}

// Snow runs
function findSnowRuns(times, snow, snowThreshold){
    let runs = [], start = null, count = 0;
    for (let i = 0; i < times.length; i++){
        if ((snow[i] || 0) >= snowThreshold){
            if (!start) start = new Date(times[i]);
            count++;
        } else {
            if (start){
                runs.push({ start, end: new Date(times[i-1]), hours: count });
                start = null;
                count = 0;
            }
        }
    }
    if (start) runs.push({ start, end: new Date(times[times.length-1]), hours: count });
    return runs;
}

// Fog runs
function findFogRuns(times, weathercode){
    let runs = [], start = null, count = 0;
    for (let i = 0; i < times.length; i++){
        const code = weathercode[i];
        const isFog = code === 45 || code === 48;
        if (isFog){
            if (!start) start = new Date(times[i]);
            count++;
        } else {
            if (start){
                runs.push({ start, end: new Date(times[i-1]), hours: count });
                start = null;
                count = 0;
            }
        }
    }
    if (start) runs.push({ start, end: new Date(times[times.length-1]), hours: count });
    return runs;
}

// Instability runs
function findInstabilityRuns(times, cape, li, capeThreshold = 1000, liThreshold = -2){
    let runs = [], start = null, count = 0;
    for (let i = 0; i < times.length; i++){
        const c = cape[i] || 0;
        const l = li[i];
        const unstable = c >= capeThreshold && l <= liThreshold;
        if (unstable){
            if (!start) start = new Date(times[i]);
            count++;
        } else {
            if (start){
                runs.push({ start, end: new Date(times[i-1]), hours: count });
                start = null;
                count = 0;
            }
        }
    }
    if (start) runs.push({ start, end: new Date(times[times.length-1]), hours: count });
    return runs;
}

// Heat runs
function findHeatRuns(times, apparent, heatThreshold = 95){
    let runs = [], start = null, count = 0;
    for (let i = 0; i < times.length; i++){
        if (apparent[i] >= heatThreshold){
            if (!start) start = new Date(times[i]);
            count++;
        } else {
            if (start){
                runs.push({ start, end: new Date(times[i-1]), hours: count });
                start = null;
                count = 0;
            }
        }
    }
    if (start) runs.push({ start, end: new Date(times[times.length-1]), hours: count });
    return runs;
}

function renderRow(runs, containerId, color, startTime){
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    const totalHours = 168; // 7 days
    runs.forEach(r => {
        const startHour    = (new Date(r.start) - startTime) / 3600000;
        const leftPercent  = (startHour / totalHours) * 100;
        const widthPercent = (r.hours   / totalHours) * 100;
        const bar = document.createElement('div');
        bar.style.cssText = `
            position:absolute;
            left:${leftPercent}%;
            width:${widthPercent}%;
            height:24px;
            background:${color};
            border-radius:4px;
            opacity:0.8;
            top:8px;
            border:1px solid rgba(255,255,255,0.2);
        `;
        bar.title = `${r.hours} hours starting ${r.start.getHours()}:00`;
        container.appendChild(bar);
    });
}

// Bucket NWS alerts
function classifyAlerts(activeAlerts){
    const result = {
        warnings: [],
        watches: [],
        advisories: [],
        others: []
    };

    activeAlerts.forEach(a => {
        const p = a.properties || {};
        const event = (p.event || "").toLowerCase();
        const severity = (p.severity || "").toLowerCase();

        if (event.includes("warning") || severity === "severe" || severity === "extreme") {
            result.warnings.push(a);
        } else if (event.includes("watch")) {
            result.watches.push(a);
        } else if (event.includes("advisory")) {
            result.advisories.push(a);
        } else {
            result.others.push(a);
        }
    });

    return result;
}

// Primary Infrastructure Threat card
function buildPrimaryThreatCard(
    finalScore,
    freezeHours,
    minTemp,
    hasIce,
    hasSnowRisk,
    hasFogRisk,
    hasInstability,
    instabHours,
    hasHeatRisk,
    heatHours,
    maxAppTemp,
    alertBuckets
){
    const hasWarning  = alertBuckets.warnings.length > 0;
    const hasWatch    = alertBuckets.watches.length > 0;
    const hasAdvisory = alertBuckets.advisories.length > 0;

    let toneClass = finalScore > 70 ? 'red' : 'orange';
    const headline = "Primary Infrastructure Threat";
    let narrative;

    let primaryAlert = alertBuckets.warnings[0] || alertBuckets.watches[0] || alertBuckets.advisories[0] || alertBuckets.others[0];
    const primaryName = primaryAlert && primaryAlert.properties ? primaryAlert.properties.event : null;

    const snowText   = hasSnowRisk ? "accumulating snow" : "minimal accumulating snow";
    const fogText    = hasFogRisk ? "periods of reduced visibility from fog" : "limited fog‚Äërelated impacts";
    const instabText = hasInstability ? `a ${instabHours}-hour window of elevated convective instability` : "only weak convective instability";
    const heatText   = hasHeatRisk ? `a ${heatHours}-hour stretch with apparent temperatures peaking near ${maxAppTemp.toFixed(0)}¬∞F` : "no prolonged dangerous heat signal";

    if (hasWarning) {
        narrative = `
            A National Weather Service <strong>warning</strong>${primaryName ? ` for <strong>${primaryName}</strong>` : ""} is in effect, indicating hazardous conditions are occurring or imminent.
            Expect elevated risk to power, transportation, and exposed assets during the <strong>${freezeHours}-hour</strong> window at or below freezing, with a projected low near <strong>${minTemp}¬∞F</strong>, and ${heatText}.
            Overlap of moisture and sub‚Äëfreezing air yields a <strong>${hasIce ? "Significant" : "Limited"}</strong> icing risk, along with ${snowText}, ${fogText}, and ${instabText}.
        `;
    } else if (hasWatch) {
        narrative = `
            A National Weather Service <strong>watch</strong>${primaryName ? ` for <strong>${primaryName}</strong>` : ""} is in effect, meaning hazardous conditions are possible within the next 24‚Äì48 hours.
            Infrastructure risk ramps up as the forecast trends toward a <strong>${freezeHours}-hour</strong> freeze window with a minimum temperature near <strong>${minTemp}¬∞F</strong>, and ${heatText}.
            Icing risk is projected to be <strong>${hasIce ? "Significant" : "Low"}</strong>, with ${snowText}, ${fogText}, and ${instabText} during the core impact window.
        `;
    } else if (hasAdvisory) {
        narrative = `
            One or more National Weather Service <strong>advisories</strong>${primaryName ? ` including <strong>${primaryName}</strong>` : ""} are in effect, signaling impactful but generally less extreme conditions.
            Expect localized stress to transportation, exposed infrastructure, and sensitive plumbing during the <strong>${freezeHours}-hour</strong> stretch at or below freezing (minimum near <strong>${minTemp}¬∞F</strong>), and ${heatText}.
            Icing potential is <strong>${hasIce ? "Elevated" : "Limited"}</strong>, with ${snowText}, ${fogText}, and ${instabText} focused on typical trouble spots such as bridges, overpasses, and low‚Äëlying areas.
        `;
    } else {
        toneClass = finalScore > 40 ? 'orange' : 'yellow';
        narrative = `
            No active NWS advisories, watches, or warnings are in effect, but model guidance still supports a <strong>${freezeHours}-hour</strong> freeze window with a minimum temperature near <strong>${minTemp}¬∞F</strong>, and ${heatText}.
            Infrastructure concerns focus on exposed plumbing, patchy icing where moisture overlaps the coldest hours, ${snowText}, and ${instabText}.
            Visibility impacts from fog are currently assessed as <strong>${hasFogRisk ? "Possible" : "Low"}</strong> and will escalate quickly if formal NWS products are issued.
        `;
    }

    return `
        <div class="card ${toneClass}">
            <span class="label">${headline}</span>
            <p>${narrative}</p>
        </div>
    `;
}

async function checkDashboard(){
    const outEl            = document.getElementById("output");
    const timelineLabelsEl = document.getElementById("timeline-labels");
    const severeEl         = document.getElementById("severe-panel");
    const sevBar           = document.getElementById("severity-bar");
    const sevText          = document.getElementById("severity-text");
    const alertsEl         = document.getElementById("alerts");

    try {
        let activeAlerts = [];
        try {
            const alertRes = await fetch(
                `https://api.weather.gov/alerts/active?point=${LAT},${LON}`,
                { headers: { 'User-Agent': 'VizcayaDashboard/1.0' }}
            );
            const alertData = await alertRes.json();
            activeAlerts = alertData.features || [];
        } catch (e) {
            console.warn("NWS API Fail", e);
        }

        const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
            `&hourly=temperature_2m,apparent_temperature,wind_speed_10m,wind_gusts_10m,` +
            `precipitation_probability,snowfall,weathercode,cape,lifted_index` +
            `&temperature_unit=fahrenheit&wind_speed_unit=mph&forecast_days=7&timezone=auto`
        );
        const d = await res.json();
        const h = d.hourly;

        let score = 0; 

        const minTemp     = Math.min(...h.temperature_2m);
        const maxAppTemp  = Math.max(...h.apparent_temperature);
        const freezeHours = h.temperature_2m.filter(t => t <= 32).length;
        const maxWind     = Math.max(...h.wind_gusts_10m);

        const iceRuns     = findIceRuns(h.time, h.temperature_2m, h.precipitation_probability, 32, 20);
        const hasIce      = iceRuns.length > 0;

        const snowRuns    = findSnowRuns(h.time, h.snowfall, 0.1);
        const fogRuns     = findFogRuns(h.time, h.weathercode);
        const snowHours   = snowRuns.reduce((sum,r) => sum + r.hours, 0);
        const fogHours    = fogRuns.reduce((sum,r) => sum + r.hours, 0);
        const hasSnowRisk = snowHours > 0;
        const hasFogRisk  = fogHours > 0;

        const heatRuns    = findHeatRuns(h.time, h.apparent_temperature, 95);
        const heatHours   = heatRuns.reduce((sum,r) => sum + r.hours, 0);
        const hasHeatRisk = heatHours > 0;

        // Simple ‚Äúexcess rain‚Äù hours: PoP ‚â• 70%
        const excessRainHours = h.precipitation_probability.filter(p => (p || 0) >= 70).length;
        const hasExcessRain   = excessRainHours > 0;

        // Instability guarded
        const capeArray  = h.cape || [];
        const liArray    = h.lifted_index || [];
        let instabRuns   = [];
        let instabHours  = 0;
        let hasInstability = false;

        if (capeArray.length && liArray.length){
            instabRuns   = findInstabilityRuns(h.time, capeArray, liArray);
            instabHours  = instabRuns.reduce((sum,r) => sum + r.hours, 0);
            hasInstability = instabHours > 0;
        }

        // Scoring
        if (minTemp <= 32) { 
            score += 20; 
            if (freezeHours > 24) score += 20;
        }
        if (hasIce)        score += 30;
        if (maxWind >= 35) score += 10;
        if (hasSnowRisk)   score += 10;
        if (hasFogRisk)    score += 5;
        if (hasHeatRisk)   score += 15;
        if (hasInstability){
            score += 5;
            const severeAlerts = activeAlerts.filter(a => {
                const ev = (a.properties?.event || "").toLowerCase();
                return ev.includes("severe thunderstorm") || ev.includes("tornado");
            });
            if (severeAlerts.length > 0) score += 10;
        }
        if (hasExcessRain) score += 5;
        if (activeAlerts.length > 0) score += 20;

        const finalScore = Math.min(100, score);
        sevBar.style.width = finalScore + '%';
        sevText.innerText  = `DAILY SEVERITY INDEX: ${finalScore}%`;
        sevBar.style.background =
            finalScore > 75
                ? "#dc2626"
                : (finalScore > 40 ? "#f97316" : "#16a34a");

        // Alerts panel
        if (activeAlerts.length > 0) {
            alertsEl.innerHTML = activeAlerts.map(a => `
                <div class="alert-card">
                    ‚ö†Ô∏è ${a.properties.event}<br>
                    <small>${a.properties.headline || ""}</small>
                </div>
            `).join("");
        } else {
            alertsEl.innerHTML = "<div class='card safe'>‚úÖ No active NWS advisories, watches, or warnings.</div>";
        }

        // Timeline labels (7 days)
        const startDate = new Date(h.time[0]);
        timelineLabelsEl.innerHTML = "";
        for (let i = 0; i < 7; i++){
            let dt = new Date(startDate); 
            dt.setDate(dt.getDate() + i);
            timelineLabelsEl.innerHTML += `<span>${dt.toLocaleDateString('en-US',{weekday:'short',day:'numeric'})}</span>`;
        }
        
        // Timeline rows
        renderRow(findRuns(h.time, h.temperature_2m, 32, false), "row-freeze", "#3b82f6", startDate);
        renderRow(iceRuns,   "row-ice",   "#dc2626", startDate);
        renderRow(snowRuns,  "row-snow",  "#a855f7", startDate);
        renderRow(fogRuns,   "row-fog",   "#6b7280", startDate);
        if (instabRuns.length){
            renderRow(instabRuns, "row-instab", "#22c55e", startDate);
        } else {
            document.getElementById("row-instab").innerHTML = "";
        }
        renderRow(heatRuns,  "row-heat",  "#ef4444", startDate);
        renderRow(findRuns(h.time, h.wind_gusts_10m, 25, true), "row-wind", "#fbbf24", startDate);

        // Alert classification and narrative card
        const alertBuckets = classifyAlerts(activeAlerts);

        const primaryCard = buildPrimaryThreatCard(
            finalScore,
            freezeHours,
            minTemp,
            hasIce,
            hasSnowRisk,
            hasFogRisk,
            hasInstability,
            instabHours,
            hasHeatRisk,
            heatHours,
            maxAppTemp,
            alertBuckets
        );

        outEl.innerHTML = primaryCard;

        // Indices Panel
        severeEl.innerHTML = `
            <div class="severe-row ${hasIce ? 'severe-high' : 'severe-low'}">
                <strong>Icing Potential</strong> <span>${hasIce ? 'HIGH' : 'LOW'}</span>
            </div>
            <div class="severe-row ${minTemp < 20 ? 'severe-high' : 'severe-mod'}">
                <strong>Plumbing Stress</strong> <span>${minTemp < 20 ? 'CRITICAL' : 'MODERATE'}</span>
            </div>
            <div class="severe-row ${maxWind > 35 ? 'severe-mod' : 'severe-low'}">
                <strong>Wind Load</strong> <span>${maxWind.toFixed(0)} MPH GUSTS</span>
            </div>
            <div class="severe-row ${hasSnowRisk ? 'severe-mod' : 'severe-low'}">
                <strong>Snow Impact</strong> <span>${hasSnowRisk ? snowHours + ' HOURS' : 'LOW'}</span>
            </div>
            <div class="severe-row ${hasFogRisk ? 'severe-mod' : 'severe-low'}">
                <strong>Fog / Visibility</strong> <span>${hasFogRisk ? fogHours + ' HOURS' : 'LOW'}</span>
            </div>
            <div class="severe-row ${hasHeatRisk ? 'severe-mod' : 'severe-low'}">
                <strong>Heat Stress</strong> <span>${hasHeatRisk ? heatHours + ' HOURS ‚â• 95¬∞F' : 'LOW'}</span>
            </div>
            <div class="severe-row ${hasInstability ? 'severe-mod' : 'severe-low'}">
                <strong>Convective Instability</strong> <span>${hasInstability ? instabHours + ' HOURS' : 'LOW'}</span>
            </div>
            <div class="severe-row ${hasExcessRain ? 'severe-mod' : 'severe-low'}">
                <strong>Excess Rain Signal</strong> <span>${hasExcessRain ? excessRainHours + ' HOURS PoP ‚â• 70%' : 'LOW'}</span>
            </div>
        `;

        document.getElementById('ai-telemetry').innerText =
            `DSI:${finalScore}|FREEZE_HRS:${freezeHours}|MIN_TEMP:${minTemp}|ICE:${hasIce}` +
            `|SNOW_HRS:${snowHours}|FOG_HRS:${fogHours}|HEAT_HRS:${heatHours}|MAX_APP:${maxAppTemp}` +
            `|INSTAB_HRS:${instabHours}|EX_RAIN_HRS:${excessRainHours}`;

    } catch (err) {
        console.error(err);
        sevText.innerText = "Sync Failure";
    }
}

checkDashboard();
setInterval(checkDashboard, 600000);
</script>
</body>
</html>
