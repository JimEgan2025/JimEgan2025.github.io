<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vizcaya Risk Engine - Full Operational Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
    --bg-dark: #020617;
    --bg-card: #111827;
    --border: #334155;
    --text-main: #e5e7eb;
    --accent-blue: #3b82f6;
    --accent-red: #dc2626;
    --accent-orange: #f97316;
    --accent-green: #16a34a;
    --accent-purple: #a855f7;
    --accent-cyan: #22d3ee;
    --accent-yellow: #facc15;
}
body {
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--bg-dark);
  color: var(--text-main);
  padding: 20px;
  max-width: 1000px;
  margin: auto;
}
h1 { margin: 0 0 20px 0; text-align: center; font-weight:800; letter-spacing:-1px;}
h2 { text-align: center; margin: 30px 0 15px 0; font-size:1.1rem; text-transform:uppercase; color:#94a3b8; letter-spacing:1px; border-bottom:1px solid var(--border); padding-bottom:10px; }

/* UTILS */
.btn-geo {
    position: absolute; top: 20px; right: 20px;
    background: #1e293b; color: #94a3b8;
    border: 1px solid var(--border);
    padding: 6px 12px; border-radius: 6px;
    cursor: pointer; font-size: 0.8rem;
    transition: all 0.2s;
}
.btn-geo:hover { background: #334155; color: #fff; }

/* CARDS */
.card {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.05);
  border-left: 5px solid #334155;
}
.safe { border-left-color: var(--accent-green); }
.yellow{ border-left-color: #eab308; }
.orange{ border-left-color: var(--accent-orange); }
.red   { border-left-color: var(--accent-red); background: rgba(220,38,38,0.1); }

.label {
  font-weight: 700; color: #93c5fd;
  text-transform: uppercase; letter-spacing: 0.05em;
  font-size: 0.75rem; margin-bottom: 8px; display: block;
}

/* SEVERITY BAR */
#severity-wrapper { position: relative; margin-bottom: 10px; }
#severity-index {
  height: 40px; background: #0f172a;
  border-radius: 8px; overflow: hidden;
  border: 1px solid var(--border);
  position: relative;
}
#severity-bar {
  height: 100%; width: 0%;
  background: var(--accent-green);
  transition: width 1s ease, background 0.5s ease;
}
#severity-text {
  position: absolute; top: 0; width: 100%;
  text-align: center; line-height: 40px;
  font-weight: bold; font-family: monospace; font-size: 1.1rem;
  text-shadow: 0 1px 2px rgba(0,0,0,0.8); pointer-events: none;
}
#severity-meta {
    display: flex; justify-content: space-between;
    font-size: 0.75rem; color: #64748b; margin-top: 4px;
}

/* NEXT THREAT BANNER */
#next-threat {
    background: #1e293b; border: 1px solid var(--border);
    color: #94a3b8; padding: 8px; border-radius: 6px;
    text-align: center; font-size: 0.9rem; font-weight: 500;
    margin-bottom: 20px;
}
#next-threat.active { background: rgba(239, 68, 68, 0.2); border-color: var(--accent-red); color: #fca5a5; animation: pulse 2s infinite; }

/* TIMELINE */
.timeline-labels { display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.7rem; color:#64748b; font-family:monospace; padding:0 5px; }
#timeline-container {
  position: relative; background: #0f172a;
  border: 1px solid var(--border); border-radius: 8px;
  overflow: hidden; padding: 5px 0;
  /* Grid lines */
  background-image: linear-gradient(to right, #1e293b 1px, transparent 1px);
  background-size: calc(100% / 7) 100%;
}
.timeline-row { position: relative; height: 32px; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
.timeline-row:last-child { border-bottom: none; }
.row-label { width: 70px; font-size: 0.65rem; font-weight: 700; color: #94a3b8; text-align: right; padding-right: 10px; flex-shrink: 0; }
.row-visual { position: relative; flex-grow: 1; height: 100%; }

/* STATS MATRIX */
#severe-panel {
    display: grid; grid-template-columns: 1fr; gap: 8px;
}
@media(min-width: 600px) { #severe-panel { grid-template-columns: 1fr 1fr; } }

.severe-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 15px; border-radius: 6px;
  font-size: 0.85rem; border: 1px solid transparent;
}
.severe-low { background: rgba(22, 163, 74, 0.1); border-color: rgba(22, 163, 74, 0.3); }
.severe-mod { background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.3); }
.severe-high{ background: rgba(220, 38, 38, 0.15); border-color: rgba(220, 38, 38, 0.4); }
.severe-row strong { color: #e2e8f0; }
.severe-row span { font-weight: 700; letter-spacing: 0.5px; }

/* ALERTS */
#alerts { margin-bottom: 20px; }
.alert-card {
  background: rgba(185, 28, 28, 0.25);
  border-left: 4px solid #ef4444;
  padding: 10px 15px; margin-bottom: 8px; border-radius: 4px;
  font-size: 0.9rem;
}

@keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
</style>
</head>
<body>

<button class="btn-geo" onclick="getLocation()">üìç Locate Me</button>
<h1>‚ö° VIZCAYA RISK ENGINE</h1>

<div id="severity-wrapper">
    <div id="severity-index">
      <div id="severity-bar"></div>
      <div id="severity-text">INITIALIZING...</div>
    </div>
    <div id="severity-meta">
        <span id="loc-label">LOC: 30.51, -97.68 (Default)</span>
        <span id="last-updated">Updated: --:--</span>
    </div>
</div>

<div id="next-threat">Checking immediate hazards...</div>

<div id="alerts"></div>

<h2>üóì Operational Hazard Timeline (7 Days)</h2>
<div class="timeline-labels" id="timeline-labels"></div>
<div id="timeline-container">
    <div class="timeline-row"><div class="row-label">FREEZE</div><div class="row-visual" id="row-freeze"></div></div>
    <div class="timeline-row"><div class="row-label">ICE/SLEET</div><div class="row-visual" id="row-ice"></div></div>
    <div class="timeline-row"><div class="row-label">SNOW</div><div class="row-visual" id="row-snow"></div></div>
    <div class="timeline-row"><div class="row-label">HEAVY RAIN</div><div class="row-visual" id="row-rain"></div></div>
    <div class="timeline-row"><div class="row-label">HIGH WIND</div><div class="row-visual" id="row-wind"></div></div>
    <div class="timeline-row"><div class="row-label">FOG</div><div class="row-visual" id="row-fog"></div></div>
    <div class="timeline-row"><div class="row-label">INSTAB</div><div class="row-visual" id="row-instab"></div></div>
    <div class="timeline-row"><div class="row-label">HEAT</div><div class="row-visual" id="row-heat"></div></div>
    <div class="timeline-row"><div class="row-label">FIRE WX</div><div class="row-visual" id="row-fire"></div></div>
</div>

<div id="output" style="margin-top:20px;">Generating Impact Analysis...</div>

<h2>üìä Hazard Telemetry</h2>
<div id="severe-panel">Processing...</div>

<div class="card" style="margin-top:30px;">
  <span class="label">Trigger Mechanisms</span>
  <ul style="font-size:0.85rem; line-height:1.6; padding-left: 1.2rem; margin: 0; color: #94a3b8;">
    <li><strong>Freeze</strong>: Temp ‚â§ 32¬∞F for ‚â•1 hour.</li>
    <li><strong>Plumbing Stress</strong>: CRITICAL if Temp < 20¬∞F; MODERATE if 20-32¬∞F; LOW if > 32¬∞F.</li>
    <li><strong>Ice/Sleet</strong>: Temp ‚â§ 32¬∞F AND Precip Probability ‚â• 20%.</li>
    <li><strong>Heavy Rain</strong>: Rate ‚â• 0.15"/hr OR Active Flood Alerts.</li>
    <li><strong>High Wind</strong>: Gusts ‚â• 30 mph.</li>
    <li><strong>Fog</strong>: Weather Codes 45 or 48.</li>
    <li><strong>Instability</strong>: CAPE ‚â• 500 J/kg AND Lifted Index ‚â§ -2.</li>
    <li><strong>Heat</strong>: Heat Index ‚â• 95¬∞F.</li>
    <li><strong>Fire Weather</strong>: Wind > 15mph AND Humidity < 25%.</li>
  </ul>
</div>

<script>
// Default: Round Rock/Vizcaya
let LAT = 30.5083;
let LON = -97.6789;
let updateTimer = null;

function getLocation() {
    const btn = document.querySelector('.btn-geo');
    if (navigator.geolocation) {
        btn.innerText = "‚è≥ Triangulating...";
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                LAT = pos.coords.latitude;
                LON = pos.coords.longitude;
                btn.innerText = "üìç Locate Me";
                document.getElementById('loc-label').innerText = `LOC: ${LAT.toFixed(2)}, ${LON.toFixed(2)} (GPS)`;
                checkDashboard();
            },
            (err) => {
                btn.innerText = "‚ùå Error";
                alert("Geolocation failed: " + err.message);
                setTimeout(() => btn.innerText = "üìç Locate Me", 2000);
            }
        );
    } else { alert("Geolocation not supported"); }
}

// === ROBUST RUN ENGINE ===
function findSequences(times, predicate){
    let runs = [], start = null, count = 0;
    for(let i=0; i<times.length; i++){
        if(predicate(i)){
            if(!start) start = new Date(times[i]);
            count++;
        } else {
            if(start){
                runs.push({ start, end: new Date(times[i-1]), hours: count });
                start = null; count = 0;
            }
        }
    }
    if(start) runs.push({ start, end: new Date(times[times.length-1]), hours: count });
    return runs;
}

function renderRow(runs, containerId, color, startTime){
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    const totalHours = 168; // 7 days
    runs.forEach(r => {
        const startHour = (new Date(r.start) - startTime) / 3600000;
        const left = (startHour / totalHours) * 100;
        const width = (r.hours / totalHours) * 100;
        const bar = document.createElement('div');
        bar.style.cssText = `position:absolute; left:${left}%; width:${width}%; height:20px; background:${color}; border-radius:3px; opacity:0.9; top:6px; box-shadow:0 0 5px ${color};`;
        bar.title = `${r.start.toLocaleDateString()} ${r.start.getHours()}:00 (${r.hours}hrs)`;
        container.appendChild(bar);
    });
}

async function checkDashboard(){
    const outEl = document.getElementById("output");
    const alertsEl = document.getElementById("alerts");
    const nextThreatEl = document.getElementById("next-threat");

    document.getElementById("last-updated").innerText = "Updated: " + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    try {
        // 1. Get Alerts
        let activeAlerts = [];
        try {
            const alertRes = await fetch(`https://api.weather.gov/alerts/active?point=${LAT},${LON}`);
            const alertData = await alertRes.json();
            activeAlerts = alertData.features || [];
        } catch (e) { console.warn("NWS API Fail"); }

        // Flood Check
        const floodAlerts = activeAlerts.filter(a => {
            const ev = (a.properties.event || "").toLowerCase();
            return ev.includes("flood") || ev.includes("hydrologic") || ev.includes("rain");
        });
        const hasFloodAlert = floodAlerts.length > 0;

        // 2. Get Data
        const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
            `&hourly=temperature_2m,apparent_temperature,wind_gusts_10m,` +
            `precipitation_probability,precipitation,snowfall,weathercode,cape,lifted_index,relative_humidity_2m` +
            `&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&forecast_days=7&timezone=auto`
        );
        const d = await res.json();
        const h = d.hourly;
        
        // --- Analysis Setup ---
        const startTime = new Date(h.time[0]);
        const minTemp = Math.min(...h.temperature_2m);
        const maxWind = Math.max(...h.wind_gusts_10m);
        
        // --- DATA MAPPING ---
        
        const freezeRuns = findSequences(h.time, i => h.temperature_2m[i] <= 32);
        const freezeHours = freezeRuns.reduce((s,r) => s+r.hours, 0);
        
        const iceRuns = findSequences(h.time, i => h.temperature_2m[i] <= 32 && (h.precipitation_probability[i]||0) >= 20);
        const hasIce = iceRuns.length > 0;
        
        const snowRuns = findSequences(h.time, i => (h.snowfall[i]||0) >= 0.1);
        const snowHours = snowRuns.reduce((s,r) => s+r.hours, 0);

        const rainRuns = findSequences(h.time, i => (h.precipitation[i]||0) >= 0.15);
        const maxRainRate = Math.max(...h.precipitation);
        const totalRain = h.precipitation.reduce((a,b) => a+b, 0);
        
        // Wind: Gusts >= 30 mph
        const windRuns = findSequences(h.time, i => h.wind_gusts_10m[i] >= 30);
        
        // Fog: Code 45 or 48
        const fogRuns = findSequences(h.time, i => h.weathercode[i] === 45 || h.weathercode[i] === 48);
        const fogHours = fogRuns.reduce((s,r) => s+r.hours, 0);

        // Instability: CAPE >= 500, LI <= -2
        const instabRuns = findSequences(h.time, i => (h.cape[i]||0) >= 500 && (h.lifted_index[i]||0) <= -2);
        const instabHours = instabRuns.reduce((s,r) => s+r.hours, 0);
        
        const heatRuns = findSequences(h.time, i => h.apparent_temperature[i] >= 95);
        const heatHours = heatRuns.reduce((s,r) => s+r.hours, 0);
        
        const fireRuns = findSequences(h.time, i => h.wind_gusts_10m[i] >= 15 && h.relative_humidity_2m[i] <= 25);
        const fireHours = fireRuns.reduce((s,r) => s+r.hours, 0);

        // --- Energy Load ---
        let hdd = 0, cdd = 0;
        h.temperature_2m.forEach(t => {
            if(t < 65) hdd += (65 - t) / 24;
            if(t > 65) cdd += (t - 65) / 24;
        });

        // --- Scoring ---
        let score = 0;
        if(minTemp <= 32) score += 20;
        if(freezeHours > 24) score += 20;
        if(hasIce) score += 40;
        if(maxWind >= 35) score += 10;
        if(snowHours > 0) score += 10;
        if(heatHours > 0) score += 15;
        if(instabHours > 0) score += 10;
        if(fireHours > 0) score += 15;
        if(hasFloodAlert) score += 25;
        if(maxRainRate > 0.5) score += 20; 
        
        if(activeAlerts.length > 0) score += 10;
        const finalScore = Math.min(100, score);

        // --- RENDER SEVERITY ---
        const bar = document.getElementById('severity-bar');
        bar.style.width = finalScore + '%';
        bar.style.background = finalScore > 70 ? 'var(--accent-red)' : (finalScore > 40 ? 'var(--accent-orange)' : 'var(--accent-green)');
        document.getElementById('severity-text').innerText = `RISK INDEX: ${finalScore}/100`;

        // --- RENDER NEXT THREAT ---
        let nextThreatText = "‚úÖ NO IMMEDIATE CRITICAL THREATS (48 HR)";
        let nextThreatClass = "";
        
        for(let i=0; i<48; i++){
            const t = h.temperature_2m[i];
            const p = h.precipitation_probability[i] || 0;
            const rate = h.precipitation[i] || 0;
            const w = h.wind_gusts_10m[i];
            const timeStr = new Date(h.time[i]).toLocaleTimeString([], {weekday:'short', hour:'numeric'});
            
            if(t <= 32 && p >= 20) { nextThreatText = `‚ö†Ô∏è ICING STARTING: ${timeStr}`; nextThreatClass="active"; break; }
            if(rate >= 0.25) { nextThreatText = `‚ö†Ô∏è HEAVY RAIN (${rate}"/hr): ${timeStr}`; nextThreatClass="active"; break; }
            if(w >= 40) { nextThreatText = `‚ö†Ô∏è HIGH WIND (${w.toFixed(0)}mph): ${timeStr}`; nextThreatClass="active"; break; }
            if(t <= 28) { nextThreatText = `‚ö†Ô∏è HARD FREEZE: ${timeStr}`; nextThreatClass="active"; break; }
            if(h.apparent_temperature[i] >= 105) { nextThreatText = `‚ö†Ô∏è DANGEROUS HEAT: ${timeStr}`; nextThreatClass="active"; break; }
        }
        nextThreatEl.innerText = nextThreatText;
        nextThreatEl.className = nextThreatClass;

        // --- RENDER ALERTS ---
        if(activeAlerts.length > 0){
            alertsEl.innerHTML = activeAlerts.map(a => `<div class="alert-card">‚ö†Ô∏è <strong>${a.properties.event}</strong>: ${a.properties.headline?.split('.')[0]}</div>`).join('');
        } else {
            alertsEl.innerHTML = `<div class="card safe" style="padding:10px; font-size:0.9rem;">‚úÖ No active NWS advisories.</div>`;
        }

        // --- RENDER TIMELINE ---
        const tlLabels = document.getElementById('timeline-labels');
        tlLabels.innerHTML = '';
        for(let i=0; i<7; i++){
            let d = new Date(startTime); d.setDate(d.getDate()+i);
            tlLabels.innerHTML += `<span>${d.toLocaleDateString('en-US',{weekday:'short',day:'numeric'})}</span>`;
        }
        
        renderRow(freezeRuns, "row-freeze", "var(--accent-blue)", startTime);
        renderRow(iceRuns, "row-ice", "var(--accent-red)", startTime);
        renderRow(snowRuns, "row-snow", "var(--accent-purple)", startTime);
        renderRow(rainRuns, "row-rain", "var(--accent-cyan)", startTime);
        renderRow(windRuns, "row-wind", "var(--accent-orange)", startTime);
        renderRow(fogRuns, "row-fog", "#9ca3af", startTime);
        renderRow(instabRuns, "row-instab", "var(--accent-yellow)", startTime);
        renderRow(heatRuns, "row-heat", "var(--accent-red)", startTime);
        renderRow(fireRuns, "row-fire", "var(--accent-orange)", startTime);

        // --- RENDER PANEL ---
        let plumbingClass = minTemp < 20 ? 'severe-high' : (minTemp <= 32 ? 'severe-mod' : 'severe-low');
        let plumbingText = minTemp < 20 ? 'CRITICAL (<20¬∞F)' : (minTemp <= 32 ? 'MODERATE (Freeze)' : 'LOW (No Freeze)');
        
        let rainClass = 'severe-low';
        let rainText = 'LOW';
        if(hasFloodAlert || maxRainRate > 0.5) { rainClass = 'severe-high'; rainText = `HIGH (Max ${maxRainRate.toFixed(2)}"/hr)`; }
        else if(maxRainRate > 0.15 || totalRain > 2.0) { rainClass = 'severe-mod'; rainText = `MOD (Total ${totalRain.toFixed(1)}")`; }
        else if(totalRain > 0) { rainText = `LOW (Total ${totalRain.toFixed(2)}")`; }

        document.getElementById('severe-panel').innerHTML = `
            <div class="severe-row ${hasIce ? 'severe-high' : 'severe-low'}">
                <strong>Icing Potential</strong> <span>${hasIce ? 'HIGH' : 'LOW'}</span>
            </div>
            <div class="severe-row ${plumbingClass}">
                <strong>Plumbing Stress</strong> <span>${plumbingText}</span>
            </div>
            <div class="severe-row ${rainClass}">
                <strong>Rain Rate / Total</strong> <span>${rainText}</span>
            </div>
            <div class="severe-row ${maxWind > 35 ? 'severe-mod' : 'severe-low'}">
                <strong>Wind Load</strong> <span>${maxWind.toFixed(0)} MPH GUSTS</span>
            </div>
            <div class="severe-row ${fireHours > 0 ? 'severe-high' : 'severe-low'}">
                <strong>Fire Weather</strong> <span>${fireHours > 0 ? fireHours + ' HRS (Wind+Dry)' : 'LOW'}</span>
            </div>
            <div class="severe-row ${heatHours > 0 ? 'severe-mod' : 'severe-low'}">
                <strong>Heat Stress</strong> <span>${heatHours > 0 ? heatHours + ' HRS ‚â•95¬∞F' : 'LOW'}</span>
            </div>
            <div class="severe-row severe-low">
                <strong>HVAC Load (Degree Days)</strong> <span>${Math.round(cdd)} Cool / ${Math.round(hdd)} Heat</span>
            </div>
            <div class="severe-row ${instabHours > 0 ? 'severe-mod' : 'severe-low'}">
                <strong>Instability / Fog</strong> <span>${instabHours}hr CAPE | ${fogHours}hr FOG</span>
            </div>
        `;

        // --- RENDER NARRATIVE ---
        let narrative = "Conditions remain within operational norms.";
        let cardClass = "safe";
        
        if(finalScore > 60) {
            cardClass = "red";
            narrative = `<strong>CRITICAL HAZARD:</strong> Significant infrastructure stress projected. 
            ${hasIce ? "Major icing likely." : ""} 
            ${minTemp < 20 ? "Hard freeze poses burst pipe risk." : ""} 
            ${maxRainRate > 0.5 ? "Flash flooding likely due to high rain intensity." : ""}`;
        } else if (finalScore > 35) {
            cardClass = "orange";
            narrative = `<strong>ELEVATED RISK:</strong> Monitor conditions. 
            ${fireHours > 0 ? "Fire weather parameters met." : ""} 
            ${totalRain > 2.0 ? "Soil saturation and drainage issues possible." : ""}
            ${freezeHours > 0 ? `Freeze window: ${freezeHours} hours.` : ""}`;
        } else if (freezeHours > 0) {
            cardClass = "yellow";
            narrative = `<strong>NUISANCE FREEZE:</strong> ${freezeHours} hours of sub-freezing temps expected (Low: ${minTemp}¬∞F). Protect sensitive plants/hoses.`;
        }

        outEl.innerHTML = `<div class="card ${cardClass}"><span class="label">Operational Outlook</span><p>${narrative}</p></div>`;

    } catch (err) {
        console.error(err);
        document.getElementById('severity-text').innerText = "DATA SYNC ERROR";
    }
}

// Init
checkDashboard();
updateTimer = setInterval(checkDashboard, 600000); // 10 mins
</script>
</body>
</html>
