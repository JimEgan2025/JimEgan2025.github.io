<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overnight & Tomorrow - Vizcaya Weather</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',system-ui,-apple-system,sans-serif; background:#f0f2f5; padding:20px; color:#1f2937; }
        .container { max-width:1900px; margin:0 auto; background:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); overflow:hidden; }
        .header { background:#1e3a8a; color:white; padding:25px; text-align:center; }
        .header h1 { font-size:2.2em; margin-bottom:5px; }
        .table-wrapper { overflow-x:auto; padding:15px; }
        table { width:100%; border-collapse:collapse; font-size:13px; }
        th { background:#1e3a8a; color:white; padding:10px 4px; font-weight:600; text-align:center; border:1px solid #162e70; min-width:75px; }
        td { padding:10px 6px; border:1px solid #e2e8f0; text-align:center; vertical-align:middle; }
        .param-name { text-align:left; font-weight:700; background:#f8fafc; min-width:180px; padding-left:15px; color:#1e3a8a; position:sticky; left:0; z-index:10; }
        .param-label { font-size:10px; color:#64748b; font-weight:400; display:block; }
        .hour-col { font-weight:800; color:white; font-size:14px; }
        .time-label { font-size:11px; color:#e0e7ff; font-weight:400; }
        tr:nth-child(even) { background:#fdfdfd; }
        tr:hover { background:#f1f5f9; }
        .temp { font-weight:700; font-size:15px; }
        .temp-high { color:#dc2626; }
        .temp-low { color:#1d4ed8; }
        .temp-mid { color:#f59e0b; }
        .current-hour { background:#fef3c7 !important; border:2px solid #f59e0b; }
        .gust-high { color:#dc2626; font-weight:700; }
        .gust-normal { color:#374151; }
        .precip-high { color:#1e40af; font-weight:700; }
        .precip-low { color:#6b7280; }
        .sev-none { color:#10b981; font-weight:600; }
        .sev-low { color:#f59e0b; font-weight:700; }
        .sev-mod { color:#ef4444; font-weight:800; }
        .sev-high { color:#b91c1c; font-weight:900; background:#fee2e2; }
        .info-footer { padding:15px 25px; background:#f8fafc; border-top:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#64748b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="mainTitle">Overnight & Tomorrow Morning</h1>
            <p id="updateTime"></p>
        </div>
        <div class="table-wrapper">
            <table id="forecastTable">
                <thead>
                    <tr id="headerRow">
                        <th style="text-align:left; padding-left:15px;">Hour/Time</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="info-footer">
            <span>Location: Vizcaya, Round Rock, TX | Source: Open-Meteo GFS</span>
            <span id="lastUpdate"></span>
        </div>
    </div>
    <script>
        const LAT = 30.509747, LON = -97.692116;

        function getWeatherDesc(weatherCode, precipProb) {
            const codes = {
                0: 'Clear', 1: 'Mostly clear', 2: 'Partly cloudy', 3: 'Cloudy',
                45: 'Foggy', 48: 'Foggy', 51: 'Light drizzle', 53: 'Drizzle', 55: 'Heavy drizzle',
                61: 'Light rain', 63: 'Rain', 65: 'Heavy rain',
                71: 'Light snow', 73: 'Snow', 75: 'Heavy snow',
                80: 'Rain showers', 81: 'Rain showers', 82: 'Heavy rain showers',
                95: 'Thunderstorm', 96: 'Thunderstorm w/ hail', 99: 'Severe thunderstorm'
            };
            const desc = codes[weatherCode] || 'Unknown';
            return precipProb > 30 ? `${desc} (${precipProb}%)` : desc;
        }

        function getWindDirection(degrees) {
            const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
            return dirs[Math.round(degrees / 22.5) % 16];
        }

        function getSeverity(cape, li) {
            if (cape >= 3000 || li <= -9) return { text: 'EXTREME', cls: 'sev-high', val: cape };
            if (cape >= 2000 || li <= -6) return { text: 'HIGH', cls: 'sev-high', val: cape };
            if (cape >= 1000 || li <= -4) return { text: 'MODERATE', cls: 'sev-mod', val: cape };
            if (cape >= 300 || li <= -2) return { text: 'LOW', cls: 'sev-low', val: cape };
            return { text: 'NONE', cls: 'sev-none', val: cape };
        }

        async function init() {
            try {
                // Use Open-Meteo GFS API which includes CAPE and Lifted Index
                const url = `https://api.open-meteo.com/v1/gfs?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,apparent_temperature,precipitation,precipitation_probability,weather_code,wind_speed_10m,wind_gusts_10m,wind_direction_10m,relative_humidity_2m,cape,lifted_index&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America/Chicago&forecast_days=2`;

                const res = await fetch(url);
                if (!res.ok) throw new Error('API error: ' + res.status);
                const data = await res.json();

                const { hourly } = data;
                const now = new Date();
                const currentHourStart = new Date(now.setMinutes(0,0,0));
                
                // Target: Start now, end at 9 AM tomorrow
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const endHour = new Date(tomorrow.setHours(9,0,0,0));

                const hours = [];
                hourly.time.forEach((t, i) => {
                    const hTime = new Date(t);
                    if (hTime >= currentHourStart && hTime <= endHour) {
                        hours.push({ index: i, time: hTime });
                    }
                });

                const headerRow = document.getElementById('headerRow');
                hours.forEach(h => {
                    const th = document.createElement('th');
                    const timeStr = h.time.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                    const dayStr = h.time.toLocaleDateString('en-US', { weekday: 'short' });
                    th.innerHTML = `<div class="hour-col">${timeStr}</div><div class="time-label">${dayStr}</div>`;
                    headerRow.appendChild(th);
                });

                const allTemps = hours.map(h => Math.round(hourly.temperature_2m[h.index]));
                const maxT = Math.max(...allTemps);
                const minT = Math.min(...allTemps);
                const midT = (maxT + minT) / 2;

                const rows = [
                    {
                        name: 'Severe Potential',
                        label: 'CAPE / Lifted Index',
                        getData: i => {
                            const cape = Math.round(hourly.cape[hours[i].index]);
                            const li = hourly.lifted_index[hours[i].index].toFixed(1);
                            const sev = getSeverity(cape, hourly.lifted_index[hours[i].index]);
                            return `<div class="${sev.cls}">${sev.text}</div><span style="font-size:10px">${cape} / ${li}</span>`;
                        }
                    },
                    {
                        name: 'Conditions',
                        label: 'Sky / Precipitation',
                        getData: i => getWeatherDesc(hourly.weather_code[hours[i].index], hourly.precipitation_probability[hours[i].index])
                    },
                    {
                        name: 'Temperature',
                        label: '째F',
                        getData: i => {
                            const t = Math.round(hourly.temperature_2m[hours[i].index]);
                            let cls = 'temp-mid';
                            if (t >= midT + 3) cls = 'temp-high';
                            if (t <= midT - 3) cls = 'temp-low';
                            return `<span class="temp ${cls}">${t}째</span>`;
                        }
                    },
                    {
                        name: 'Feels Like',
                        label: '째F',
                        getData: i => `${Math.round(hourly.apparent_temperature[hours[i].index])}째`
                    },
                    {
                        name: 'Precipitation',
                        label: 'Prob / Amount',
                        getData: i => `${hourly.precipitation_probability[hours[i].index]}% / ${hourly.precipitation[hours[i].index].toFixed(2)}"`
                    },
                    {
                        name: 'Winds',
                        label: 'Dir / Speed / Gust',
                        getData: i => {
                            const dir = getWindDirection(hourly.wind_direction_10m[hours[i].index]);
                            const speed = Math.round(hourly.wind_speed_10m[hours[i].index]);
                            const gust = Math.round(hourly.wind_gusts_10m[hours[i].index]);
                            const gustClass = gust > 25 ? 'gust-high' : 'gust-normal';
                            return `${dir} ${speed} / <span class="${gustClass}">G${gust}</span>`;
                        }
                    },
                    {
                        name: 'Humidity',
                        label: '%',
                        getData: i => `${Math.round(hourly.relative_humidity_2m[hours[i].index])}%`
                    }
                ];

                const tbody = document.getElementById('tableBody');
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.className = 'param-name';
                    td.innerHTML = `<div>${row.name}</div><span class="param-label">${row.label}</span>`;
                    tr.appendChild(td);
                    for (let i = 0; i < hours.length; i++) {
                        const tc = document.createElement('td');
                        tc.innerHTML = row.getData(i);
                        tr.appendChild(tc);
                    }
                    tbody.appendChild(tr);
                });

                document.getElementById('updateTime').textContent = new Date().toLocaleString([], { weekday: 'long', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                document.getElementById('lastUpdate').textContent = 'Last fetch (GFS): ' + new Date().toLocaleTimeString();
            } catch (err) {
                console.error(err);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="20" style="color:red; padding:20px;">Error: ${err.message}</td></tr>`;
            }
        }

        init();
    </script>
</body>
</html>
