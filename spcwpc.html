<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central TX Weather Dash</title>
    <style>
        :root { --danger: #d73a49; --bg: #f6f8fa; }
        
        /* Body is now fully scrollable naturally */
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #24292e; line-height: 1.5; }
        
        /* Grids use 'auto' rows so they expand to fit the images */
        .grid, .map-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; align-items: start; }
        
        .panel { background: white; border: 1px solid #d1d5da; border-radius: 8px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .panel h2 { margin: 0 0 10px 0; font-size: 0.85rem; border-bottom: 1px solid #eee; padding-bottom: 6px; text-transform: uppercase; color: #586069; font-weight: 600; }
        
        /* Map Windows: No fixed height, no scrollbars */
        .map-container { width: 100%; height: auto; display: block; overflow: hidden; border-radius: 4px; border: 1px solid #f0f0f0; }

        /* Images expand to fill the width and set the height of the container */
        .outlook-img { width: 100%; height: auto; display: block; }
        
        .risk-card { padding: 8px; margin-top: 5px; border-radius: 4px; font-weight: bold; text-align: center; font-size: 0.8rem; border: 1px solid rgba(0,0,0,0.05); }
        .risk-NONE { background: #f0f0f0; color: #999; border-style: dashed; }
        .risk-TSTM { background: #cce5ff; color: #004085; }
        .risk-MRGL { background: #c2e0c6; color: #1e4620; }
        .risk-SLGT { background: #fef2c0; color: #735c0f; }
        
        .active-alert { border-left: 4px solid var(--danger); padding: 8px; margin-bottom: 6px; background: #fff5f5; font-size: 0.8rem; font-weight: bold; }

        /* Radar remains large at bottom */
        .radar-panel { height: 700px; grid-column: span 3; }
        iframe { width: 100%; height: 100%; border: none; border-radius: 8px; }

        @media (max-width: 1100px) { .grid, .map-grid { grid-template-columns: 1fr; } .radar-panel { grid-column: span 1; } }
    </style>
</head>
<body>

    <h2 style="margin:0 0 20px 0; font-size: 1.3rem;">Central Texas Situation Room | <span id="timestamp" style="color:var(--danger)">Syncing...</span></h2>

    <div class="grid">
        <div class="panel"><h2>‚ö†Ô∏è Active Alerts</h2><div id="nws-box">Checking...</div></div>
        <div class="panel">
            <h2>üå™Ô∏è SPC Severe Risk</h2>
            <div id="spc-1" class="risk-card">Day 1: ...</div>
            <div id="spc-2" class="risk-card">Day 2: ...</div>
            <div id="spc-3" class="risk-card">Day 3: ...</div>
        </div>
        <div class="panel">
            <h2>üåßÔ∏è WPC Flood Risk</h2>
            <div id="wpc-1" class="risk-card">Day 1: ...</div>
            <div id="wpc-2" class="risk-card">Day 2: ...</div>
            <div id="wpc-3" class="risk-card">Day 3: ...</div>
        </div>
    </div>

    <div class="map-grid">
        <div class="panel"><h2>SPC Day 1 (EWX)</h2><div class="map-container"><img class="outlook-img" src="https://www.spc.noaa.gov/partners/outlooks/cwa/images/EWX_swody1.png"></div></div>
        <div class="panel"><h2>SPC Day 2 (EWX)</h2><div class="map-container"><img class="outlook-img" src="https://www.spc.noaa.gov/partners/outlooks/cwa/images/EWX_swody2.png"></div></div>
        <div class="panel"><h2>SPC Day 3 (EWX)</h2><div class="map-container"><img class="outlook-img" src="https://www.spc.noaa.gov/partners/outlooks/cwa/images/EWX_swody3.png"></div></div>
    </div>

    <div class="map-grid">
        <div class="panel"><h2>WPC Day 1 Flood</h2><div class="map-container"><img class="outlook-img" src="https://www.wpc.ncep.noaa.gov/qpf/94ewbg.gif"></div></div>
        <div class="panel"><h2>WPC Day 2 Flood</h2><div class="map-container"><img class="outlook-img" src="https://www.wpc.ncep.noaa.gov/qpf/98ewbg.gif"></div></div>
        <div class="panel"><h2>WPC Day 3 Flood</h2><div class="map-container"><img class="outlook-img" src="https://www.wpc.ncep.noaa.gov/qpf/99ewbg.gif"></div></div>
    </div>

    <div class="panel radar-panel">
        <iframe src="https://embed.windy.com/embed2.html?lat=30.508&lon=-97.679&zoom=8&level=surface&overlay=radar&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1"></iframe>
    </div>

    <script>
        const lat = 30.5083, lon = -97.6789;
        async function update() {
            document.getElementById('timestamp').innerText = new Date().toLocaleTimeString();
            try {
                const nRes = await fetch(`https://api.weather.gov/alerts/active?point=${lat},${lon}`);
                const nData = await nRes.json();
                document.getElementById('nws-box').innerHTML = nData.features?.length 
                    ? nData.features.map(f => `<div class="active-alert">${f.properties.event}</div>`).join('') 
                    : "<div style='color:#888; text-align:center; padding:15px;'>No Active Hazards</div>";
            } catch (e) {}

            const paths = [
                ["outlooks/SPC_wx_outlks/MapServer/1", "spc-1"],
                ["outlooks/SPC_wx_outlks/MapServer/9", "spc-2"],
                ["outlooks/SPC_wx_outlks/MapServer/17", "spc-3"],
                ["hazards/wpc_precip_hazards/MapServer/0", "wpc-1"],
                ["hazards/wpc_precip_hazards/MapServer/1", "wpc-2"],
                ["hazards/wpc_precip_hazards/MapServer/2", "wpc-3"]
            ];
            paths.forEach(p => fetchRisk(p[0], p[1]));
        }

        async function fetchRisk(path, elId) {
            const url = `https://mapservices.weather.noaa.gov/vector/rest/services/${path}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=*&f=pjson`;
            try {
                const r = await fetch(url);
                const d = await r.json();
                let risk = "NONE";
                if (d.features?.length > 0) {
                    const a = d.features[0].attributes;
                    risk = a.LABEL2 || a.LABEL || a.VALUE || "NONE";
                }
                const clean = parseRisk(risk);
                const el = document.getElementById(elId);
                el.innerText = `Day ${elId.split('-')[1]}: ${clean}`;
                el.className = `risk-card risk-${clean}`;
            } catch (e) {}
        }

        function parseRisk(t) {
            t = String(t).toUpperCase();
            if (t.includes("MRGL") || t.includes("MARGINAL")) return "MRGL";
            if (t.includes("SLGT") || t.includes("SLIGHT")) return "SLGT";
            if (t.includes("TSTM") || t.includes("GEN")) return "TSTM";
            return "NONE";
        }
        update();
        setInterval(update, 600000); 
    </script>
</body>
</html>
