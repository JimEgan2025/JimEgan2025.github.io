<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TX Weather Command | Full Operational Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; display:flex; font-family:'Segoe UI',sans-serif; background:#000; color:#e0e0e0; height:100vh; overflow:hidden; }
#sidebar,#right-panel{width:330px;padding:15px;background:#121212;z-index:2000;overflow-y:auto;display:flex;flex-direction:column;}
#sidebar{border-right:1px solid #333;}
#right-panel{border-left:1px solid #333;}
#map{flex:1;height:100vh !important;background:#050505;position:relative;z-index:1;}
header{background:#1a1a1a;padding:10px 20px;border-bottom:2px solid #ffcc00;display:flex;justify-content:space-between;align-items:center;position:absolute;top:0;left:330px;right:330px;z-index:3000;height:40px;}
h1{margin:0;font-size:0.9rem;color:#ffcc00;text-transform:uppercase;letter-spacing:1px;}
h3{font-size:0.7rem;text-transform:uppercase;color:#ffcc00;margin:15px 0 8px;border-bottom:1px solid #333;padding-bottom:3px;}
label{display:flex;align-items:center;margin:5px 0;cursor:pointer;font-size:0.8rem;}
input[type="checkbox"]{margin-right:10px;accent-color:#ffcc00;}
.alert-card{background:#1a1a1a;border-left:4px solid #ffcc00;padding:10px;margin-bottom:10px;font-size:0.75rem;border:1px solid #222;border-radius:4px;cursor:pointer;}
.alert-card.Extreme{border-left-color:#ff0000;background:#2a1010;}
.alert-card.Severe{border-left-color:#ff6600;background:#2a1a00;}
.alert-card.Moderate{border-left-color:#ffcc00;background:#2a2500;}
.alert-card.Minor{border-left-color:#00ccff;background:#001f2a;}
.alert-title{font-weight:bold;color:#fff;display:block;font-size:0.9rem;margin-bottom:4px;}
.alert-office{color:#ffcc00;font-weight:bold;font-size:0.8rem;margin-bottom:4px;}
.alert-area{color:#ccc;display:block;margin-bottom:4px;}
.alert-meta{color:#aaa;font-size:0.7rem;}
.alert-details{color:#aaa;font-size:0.7rem;margin-top:5px;display:none;}
</style>
</head>
<body>
<header>
<h1>TX Weather Command</h1>
<div id="as-of" style="font-size:0.75rem;color:#888;">Initializing...</div>
</header>
<div id="sidebar">
<div style="margin-top:50px;"></div>
<h2>Map Layers</h2>
<h3>Geography (Contrast)</h3>
<label><input type="checkbox" id="borders" checked> White County/State Lines & Labels</label>
<h3>Live Data</h3>
<label><input type="checkbox" id="radar" checked> NEXRAD Radar</label>
<label><input type="checkbox" id="wwa" checked> Hazards (WWA)</label>
<label><input type="checkbox" id="sat"> GOES Satellite</label>
<h3>Outlooks (Lead 1-3)</h3>
<label><input type="checkbox" id="spc1" checked> SPC Day 1 Severe</label>
<label><input type="checkbox" id="spc2"> SPC Day 2 Severe</label>
<label><input type="checkbox" id="spc3"> SPC Day 3 Severe</label>
<label><input type="checkbox" id="ero1" checked> WPC Day 1 Flood (ERO)</label>
<label><input type="checkbox" id="ero2"> WPC Day 2 Flood (ERO)</label>
<label><input type="checkbox" id="ero3"> WPC Day 3 Flood (ERO)</label>
<h3>Discussions</h3>
<label><input type="checkbox" id="meso"> Mesoscale Discussions (SPC)</label>
</div>
<div id="map"></div>
<div id="right-panel">
<div style="margin-top:50px;"></div>
<h2>Live TX Alerts</h2>
<div id="alert-list"></div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>
<script>
const map=L.map('map',{zoomControl:false,fadeAnimation:false}).setView([31.5,-99.5],6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OpenStreetMap &copy; CARTO'}).addTo(map);

// Layers
const layers={
  borders:L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{opacity:1,zIndex:1500,minZoom:4,maxZoom:20}).addTo(map),
  radar:L.layerGroup(),
  wwa:L.esri.featureLayer({
    url:'https://mapservices.weather.noaa.gov/eventdriven/rest/services/WWA/watch_warn_adv/MapServer/1',
    where:'1=1',
    style: function(f){const e=f.properties.event.toLowerCase();if(e.includes('tornado')) return {color:'#ff0000',fillColor:'#ff0000',fillOpacity:0.25,weight:2};if(e.includes('severe thunderstorm')) return {color:'#ff6600',fillColor:'#ff6600',fillOpacity:0.2,weight:2};if(e.includes('flood')||e.includes('flash flood')) return {color:'#00aaff',fillColor:'#00aaff',fillOpacity:0.2,weight:2};return {color:'#ffff00',fillColor:'#ffff00',fillOpacity:0.15,weight:1};}
  }),
  sat:L.tileLayer.wms('https://mesonet.agron.iastate.edu/cgi-bin/wms/goes/conus_ir.cgi',{layers:'conus_ir_4km',format:'image/png',transparent:true,opacity:0.45,zIndex:5,bounds:[[24,-125],[50,-66]]}),
  spc1:L.esri.dynamicMapLayer({url:'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer',layers:[1],opacity:0.6}),
  spc2:L.esri.dynamicMapLayer({url:'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer',layers:[9],opacity:0.6}),
  spc3:L.esri.dynamicMapLayer({url:'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer',layers:[17],opacity:0.6}),
  ero1:L.esri.dynamicMapLayer({url:'https://mapservices.weather.noaa.gov/vector/rest/services/hazards/wpc_precip_hazards/MapServer',layers:[0],opacity:0.4}),
  ero2:L.esri.dynamicMapLayer({url:'https://mapservices.weather.noaa.gov/vector/rest/services/hazards/wpc_precip_hazards/MapServer',layers:[1],opacity:0.4}),
  ero3:L.esri.dynamicMapLayer({url:'https://mapservices.weather.noaa.gov/vector/rest/services/hazards/wpc_precip_hazards/MapServer',layers:[2],opacity:0.4}),
  meso:L.layerGroup()
};

// Radar loop
const radarFrames=[];
for(let i=0;i<5;i++){
  const frame=L.tileLayer.wms('https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi',{layers:'nexrad-n0r-900913',format:'image/png',transparent:true,opacity:0});
  radarFrames.push(frame);
  layers.radar.addLayer(frame);
}
let currentFrame=0;
function advanceRadar(){
  radarFrames.forEach(l=>l.setOpacity(0));
  radarFrames[currentFrame].setOpacity(0.7);
  currentFrame=(currentFrame+1)%radarFrames.length;
}
setInterval(advanceRadar,1000);
advanceRadar();

// Layer toggles
Object.keys(layers).forEach(id=>{
  const el=document.getElementById(id);
  if(el){
    el.onchange=()=>{
      if(el.checked){
        layers[id].addTo(map);
      } else {
        map.removeLayer(layers[id]);
      }
    };
  }
});

// Alerts
async function updateAlerts(){
try{
  const res=await fetch('https://api.weather.gov/alerts/active?area=TX',{headers:{'User-Agent':'TXWeatherCommand'}});
  if(!res.ok)throw new Error('API response not OK');
  const data=await res.json();
  const list=document.getElementById('alert-list');
  document.getElementById('as-of').innerText='Last Sync: '+new Date().toLocaleTimeString('en-US',{timeZone:'America/Chicago'});
  if(!data.features?.length){list.innerHTML='<div style="color:#666;text-align:center;padding:20px;">No active alerts in Texas right now.</div>';return;}
  list.innerHTML='';
  data.features.slice(0,10).forEach(a=>{
    const p=a.properties;
    const sev=p.severity||'Unknown';
    const office=p.senderName||'NWS (Unknown)';
    const exp=p.expires?p.expires:new Date();
    const card=document.createElement('div');
    card.className=`alert-card ${sev}`;
    card.innerHTML=`<span class="alert-title">${p.event||'Alert'}</span><span class="alert-office">Issued by: ${office}</span><span class="alert-area">${p.areaDesc||'Various areas'}</span><div class="alert-meta">${sev} â€¢ Expires: ${exp}</div><div class="alert-details">${p.description||''}<br>${p.instruction||''}</div>`;
    card.onclick=()=>{const d=card.querySelector('.alert-details');d.style.display=(d.style.display==='none'?'block':'none');};
    list.appendChild(card);
  });
}catch(e){console.error(e);document.getElementById('alert-list').innerHTML='<div style="color:#ff6666;text-align:center;padding:20px;">Failed to load alerts.</div>'}}
updateAlerts();
setInterval(updateAlerts,300000);

// Mesoscale Discussions
async function updateMesoscale(){
try{
  const res=await fetch('https://www.spc.noaa.gov/exper/meso/active_md.json');
  if(!res.ok)throw new Error('MD feed error');
  const data=await res.json();
  layers.meso.clearLayers();
  data.features.forEach(md=>{
    if(!md.properties?.states?.includes('TX'))return;
    const geom=md.geometry;
    if(!geom)return;
    if(geom.type==='Polygon'){
      const poly=L.polygon(geom.coordinates,{color:'#ff00ff',weight:2,fillOpacity:0.1});
      poly.bindPopup(`<b>MD #${md.properties.md_num}</b><br><b>Issued:</b> ${md.properties.issue_time}<br><b>Type:</b> ${md.properties.type}<br><b>Synopsis:</b> ${md.properties.synopsis||'N/A'}`);
      layers.meso.addLayer(poly);
    } else if(geom.type==='MultiPolygon'){
      geom.coordinates.forEach(polygon=>{
        const poly=L.polygon(polygon,{color:'#ff00ff',weight:2,fillOpacity:0.1});
        poly.bindPopup(`<b>MD #${md.properties.md_num}</b><br><b>Issued:</b> ${md.properties.issue_time}<br><b>Type:</b> ${md.properties.type}<br><b>Synopsis:</b> ${md.properties.synopsis||'N/A'}`);
        layers.meso.addLayer(poly);
      });
    }
  });
  if(document.getElementById('meso').checked)layers.meso.addTo(map);
}catch(e){console.error('Mesoscale fetch error:',e);}}
updateMesoscale();
setInterval(updateMesoscale,300000);
</script>
</body>
</html>
