<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Station Monitor - Master Control v10</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; background: #111; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Popup & UI Styling */
        .alert-header { color: #d32f2f; font-weight: bold; border-bottom: 2px solid #eee; margin-bottom: 5px; text-transform: uppercase; }
        .time-label { font-weight: bold; color: #555; font-size: 11px; }
        .desc-text { background: #f4f4f4; padding: 10px; border-radius: 4px; margin-top: 10px; font-style: italic; font-size: 12px; border-left: 4px solid #FFD700; color: #222; max-height: 200px; overflow-y: auto; }
        
        .ui-panel { background: rgba(30,30,30,0.9); color: white; padding: 12px; border-radius: 8px; width: 190px; font-size: 11px; border: 1px solid #444; }
        input[type=range] { width: 100%; accent-color: #0f0; cursor: pointer; }
        button { width: 100%; background: #444; color: #FFD700; border: 1px solid #666; padding: 6px; cursor: pointer; margin-top: 8px; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    var stationPos = [30.5871, -97.641];
    var map = L.map('map').setView(stationPos, 6);

    // 1. BASE MAP (Bottom Layer)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png').addTo(map);

    // 2. STATE OUTLINES (Added as a non-blocking layer)
    var stateBorders = L.layerGroup().addTo(map);
    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
        .then(res => res.json())
        .then(data => {
            L.geoJson(data, {
                style: { color: "#ffffff", weight: 1, opacity: 0.4, fill: false, interactive: false } 
            }).addTo(stateBorders);
        });

    // 3. WEATHER LAYERS
    var radar = L.tileLayer.wms('https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows', { 
        layers: 'conus_bref_qcd', format: 'image/png', transparent: true, opacity: 0.7 
    }).addTo(map);

    var fireRisk = L.tileLayer.wms('https://mapservices.weather.noaa.gov/vector/services/fire_weather/SPC_firewx/MapServer/WMSServer', { 
        layers: '1', format: 'image/png', transparent: true, opacity: 0.5 
    }).addTo(map);

    var warnings = L.tileLayer.wms('https://mapservices.weather.noaa.gov/eventdriven/services/WWA/watch_warn_adv/MapServer/WMSServer', { 
        layers: '0', format: 'image/png', transparent: true, opacity: 0.5 
    }).addTo(map);

    // 4. RANGE RINGS
    var rings = L.layerGroup().addTo(map);
    [100, 200, 300, 400].forEach(d => {
        L.circle(stationPos, { radius: d * 1609.34, color: '#00FFFF', weight: 1, fill: false, dashArray: '5,10', interactive: false }).addTo(rings);
    });

    // 5. CITY LABELS (Force to Top)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { zIndex: 1000 }).addTo(map);

    // 6. STATION MARKER
    var goldDot = L.circleMarker(stationPos, { radius: 12, fillColor: "#FFD700", color: "#fff", weight: 3, fillOpacity: 1, zIndexOffset: 2000 }).addTo(map);
    goldDot.bindPopup("<b>Round Rock Station</b>");

    // 7. TOGGLE CONTROLS (Top Right)
    var overlays = {
        "üì° Radar": radar,
        "üî• Fire Risk": fireRisk,
        "‚ö†Ô∏è Warnings": warnings,
        "üó∫Ô∏è State Borders": stateBorders,
        "‚≠ï Range Rings": rings
    };
    L.control.layers(null, overlays, { collapsed: false, position: 'topright' }).addTo(map);

    // 8. INTENSITY & TOOLS (Bottom Right)
    var ui = L.control({position: 'bottomright'});
    ui.onAdd = function() {
        var div = L.DomUtil.create('div', 'ui-panel');
        div.innerHTML = `
            <div style="font-weight:bold; color:#FFD700; margin-bottom:5px;">STATION TOOLS</div>
            <label>RADAR INTENSITY</label>
            <input type="range" min="0" max="1" step="0.1" value="0.7" id="opac">
            <button onclick="map.setView([35.2, -101.8], 6)">üî≠ GOTO RED FLAG</button>
            <button onclick="location.reload()">üîÑ FULL REBOOT</button>
        `;
        L.DomEvent.disableClickPropagation(div);
        return div;
    };
    ui.addTo(map);

    document.addEventListener('input', function(e) {
        if(e.target.id === 'opac') radar.setOpacity(e.target.value);
    });

    // 9. CLICK INTELLIGENCE (Restored & Fixed)
    map.on('click', function(e) {
        var popup = L.popup().setLatLng(e.latlng).setContent("Querying NWS Database...").openOn(map);
        fetch(`https://api.weather.gov/alerts/active?point=${e.latlng.lat.toFixed(4)},${e.latlng.lng.toFixed(4)}`)
            .then(res => res.json())
            .then(data => {
                if (data.features && data.features.length > 0) {
                    const alert = data.features[0].properties;
                    const onset = new Date(alert.onset).toLocaleString();
                    const expires = new Date(alert.ends || alert.expires).toLocaleString();
                    popup.setContent(`
                        <div class="alert-header">${alert.event}</div>
                        <span class="time-label">STARTS:</span> ${onset}<br>
                        <span class="time-label">EXPIRES:</span> ${expires}<br>
                        <div class="desc-text">${alert.description || "No full text provided."}</div>
                    `);
                } else { popup.setContent("No active warnings at this location."); }
            })
            .catch(() => popup.setContent("API Error. Check connection."));
    });

</script>
</body>
</html>
