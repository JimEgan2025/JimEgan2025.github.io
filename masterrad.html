<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas Radar Pro: Interactive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background-color: #222; }
        #map { height: 100vh; width: 100%; cursor: crosshair; }
        
        /* Legend Styling */
        .info-legend {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 11px;
            max-width: 160px;
            border: 1px solid #444;
        }
        .legend-title { font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 3px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 2px; }
        .swatch { width: 14px; height: 14px; margin-right: 8px; border: 1px solid #555; opacity: 0.8; }
        
        /* Standard Warning Colors */
        .tornado-warn { background: #FF0000; } 
        .svr-warn     { background: #FFA500; } 
        .flood-warn   { background: #00FF00; } 
        .fire-warn    { background: #FF1493; } 
        .wind-adv     { background: #D2B48C; } 
        .tornado-watch{ background: #FFFF00; } 
        .svr-watch    { background: #DB7093; } 
        
        /* Popup Styling */
        .leaflet-popup-content-wrapper { background: #333; color: #fff; font-family: Arial, sans-serif; }
        .leaflet-popup-tip { background: #333; }
        .leaflet-popup-content h3 { margin: 0 0 5px 0; font-size: 14px; color: #FFD700; border-bottom: 1px solid #555; }
        .leaflet-popup-content p { margin: 5px 0; font-size: 12px; }
        
        /* Force labels to be on top */
        .leaflet-pane.leaflet-labels-pane { z-index: 650; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Setup Map
        var map = L.map('map').setView([31.5, -99.5], 6); 

        // 2. Base Layer
        var darkBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // 3. Radar Layer
        var radarLayer = L.tileLayer.wms('https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows', {
            layers: 'conus_bref_qcd',
            format: 'image/png',
            transparent: true,
            opacity: 0.8 
        }).addTo(map);

        // 4. Warnings Layer (Visuals Only)
        var warningsLayer = L.tileLayer.wms('https://mapservices.weather.noaa.gov/eventdriven/services/WWA/watch_warn_adv/MapServer/WMSServer', {
            layers: '0', 
            format: 'image/png',
            transparent: true,
            opacity: 0.6
        }).addTo(map);

        // 5. City Labels
        map.createPane('labels');
        map.getPane('labels').style.zIndex = 650;
        map.getPane('labels').style.pointerEvents = 'none';
        var darkLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
            attribution: '',
            subdomains: 'abcd',
            pane: 'labels' 
        }).addTo(map);

        // 6. Layer Control
        var overlayMaps = { "Radar": radarLayer, "Warnings": warningsLayer, "Cities": darkLabels };
        L.control.layers(null, overlayMaps, {collapsed: false}).addTo(map);

        // 7. CLICK LISTENER (Using NWS API)
        map.on('click', function(e) {
            // Show a "Loading..." popup immediately
            var popup = L.popup()
                .setLatLng(e.latlng)
                .setContent('<p>Checking NWS Database...</p>')
                .openOn(map);

            // Construct API URL
            // Docs: https://www.weather.gov/documentation/services-web-api
            var lat = e.latlng.lat.toFixed(4);
            var lon = e.latlng.lng.toFixed(4);
            var url = `https://api.weather.gov/alerts/active?point=${lat},${lon}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        // We found alerts! Build the HTML.
                        var content = "";
                        data.features.forEach(function(alert) {
                            var props = alert.properties;
                            content += `<h3>${props.event}</h3>`;
                            content += `<p><b>Ends:</b> ${new Date(props.ends).toLocaleTimeString()}</p>`;
                            content += `<p><b>Severity:</b> ${props.severity}</p>`;
                            // Show first 150 characters of description
                            var desc = props.description ? props.description.substring(0, 150) + "..." : "No details.";
                            content += `<p style="color:#aaa;">${desc}</p>`;
                            content += `<hr style="border:0; border-top:1px solid #555;">`;
                        });
                        popup.setContent(content);
                    } else {
                        // No alerts at this location
                        popup.setContent('<p>No Active Alerts here.</p>');
                    }
                })
                .catch(err => {
                    console.error(err);
                    popup.setContent('<p>Error connecting to NWS.</p>');
                });
        });

        // 8. Legend
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info-legend');
            div.innerHTML = `
                <div class="legend-title">Active Alerts</div>
                <div class="legend-item"><div class="swatch tornado-warn"></div>Tornado Warn</div>
                <div class="legend-item"><div class="swatch svr-warn"></div>Severe Thunderstorm</div>
                <div class="legend-item"><div class="swatch flood-warn"></div>Flash Flood</div>
                <div class="legend-item"><div class="swatch fire-warn"></div>Red Flag / Fire</div>
                <div class="legend-item"><div class="swatch wind-adv"></div>Wind Advisory</div>
                <div style="margin-top:5px; border-top:1px solid #555; padding-top:3px;">
                <div class="legend-item"><div class="swatch tornado-watch"></div>Tornado Watch</div>
                <div class="legend-item"><div class="swatch svr-watch"></div>Severe Watch</div>
                </div>
                <div style="margin-top:5px; font-size:9px; color:#aaa;">Click map for details</div>
            `;
            return div;
        };
        legend.addTo(map);

        // 9. Auto Refresh
        setInterval(function() {
            var t = new Date().getTime();
            radarLayer.setParams({t: t});
            warningsLayer.setParams({t: t});
        }, 300000);

    </script>
</body>
</html>
