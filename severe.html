<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vizcaya Risk Engine | Full Operational Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: #020617;
  color: #e5e7eb;
  padding: 15px;
  max-width: 1100px;
  margin: auto;
}
h1, h2 { text-align: center; margin-bottom: 15px; color: #f8fafc; letter-spacing: -1px; }
.card {
  background: #111827;
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 24px rgba(0,0,0,.5);
  border-left: 6px solid #1e293b;
}
.safe { border-left-color: #16a34a; }
.yellow{ border-left-color: #eab308; }
.orange{ border-left-color: #f97316; }
.red { border-left-color: #dc2626; }

.label {
  font-weight: bold;
  color: #93c5fd;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 0.8rem;
  margin-bottom: 8px;
  display: block;
}

/* 7-column day grid */
#timeline-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-top: 10px;
}

.timeline-day {
  background: #0a0f1d;
  border: 1px solid #374151;
  border-radius: 8px;
  padding: 8px 4px;
  display: flex;
  flex-direction: column;
  min-height: 240px; /* Increased to fit 8 rows */
}

.timeline-day-label {
  text-align: center;
  font-size: 11px;
  color: #f8fafc;
  margin-bottom: 6px;
  font-weight: 800;
  border-bottom: 1px solid #1e293b;
  padding-bottom: 4px;
}

.timeline-hazard-row {
  display: flex;
  align-items: center;
  margin: 1.5px 0;
}

.timeline-hazard-name {
  width: 55px;
  font-size: 8px;
  color: #94a3b8;
  text-align: right;
  padding-right: 4px;
  flex-shrink: 0;
}

.timeline-hazard-bar {
  flex: 1;
  height: 9px;
  border-radius: 3px;
  background: rgba(255,255,255,0.03);
}

/* Severity index bar */
#severity-index {
  height:40px;
  border-radius:10px;
  margin-bottom:20px;
  background:#1e293b;
  position:relative;
  overflow:hidden;
  border: 1px solid #334155;
}
#severity-bar {
  height:100%;
  width:0%;
  background:#16a34a;
  transition:width 2s ease-in-out;
}
#severity-text {
  position:absolute;
  width:100%;
  text-align:center;
  top:0;
  color:#fff;
  line-height:40px;
  font-weight:bold;
  font-size: 1.2rem;
  text-shadow: 1px 1px 4px #000;
}

.alert-card {
  background:#7f1d1d;
  padding:15px;
  border-radius:8px;
  margin-bottom:10px;
  color:#fff;
  border-left: 8px solid #ef4444;
}

.severe-panel-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.severe-row {
  display:flex;
  justify-content:space-between;
  padding:10px 12px;
  border-radius:6px;
  font-size: 0.85rem;
}
.severe-low { background: rgba(22, 163, 74, 0.1); border: 1px solid rgba(22, 163, 74, 0.3); }
.severe-mod { background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); }
.severe-high{ background: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.3); }

#output p { margin: 0; line-height: 1.5; font-size: 0.95rem; }
</style>
</head>
<body>

<h1>üå© VIZCAYA RISK ENGINE</h1>

<div id="severity-index">
  <div id="severity-bar"></div>
  <div id="severity-text">Syncing Operational Data...</div>
</div>

<div id="alerts">Scanning NWS...</div>

<h2>üóì 7-Day Operational Hazard Timeline</h2>
<p style="text-align:center; font-size:0.7rem; color:#94a3b8; margin-bottom:10px; letter-spacing: 1px;">TOMORROW THROUGH DAY 8</p>
<div id="timeline-grid"></div>

<div id="output"></div>

<h2>‚ö° Infrastructure & Safety Indices</h2>
<div id="severe-panel" class="severe-panel-grid">Processing...</div>

<div class="card" style="margin-top:20px;">
  <span class="label">Operational Threshold Definitions</span>
  <p style="font-size:0.75rem; line-height:1.5; color:#94a3b8; margin:0;">
    <b>Plumbing</b>: Critical &lt; 20¬∞F | <b>Ice</b>: ‚â§ 32¬∞F + Precip Prob ‚â• 20% | <b>Heavy Rain</b>: Rate ‚â• 0.15"/hr | <b>Wind</b>: Gusts ‚â• 30mph<br>
    <b>Fire</b>: Wind &gt; 15mph + Humidity &lt; 25% | <b>Heat</b>: Index ‚â• 95¬∞F | <b>SPC/Tropical</b>: NWS Severe/Hurricane Keywords
  </p>
</div>

<script>
const LAT = 30.5083, LON = -97.6789;

async function runRiskEngine() {
  try {
    const [weatherRes, alertRes] = await Promise.all([
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,apparent_temperature,wind_speed_10m,wind_gusts_10m,precipitation_probability,precipitation,snowfall,weathercode,cape,lifted_index,relative_humidity_2m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&forecast_days=8&timezone=auto`),
      fetch(`https://api.weather.gov/alerts/active?point=${LAT},${LON}`, { headers: { 'User-Agent': 'VizcayaRiskEngine/4.0' }})
    ]);

    const weather = await weatherRes.json();
    const alertData = await alertRes.json();
    const h = weather.hourly;
    const alerts = alertData.features || [];

    // DATA SLICE: Start Tomorrow (Index 24)
    const startIdx = 24; 
    const times = h.time.slice(startIdx);
    const temps = h.temperature_2m.slice(startIdx);
    const appTemps = h.apparent_temperature.slice(startIdx);
    const gusts = h.wind_gusts_10m.slice(startIdx);
    const pops = h.precipitation_probability.slice(startIdx);
    const rainRates = h.precipitation.slice(startIdx);
    const snowRates = h.snowfall.slice(startIdx);
    const rhs = h.relative_humidity_2m.slice(startIdx);

    // Global Alert Scanning
    const alertText = alerts.map(a => (a.properties.event + " " + a.properties.headline).toLowerCase()).join(" ");
    const hasFloodAlert = alertText.includes("flood");
    const hasSPCTropical = ["severe", "hurricane", "tropical", "surge", "tornado"].some(word => alertText.includes(word));

    const hazards = {
      freeze: [], ice: [], snow: [], rain: [], wind: [], tropical: [], heat: [], fire: []
    };

    for(let i=0; i < times.length; i++) {
      const d = new Date(times[i]);
      const dayKey = d.getDate();
      
      if (temps[i] <= 32) hazards.freeze.push(dayKey);
      if (temps[i] <= 32 && pops[i] >= 20) hazards.ice.push(dayKey);
      if (snowRates[i] >= 0.1) hazards.snow.push(dayKey);
      if (rainRates[i] >= 0.15 || hasFloodAlert) hazards.rain.push(dayKey);
      if (gusts[i] >= 30) hazards.wind.push(dayKey);
      if (hasSPCTropical) hazards.tropical.push(dayKey);
      if (appTemps[i] >= 95) hazards.heat.push(dayKey);
      if (gusts[i] > 15 && rhs[i] < 25) hazards.fire.push(dayKey);
    }

    // SCORING
    const minTemp = Math.min(...temps);
    const maxWind = Math.max(...gusts);
    const maxApp = Math.max(...appTemps);
    let score = 0;
    if (minTemp <= 32) score += 20;
    if (minTemp < 20) score += 25;
    if (hazards.ice.length > 0) score += 30;
    if (hazards.snow.length > 0) score += 15;
    if (maxWind >= 30) score += 15;
    if (hasSPCTropical) score += 20;
    if (hazards.fire.length > 0) score += 15;
    if (maxApp >= 95) score += 10;
    const finalScore = Math.min(100, score);

    // SEVERITY UI
    const sevBar = document.getElementById("severity-bar");
    const sevText = document.getElementById("severity-text");
    sevBar.style.width = finalScore + "%";
    sevBar.style.background = finalScore > 70 ? "#dc2626" : (finalScore > 35 ? "#f97316" : "#16a34a");
    sevText.innerText = `${finalScore > 70 ? 'HIGH' : (finalScore > 35 ? 'MODERATE' : 'LOW')} OPERATIONAL RISK: ${finalScore}%`;

    // TIMELINE GRID (8 ROWS)
    const grid = document.getElementById("timeline-grid");
    grid.innerHTML = "";
    const hazardConfigs = [
      { key: 'freeze',   label: 'FREEZE',    color: '#3b82f6' },
      { key: 'ice',      label: 'ICE/SLEET', color: '#ef4444' },
      { key: 'snow',     label: 'SNOW',      color: '#a855f7' },
      { key: 'rain',     label: 'HEAVY RAIN',color: '#22d3ee' },
      { key: 'wind',     label: 'HIGH WIND', color: '#fbbf24' },
      { key: 'tropical', label: 'SPC/TROP',  color: '#ec4899' },
      { key: 'heat',     label: 'HEAT',      color: '#f97316' },
      { key: 'fire',     label: 'FIRE',      color: '#fb923c' }
    ];

    for(let d=0; d<7; d++) {
      const dayDate = new Date(times[d * 24]);
      const dayBox = document.createElement("div");
      dayBox.className = "timeline-day";
      dayBox.innerHTML = `<div class="timeline-day-label">${dayDate.toLocaleDateString('en-US', {weekday:'short', day:'numeric'})}</div>`;
      
      hazardConfigs.forEach(h => {
        const hasHazard = hazards[h.key].includes(dayDate.getDate());
        dayBox.innerHTML += `
          <div class="timeline-hazard-row">
            <div class="timeline-hazard-name">${h.label}</div>
            <div class="timeline-hazard-bar" style="${hasHazard ? `background:${h.color}; box-shadow: 0 0 5px ${h.color};` : ''}"></div>
          </div>`;
      });
      grid.appendChild(dayBox);
    }

    // INDICES PANEL (ALL 8 CATEGORIES)
    const plumbingStatus = minTemp < 20 ? ["CRITICAL", "severe-high"] : (minTemp <= 32 ? ["MODERATE", "severe-mod"] : ["LOW", "severe-low"]);
    const rainStatus = hazards.rain.length > 0 ? ["THREAT", "severe-mod"] : ["LOW", "severe-low"];
    const heatStatus = maxApp >= 95 ? ["STRESS", "severe-mod"] : ["NORMAL", "severe-low"];
    const snowStatus = hazards.snow.length > 0 ? ["POTENTIAL", "severe-mod"] : ["NONE", "severe-low"];

    document.getElementById("severe-panel").innerHTML = `
      <div class="severe-row ${plumbingStatus[1]}"><strong>Plumbing Stress</strong><span>${plumbingStatus[0]}</span></div>
      <div class="severe-row ${hazards.ice.length ? 'severe-high' : 'severe-low'}"><strong>Icing Potential</strong><span>${hazards.ice.length ? 'HIGH' : 'LOW'}</span></div>
      <div class="severe-row ${snowStatus[1]}"><strong>Snow Potential</strong><span>${snowStatus[0]}</span></div>
      <div class="severe-row ${rainStatus[1]}"><strong>Rain Threat</strong><span>${rainStatus[0]}</span></div>
      <div class="severe-row ${maxWind >= 30 ? 'severe-mod' : 'severe-low'}"><strong>Wind Load</strong><span>${maxWind.toFixed(0)} MPH</span></div>
      <div class="severe-row ${hasSPCTropical ? 'severe-high' : 'severe-low'}"><strong>SPC/Tropical</strong><span>${hasSPCTropical ? 'ACTIVE' : 'NONE'}</span></div>
      <div class="severe-row ${heatStatus[1]}"><strong>Heat Stress</strong><span>${heatStatus[0]}</span></div>
      <div class="severe-row ${hazards.fire.length ? 'severe-high' : 'severe-low'}"><strong>Fire Weather</strong><span>${hazards.fire.length ? 'RED FLAG' : 'LOW'}</span></div>
    `;

    // ALERTS
    const alertsEl = document.getElementById("alerts");
    if (alerts.length > 0) {
      alertsEl.innerHTML = alerts.map(a => `<div class="alert-card">‚ö†Ô∏è ${a.properties.event}<br><small>${a.properties.headline}</small></div>`).join("");
    } else {
      alertsEl.innerHTML = `<div class="card safe">‚úÖ No active NWS alerts for tomorrow's 7-day outlook.</div>`;
    }

    // NARRATIVE
    const outEl = document.getElementById("output");
    let msg = `Projections starting tomorrow indicate a min temperature of <b>${minTemp}¬∞F</b>. `;
    if (hazards.ice.length) msg += `<b>Icing risk</b> is detected for local bridges/overpasses. `;
    if (hazards.snow.length) msg += `<b>Accumulating snow</b> is possible within the window. `;
    if (hazards.rain.length) msg += `<b>Heavy rain rates</b> (‚â•0.15"/hr) may impact drainage. `;
    if (maxWind >= 30) msg += `Peak gusts of <b>${maxWind.toFixed(0)} MPH</b> will stress loose outdoor items. `;
    if (maxApp >= 95) msg += `Heat stress conditions (<b>${maxApp.toFixed(0)}¬∞F</b> Index) likely. `;
    
    outEl.innerHTML = `<div class="card ${finalScore > 50 ? 'orange' : 'yellow'}"><span class="label">Operational Impact Narrative</span><p>${msg}</p></div>`;

  } catch (err) {
    console.error(err);
    document.getElementById("severity-text").innerText = "Sync failure - check API connection";
  }
}

runRiskEngine();
setInterval(runRiskEngine, 1800000);
</script>
</body>
</html>
