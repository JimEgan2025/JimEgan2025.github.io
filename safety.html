<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vizcaya Safety Sequence | Strategic Narrative</title>
    <style>
        :root {
            --freeze-blue: #00d2ff; --heat-red: #ff5252; --rain-green: #00ff88; --chill-teal: #00f2fe;
            --warning-amber: #fbbf24; --bg-dark: #020617; --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc; --grid-orange: #f97316;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: radial-gradient(circle at top, #1e293b 0%, var(--bg-dark) 100%); padding: 20px; color: var(--text-main); min-height: 100vh; }
        .container { max-width: 1100px; margin: auto; backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.03); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .card { padding: 20px; border-radius: 16px; background: var(--card-bg); border: 1px solid rgba(255,255,255,0.05); position: relative; min-height: 180px; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; border-radius: 16px 16px 0 0; }
        .freeze::before { background: var(--freeze-blue); } .heat::before { background: var(--heat-red); } .rain::before { background: var(--rain-green); } .chill::before { background: var(--chill-teal); } .grid-stress::before { background: var(--grid-orange); }
        
        .label { font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .event-box { background: rgba(0, 0, 0, 0.3); border-left: 3px solid #475569; padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.85em; color: #cbd5e1; }
        .tag { font-size: 0.7rem; font-weight: bold; padding: 2px 8px; border-radius: 20px; margin-left: 8px; background: rgba(255, 255, 255, 0.1); color: #fff; }
        
        .summary-box { margin-top: 30px; padding: 25px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        .summary-title { font-weight: 800; color: var(--warning-amber); display: block; margin-bottom: 15px; font-size: 1.1em; text-transform: uppercase; letter-spacing: 2px; }
        .narrative-item { margin-bottom: 20px; padding-left: 20px; border-left: 4px solid #475569; }
        .narrative-item p { margin: 0; font-size: 1.1rem; line-height: 1.6; color: #e2e8f0; }
        #status-msg { text-align: center; color: var(--chill-teal); font-weight: bold; padding: 20px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1 style="margin:0; font-weight: 200; letter-spacing: 4px; color: #fff;">VIZCAYA <span style="font-weight: 800; color: var(--chill-teal);">SEQUENCE</span></h1>
        <p style="margin:5px 0; color:#94a3b8; font-size: 0.9em; letter-spacing: 1px;">STRATEGIC OPERATIONAL NARRATIVE | ROUND ROCK, TX</p>
    </div>

    <div id="status-msg">Synchronizing 16-Day Sequence...</div>

    <div id="main-ui" style="display:none;">
        <div class="grid">
            <div class="card chill"><span class="label">Human Health (Chill ≤32°)</span><div id="chill-list"></div></div>
            <div class="card freeze"><span class="label">Property (Actual ≤32°)</span><div id="freeze-list"></div></div>
            <div class="card rain"><span class="label">Rain Probability (≥20%)</span><div id="rain-list"></div></div>
            <div class="card heat"><span class="label">Heat Index (≥95°)</span><div id="heat-list"></div></div>
            <div class="card grid-stress"><span class="label">Grid Watch (Index ≥103°)</span><div id="grid-list"></div></div>
        </div>

        <div class="summary-box">
            <span class="summary-title">⚠️ Tomorrow's Strategic Narrative Builder</span>
            <div id="safety-narrative">Generating sequence analysis...</div>
        </div>
    </div>
</div>

<script>
async function updateDashboard() {
    const url = "https://api.open-meteo.com/v1/forecast?latitude=30.5083&longitude=-97.6789&hourly=temperature_2m,apparent_temperature,precipitation,precipitation_probability&temperature_unit=fahrenheit&precipitation_unit=inch&timezone=America/Chicago&forecast_days=16";
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        const hourly = data.hourly;
        
        // --- TOMORROW-FIRST LOGIC ---
        // Find the index for 12:00 AM Tomorrow
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        
        const startIdx = hourly.time.findIndex(t => new Date(t).getTime() >= tomorrow.getTime());
        // -----------------------------

        const fullDateOpts = { month: 'short', day: 'numeric', hour: 'numeric' };
        const shortTimeOpts = { hour: 'numeric' };

        function findWindows(dataArr, threshold, direction) {
            let windows = [], active = false, current = null;
            for (let i = startIdx; i < dataArr.length; i++) {
                const isBreached = direction === 'below' ? dataArr[i] <= threshold : dataArr[i] >= threshold;
                if (isBreached && !active) {
                    active = true;
                    current = { start: i, startTime: new Date(hourly.time[i]), maxProb: 0, totalAmount: 0, maxApparent: 0 };
                } 
                if (active) {
                    current.maxProb = Math.max(current.maxProb, hourly.precipitation_probability[i]);
                    current.totalAmount += hourly.precipitation[i];
                    current.maxApparent = Math.max(current.maxApparent, hourly.apparent_temperature[i]);
                }
                if (!isBreached && active) {
                    active = false;
                    current.end = i; 
                    current.endTime = new Date(hourly.time[i]); 
                    current.duration = i - current.start;
                    windows.push(current);
                }
            }
            return windows;
        }

        const chillWins = findWindows(hourly.apparent_temperature, 32, 'below');
        const freezeWins = findWindows(hourly.temperature_2m, 32, 'below');
        const rainWins = findWindows(hourly.precipitation_probability, 20, 'above');
        const heatWins = findWindows(hourly.apparent_temperature, 95, 'above');
        const gridWins = findWindows(hourly.apparent_temperature, 103, 'above');

        let narrativeHTML = "";

        // 1. FREEZE/CHILL SEQUENCE
        if (chillWins.length > 0) {
            const firstChill = chillWins[0];
            const nestedFreezes = freezeWins.filter(fW => fW.startTime >= firstChill.startTime && fW.startTime <= (firstChill.endTime || new Date(2099,1,1)));
            
            let phrase = `Wind chills fall to 32°F or below starting at <b>${firstChill.startTime.toLocaleString('en-US', fullDateOpts)}</b>. `;
            
            if (nestedFreezes.length > 0) {
                const fW = nestedFreezes[0];
                phrase += `Inside that window, an <b>actual freeze</b> period begins at <b>${fW.startTime.toLocaleString('en-US', shortTimeOpts)}</b>, lasting approximately <b>${fW.duration} hours</b>. `;
            } else {
                phrase += `However, air temperatures are expected to stay above 32°F—actual pipe freezing is unlikely during this window. `;
            }
            narrativeHTML += `<div class="narrative-item" style="border-left-color: var(--chill-teal)"><p>"${phrase}"</p></div>`;
        }

        // 2. PRECIPITATION SEQUENCE
        if (rainWins.length > 0) {
            const rW = rainWins[0];
            const isOverlap = freezeWins.some(fW => (rW.startTime < fW.endTime && rW.endTime > fW.startTime));
            
            let phrase = `We anticipate rain between <b>${rW.startTime.toLocaleString('en-US', fullDateOpts)}</b> and <b>${rW.endTime.toLocaleString('en-US', shortTimeOpts)}</b> (duration: ${rW.duration}h). `;
            phrase += isOverlap ? `<b>CRITICAL:</b> Precipitation overlaps with freezing temperatures. Icing is likely.` : `Temperatures remain above freezing during this rain event.`;
            
            narrativeHTML += `<div class="narrative-item" style="border-left-color: ${isOverlap ? 'var(--warning-amber)' : 'var(--rain-green)'}"><p>"${phrase}"</p></div>`;
        }

        // 3. HEAT & GRID SEQUENCE
        if (heatWins.length > 0) {
            const hW = heatWins[0];
            const gW = gridWins.find(g => g.startTime >= hW.startTime);
            
            let phrase = `Heat indices reach 95°F+ starting <b>${hW.startTime.toLocaleString('en-US', fullDateOpts)}</b> for <b>${hW.duration} hours</b>. `;
            if (gW) {
                phrase += `Indices will peak above <b>103°F</b> at <b>${gW.startTime.toLocaleString('en-US', shortTimeOpts)}</b>, signaling elevated grid stress.`;
            }
            narrativeHTML += `<div class="narrative-item" style="border-left-color: var(--heat-red)"><p>"${phrase}"</p></div>`;
        }

        document.getElementById('safety-narrative').innerHTML = narrativeHTML || "<p>No significant risks detected in the upcoming 15-day sequence.</p>";

        function render(id, windows, isPrecip = false) {
            const container = document.getElementById(id);
            if (windows.length === 0) { container.innerHTML = "<div style='opacity:0.3; margin-top:20px;'>CLEAR</div>"; return; }
            container.innerHTML = windows.slice(0, 3).map(w => `
                <div class="event-box">
                    <span style="color:#fff; font-weight:bold;">${w.startTime.toLocaleString('en-US', {month:'short', day:'numeric', hour:'numeric'})}</span>
                    <span class="tag" style="color:var(--chill-teal)">${isPrecip ? w.totalAmount.toFixed(2) + '"' : w.duration + 'h'}</span>
                    <div style="font-size:0.7em; opacity:0.5; margin-top:4px;">${isPrecip ? 'Duration: ' + w.duration + 'h' : 'Window Ends: ' + w.endTime.toLocaleString('en-US', shortTimeOpts)}</div>
                </div>
            `).join('');
        }

        render('chill-list', chillWins);
        render('freeze-list', freezeWins);
        render('rain-list', rainWins, true);
        render('heat-list', heatWins);
        render('grid-list', gridWins);

        document.getElementById('status-msg').style.display = 'none';
        document.getElementById('main-ui').style.display = 'block';

    } catch (err) {
        document.getElementById('status-msg').innerHTML = "Connection Error. Check API status.";
        console.error(err);
    }
}
updateDashboard();
</script>
</body>
</html>
