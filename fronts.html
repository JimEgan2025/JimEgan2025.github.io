<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIZCAYA HAZARD & ARRIVAL TRACKER v2.4</title>
<style>
:root {
  --bg: #020617; --card: #0f172a; --text: #f8fafc;
  --hazard-red: #ef4444; --hazard-blue: #3b82f6;
  --accent: #93c5fd; --border: #1e293b;
}
body {
  font-family: system-ui, -apple-system, sans-serif;
  background-color: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}
.header {
  text-align: center;
  border-bottom: 2px solid var(--hazard-red);
  padding-bottom: 10px;
}
.header h1 {
  margin: 0;
  font-size: 1.6rem;
  letter-spacing: 2px;
  color: #fff;
  text-transform: uppercase;
}
#last-refresh {
  font-size: 0.8rem;
  color: var(--accent);
  margin-top: 5px;
  font-weight: bold;
}
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}
.full-width { grid-column: span 2; }
h2 {
  margin-top: 0;
  color: var(--accent);
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 5px;
  margin-bottom: 10px;
}
.stat-large {
  font-size: 4rem;
  font-weight: bold;
  margin: 5px 0;
  line-height: 1;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}
.alert-active {
  background: #450a0a;
  border-left: 8px solid var(--hazard-red);
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  font-size: 0.9rem;
}
#tracker-box {
  background: #000;
  padding: 10px;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
  border: 1px solid #1e293b;
}
.city-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1.4fr 1.6fr 1fr;
  padding: 6px 5px;
  border-bottom: 1px solid #111;
  font-size: 0.85rem;
  align-items: center;
}
.city-header {
  font-weight: bold;
  color: var(--accent);
  border-bottom: 1px solid var(--border);
  padding-bottom: 4px;
  margin-bottom: 4px;
}
.city-row:last-child { border-bottom: none; }
.status-tag {
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: bold;
}
.status-passed {
  background: #16a34a33;
  color: #22c55e;
}
.status-near {
  background: #f9731633;
  color: #f97316;
}
.status-notyet {
  background: #64748b33;
  color: #cbd5f5;
}
.status-container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 5px;
}
.hub-status {
  display: flex;
  justify-content: space-between;
  padding: 8px;
  border-radius: 6px;
  background: #1e293b;
  border-left: 4px solid #334155;
  font-size: 0.8rem;
}
.status-crit {
  border-left-color: var(--hazard-red);
  background: #450a0a;
  color: #fff;
  font-weight: bold;
}
.status-ok {
  border-left-color: #22c55e;
  color: #22c55e;
}
@media (max-width: 768px) {
  .grid { grid-template-columns: 1fr; }
  .full-width { grid-column: span 1; }
}
</style>
</head>
<body>
<div class="header">
  <h1>Vizcaya Hazard & Arrival Tracker</h1>
  <div id="last-refresh">Syncing Synoptic Data...</div>
</div>

<div class="grid">
  <!-- TIER 1: RISK INDEX -->
  <div class="card">
    <h2>Infrastructure Risk (Peak Window)</h2>
    <div id="local-dsi" class="stat-large">--%</div>
    <p id="local-narrative"
       style="font-weight:bold;font-size:1rem;color:var(--hazard-red);margin:0;">
       Awaiting Data...
    </p>
    <p id="risk-breakdown"
       style="font-size:0.8rem;color:#94a3b8;margin-top:8px;line-height:1.3;">
    </p>
  </div>

  <!-- TIER 2: BOUNDARY / ARRIVAL TRACKER -->
  <div class="card">
    <h2>Texas Boundary & Arrival Tracker</h2>
    <div id="tracker-box">
      <div class="city-row city-header">
        <span>LOCATION</span>
        <span>TEMP</span>
        <span>CHILL</span>
        <span>WIND</span>
        <span>STATUS</span>
        <span>∆T (3h)</span>
      </div>
      <div id="city-data"></div>
    </div>
    <p id="arrival-eta"
       style="font-size:0.75rem;margin-top:10px;color:var(--accent);font-weight:bold;text-align:center;text-transform:uppercase;">
    </p>
  </div>

  <!-- TIER 3: TEXAS ALERTS -->
  <div class="card full-width">
    <h2>Active Critical Texas Alerts (NWS)</h2>
    <div id="alerts-area">Checking active warnings...</div>
  </div>

  <!-- TIER 4: AVIATION HUBS -->
  <div class="card">
    <h2>Aviation Hub Status</h2>
    <div id="hub-area" class="status-container"></div>
  </div>

  <!-- TIER 4: INTERSTATE CORRIDORS -->
  <div class="card">
    <h2>Interstate Safety Grid</h2>
    <div id="corridor-area" class="status-container"></div>
  </div>
</div>

<script>
const LAT = 30.508;
const LON = -97.679;

// Ordered roughly north→south, with Del Rio just after San Antonio
const CITIES = [
  { key: "AMA", name: "Amarillo",       lat: 35.22, lon: -101.83 }, // I-40
  { key: "LBB", name: "Lubbock",        lat: 33.57, lon: -101.85 },
  { key: "SJT", name: "San Angelo",     lat: 31.46, lon: -100.44 },
  { key: "ABI", name: "Abilene",        lat: 32.44, lon: -99.73  },
  { key: "DFW", name: "DFW Airport",    lat: 32.89, lon: -97.04  },
  { key: "ACT", name: "Waco",           lat: 31.54, lon: -97.14  },
  { key: "VIZ", name: "Vizcaya/RR",     lat: 30.50, lon: -97.67  },
  { key: "SAT", name: "San Antonio",    lat: 29.42, lon: -98.49  },
  { key: "DRT", name: "Del Rio",        lat: 29.37, lon: -100.90 },
  { key: "CRP", name: "Corpus Christi", lat: 27.80, lon: -97.40  },
  { key: "BRO", name: "Brownsville",    lat: 25.90, lon: -97.43  }
];

const UPSTREAM_KEYS = ["DFW", "ACT", "SJT", "SAT", "CRP", "BRO"];

let tempHistory = {}; // key -> [{time: Date, temp: number}]

function getWindDir(deg) {
  const sectors = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
  return sectors[Math.round(deg / 45) % 8];
}

async function updateTracker() {
  try {
    const forecastRes = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}` +
      `&hourly=temperature_2m,precipitation_probability&temperature_unit=fahrenheit&forecast_days=3`
    );
    const fData = await forecastRes.json();

    const cityQuery = CITIES.map(c => `latitude=${c.lat}&longitude=${c.lon}`).join('&');
    const currentRes = await fetch(
      `https://api.open-meteo.com/v1/gfs?${cityQuery}` +
      `&current=temperature_2m,apparent_temperature,wind_speed_10m,wind_direction_10m` +
      `&temperature_unit=fahrenheit&wind_speed_unit=mph&forecast_days=1`
    );
    const cData = await currentRes.json();
    const currentCities = Array.isArray(cData) ? cData : [cData];

    const alertRes = await fetch(
      `https://api.weather.gov/alerts/active?point=${LAT},${LON}`
    );
    const aData = await alertRes.json();

    processData(fData, currentCities, aData);
  } catch (e) {
    console.error(e);
    document.getElementById('last-refresh').innerText = "Sync Error - Retrying...";
  }
}

function processData(forecast, currentCities, alerts) {
  const now = new Date();

  // --- DSI ---
  if (!forecast.hourly ||
      !forecast.hourly.temperature_2m ||
      !forecast.hourly.precipitation_probability) {
    document.getElementById('local-dsi').innerText = '--%';
    document.getElementById('local-narrative').innerText =
      'DATA GAP – CHECK DASHBOARD';
  } else {
    let dsi = 0; let reasons = [];
    const h = forecast.hourly;
    const minTemp = Math.min(...h.temperature_2m);
    const freezeHours = h.temperature_2m.filter(t => t <= 32).length;
    const hasIce = h.time.some((t, i) =>
      h.temperature_2m[i] <= 32 && h.precipitation_probability[i] >= 20
    );
    const activeAlerts = alerts.features || [];

    if (minTemp <= 32)      { dsi += 25; reasons.push("FREEZE"); }
    if (freezeHours > 24)   { dsi += 25; reasons.push("PROLONGED"); }
    if (hasIce)             { dsi += 30; reasons.push("ICING"); }
    if (activeAlerts.length > 0) { dsi += 20; reasons.push("ALERTS"); }

    const finalDSI = Math.min(100, dsi);
    const dsiEl = document.getElementById('local-dsi');
    dsiEl.innerText = `${finalDSI}%`;
    dsiEl.style.color = finalDSI > 75 ? 'var(--hazard-red)' : 'var(--accent)';

    const narrativeEl = document.getElementById('local-narrative');
    if (finalDSI > 75) {
      narrativeEl.innerText = "CRITICAL INFRASTRUCTURE ALERT";
    } else if (finalDSI >= 40) {
      narrativeEl.innerText = "ELEVATED MONITORING";
    } else {
      narrativeEl.innerText = "BASELINE MONITORING";
    }

    document.getElementById('risk-breakdown').innerHTML =
      `<strong>REASONS:</strong> ${reasons.join(" + ")}<br>` +
      `<strong>MIN:</strong> ${minTemp.toFixed(1)}°F | ` +
      `<strong>DURATION:</strong> ${freezeHours} HRS`;
  }

  // --- CITY STRIP + ARRIVAL STATUS ---
  const cityBox = document.getElementById('city-data');
  cityBox.innerHTML = "";

  const statuses = [];

  CITIES.forEach((city, idx) => {
    const c = currentCities[idx];
    const tNow  = c.current.temperature_2m;
    const wcNow = c.current.apparent_temperature;
    const wsNow = c.current.wind_speed_10m;
    const wdNow = c.current.wind_direction_10m;
    const wdTxt = getWindDir(wdNow);

    if (!tempHistory[city.key]) tempHistory[city.key] = [];
    tempHistory[city.key].push({ time: now, temp: tNow });
    tempHistory[city.key] = tempHistory[city.key].filter(
      r => now - r.time <= 12 * 3600000
    );

    const threeHoursAgo = now.getTime() - 3 * 3600000;
    const past = tempHistory[city.key].find(r => r.time.getTime() <= threeHoursAgo);
    const dT = past ? tNow - past.temp : null;

    let status = "NOT YET";
    let statusClass = "status-notyet";
    if (dT !== null) {
      if (dT <= -10) {
        status = "PASSED";
        statusClass = "status-passed";
      } else if (dT <= -4) {
        status = "NEAR / TRANSITION";
        statusClass = "status-near";
      }
    }

    statuses.push({ city, status, statusClass, dT });

    cityBox.innerHTML += `
      <div class="city-row">
        <span>${city.name}</span>
        <span style="color:${tNow <= 32 ? '#60a5fa' : '#fff'}">${tNow.toFixed(0)}°</span>
        <span style="color:${wcNow <= 32 ? 'var(--hazard-red)' : '#94a3b8'}">${wcNow.toFixed(0)}°</span>
        <span>${wdTxt} ${wsNow.toFixed(0)}</span>
        <span><span class="status-tag ${statusClass}">${status}</span></span>
        <span>${dT === null ? '---' : dT.toFixed(1) + '°'}</span>
      </div>`;
  });

  // --- ETA to Vizcaya from upstream tripwires ---
  const viz = CITIES.find(c => c.key === "VIZ");
  const upstreamPassed = statuses
    .filter(s => UPSTREAM_KEYS.includes(s.city.key) && s.status === "PASSED")
    .sort((a, b) => b.city.lat - a.city.lat);

  let etaText = "BOUNDARY STATUS: IN TRANSIT / NO RELIABLE ETA YET";
  if (upstreamPassed.length > 0) {
    const ref = upstreamPassed[0];
    const dLat = viz.lat - ref.city.lat;
    const avgDegPerHr = 0.4; // tuned for arctic fronts
    const hours = dLat / avgDegPerHr;
    if (hours > 0 && hours < 48) {
      const eta = new Date(now.getTime() + hours * 3600000);
      etaText =
        `BOUNDARY ESTIMATE: PASSED ${ref.city.name.toUpperCase()} – ` +
        `ETA VIZCAYA ≈ ${hours.toFixed(1)} hrs (~${eta.toLocaleTimeString('en-US', { timeZone: 'America/Chicago' })})`;
    } else if (hours <= 0) {
      etaText = "BOUNDARY ESTIMATE: POST-FRONTAL AIRMASS AT OR SOUTH OF VIZCAYA";
    }
  }
  document.getElementById('arrival-eta').innerText = etaText;

  // --- ALERTS (improved detail) ---
  const activeAlerts = alerts.features || [];
  const alertsArea = document.getElementById('alerts-area');
  if (activeAlerts.length > 0) {
    alertsArea.innerHTML = activeAlerts.map(a => {
      const p = a.properties;
      const title = p.event || 'Alert';
      const headline = p.headline || p.senderName || '';
      const fullDesc = (p.description || '').trim();
      const shortDesc = fullDesc.length > 600
        ? fullDesc.slice(0, 600) + '…'
        : fullDesc;
      const descHtml = shortDesc
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .join('<br>');
      const instructions = (p.instruction || '').trim();

      return `
        <div class="alert-active">
          <div><strong>${title}</strong></div>
          <div style="font-size:0.8rem;color:#e5e7eb;">${headline}</div>
          <div style="margin-top:4px;font-size:0.8rem;">${descHtml}</div>
          ${instructions
            ? `<div style="margin-top:6px;font-size:0.8rem;color:#fde68a;"><strong>Instructions:</strong> ${instructions}</div>`
            : ''}
        </div>`;
    }).join('');
  } else {
    alertsArea.innerHTML =
      "<div class='hub-status status-ok'>No active life-safety warnings for Vizcaya.</div>";
  }

  // --- HUBS & CORRIDORS ---
  const isF = (idx) => currentCities[idx].current.temperature_2m <= 32;
  const dfwIdx = CITIES.findIndex(c => c.key === "DFW");
  const vizIdx = CITIES.findIndex(c => c.key === "VIZ");
  const satIdx = CITIES.findIndex(c => c.key === "SAT");
  const houIdx = CITIES.findIndex(c => c.key === "HOU"); // currently not in CITIES; keep if you add HOU back
  const amaIdx = CITIES.findIndex(c => c.key === "AMA");
  const abiIdx = CITIES.findIndex(c => c.key === "ABI");
  const drtIdx = CITIES.findIndex(c => c.key === "DRT");
  const crpIdx = CITIES.findIndex(c => c.key === "CRP");
  const broIdx = CITIES.findIndex(c => c.key === "BRO");

  document.getElementById('hub-area').innerHTML = `
    <div class="hub-status ${isF(dfwIdx) ? 'status-crit' : 'status-ok'}">
      <span>DFW HUB</span><span>${isF(dfwIdx) ? 'ICE RISK' : 'OPEN'}</span>
    </div>
    <div class="hub-status ${isF(vizIdx) ? 'status-crit' : 'status-ok'}">
      <span>AUS HUB (VIZCAYA)</span><span>${isF(vizIdx) ? 'ICE RISK' : 'OPEN'}</span>
    </div>
    <div class="hub-status ${isF(satIdx) ? 'status-crit' : 'status-ok'}">
      <span>SAT HUB</span><span>${isF(satIdx) ? 'ICE RISK' : 'OPEN'}</span>
    </div>
  `;

  document.getElementById('corridor-area').innerHTML = `
    <div class="hub-status ${isF(amaIdx) ? 'status-crit' : 'status-ok'}">
      <span>I-40 (AMARILLO)</span><span>${isF(amaIdx) ? 'ICE' : 'OPEN'}</span>
    </div>
    <div class="hub-status ${isF(dfwIdx) ? 'status-crit' : 'status-ok'}">
      <span>I-35 NORTH (DFW)</span><span>${isF(dfwIdx) ? 'ICE' : 'OPEN'}</span>
    </div>
    <div class="hub-status ${isF(broIdx) ? 'status-crit' : 'status-ok'}">
      <span>I-69E (BROWNSVILLE)</span><span>${isF(broIdx) ? 'FREEZE' : 'OPEN'}</span>
    </div>
    <div class="hub-status ${isF(abiIdx) ? 'status-crit' : 'status-ok'}">
      <span>I-20 WEST (ABI)</span><span>${isF(abiIdx) ? 'ICE' : 'OPEN'}</span>
    </div>
    <div class="hub-status ${isF(drtIdx) ? 'status-crit' : 'status-ok'}">
      <span>US-90 WEST (DRT)</span><span>${isF(drtIdx) ? 'FREEZE' : 'OPEN'}</span>
    </div>
    <div class="hub-status ${isF(crpIdx) ? 'status-crit' : 'status-ok'}">
      <span>COASTAL (CRP)</span><span>${isF(crpIdx) ? 'FREEZE' : 'OPEN'}</span>
    </div>
  `;

  document.getElementById('last-refresh').innerText =
    `LIVE SYNOPTIC SYNC: ${now.toLocaleTimeString()} CST`;
}

updateTracker();
setInterval(updateTracker, 300000);
</script>
</body>
</html>
