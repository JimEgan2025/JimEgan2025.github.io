<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTU Front Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --bg: #121212; --card: #1e1e24; --text: #e0e0e0; --accent: #00d2d3; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin:0; padding:20px; }
        
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); border-radius: 8px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .card-header { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; color: #ccc; }
        canvas { width: 100% !important; height: 250px !important; }
        
        /* Wind Direction Arrow Styling */
        .wind-arrow { font-size: 1.2rem; display: inline-block; transform-origin: center; }

        .btn { background: var(--accent); border:none; padding:8px 16px; border-radius:4px; font-weight:bold; cursor:pointer; }
    </style>
</head>
<body>

<div style="text-align:center; margin-bottom:20px;">
    <h1>GTU Frontal Passage Tracker</h1>
    <div style="color:#888; font-size:0.9rem;">Look for: Pressure Rise + Temp Drop + Wind Shift</div>
</div>

<div class="container">

    <!-- 1. THERMODYNAMICS -->
    <div class="card">
        <div class="card-header">1. Temp (Red) & Dewpoint (Blue)</div>
        <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">Front arrives when both drop sharply</div>
        <canvas id="tempChart"></canvas>
    </div>

    <!-- 2. WIND SHIFT -->
    <div class="card">
        <div class="card-header">2. Wind Speed & Direction</div>
        <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">Look for Gust spike + Direction Shift</div>
        <canvas id="windChart"></canvas>
    </div>

    <!-- 3. PRESSURE & CLOUDS -->
    <div class="card">
        <div class="card-header">3. Pressure (Purple) & Clouds (Gray)</div>
        <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">Front arrives when Pressure hits bottom and shoots up</div>
        <canvas id="pressChart"></canvas>
    </div>

    <!-- 4. RADAR -->
    <div class="card">
        <div class="card-header">4. Visual Confirmation</div>
        <div id="map" style="height:250px; background:#111; border-radius:4px;"></div>
    </div>

</div>

<script>
    const LAT = 30.678; const LON = -97.679;
    
    // Added 'surface_pressure' and 'wind_direction_10m'
    const API = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&hourly=temperature_2m,dewpoint_2m,precipitation,surface_pressure,cloud_cover,wind_speed_10m,wind_gusts_10m,wind_direction_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto&forecast_days=2`;

    async function init() {
        const res = await fetch(API);
        const data = await res.json();
        renderCharts(data.hourly);
        initMap();
    }

    function renderCharts(hourly) {
        const labels = hourly.time.map(t => new Date(t).toLocaleTimeString([], {weekday:'short', hour:'numeric'}));
        
        const common = {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: { x: { ticks:{color:'#888'}, grid:{color:'#333'} }, y: { ticks:{color:'#888'}, grid:{color:'#333'} } },
            plugins: { legend: { labels:{color:'#fff'} } }
        };

        // 1. TEMP
        new Chart(document.getElementById('tempChart'), {
            type: 'line',
            data: { labels, datasets: [
                { label:'Temp', data:hourly.temperature_2m, borderColor:'#ff6b6b', borderWidth:3, pointRadius:0, tension:0.4 },
                { label:'Dewpoint', data:hourly.dewpoint_2m, borderColor:'#4ecdc4', borderWidth:2, borderDash:[5,5], pointRadius:0 }
            ]}, options: common
        });

        // 2. WIND (Custom Plugin for Arrows would be complex, using simple line for now)
        // We will map wind direction to the tooltip or just rely on the gust spike for now
        new Chart(document.getElementById('windChart'), {
            data: { labels, datasets: [
                { type:'line', label:'Gusts (mph)', data:hourly.wind_gusts_10m, borderColor:'#f1c40f', borderWidth:2, pointRadius:0 },
                { type:'bar', label:'Precip (in)', data:hourly.precipitation, backgroundColor:'#3498db', yAxisID:'y1' }
            ]},
            options: {
                ...common,
                scales: { ...common.scales, y1: { position:'right', grid:{drawOnChartArea:false} } },
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                // Add Wind Direction text to tooltip
                                if (context.dataset.label === 'Gusts (mph)') {
                                    const dir = hourly.wind_direction_10m[context.dataIndex];
                                    let cardinal = valToDir(dir);
                                    return `Direction: ${dir}Â° (${cardinal})`;
                                }
                            }
                        }
                    }
                }
            }
        });

        // 3. PRESSURE
        new Chart(document.getElementById('pressChart'), {
            type: 'line',
            data: { labels, datasets: [
                { label:'Pressure (hPa)', data:hourly.surface_pressure, borderColor:'#a29bfe', borderWidth:3, pointRadius:0, tension:0.4, yAxisID:'y' },
                { label:'Clouds (%)', data:hourly.cloud_cover, borderColor:'#555', backgroundColor:'rgba(255,255,255,0.1)', fill:true, borderWidth:0, pointRadius:0, tension:0.4, yAxisID:'y1' }
            ]},
            options: {
                ...common,
                scales: { 
                    ...common.scales, 
                    y: { display:true, title:{display:true, text:'Pressure'} }, 
                    y1: { position:'right', min:0, max:100, grid:{drawOnChartArea:false} } 
                }
            }
        });
    }

    function valToDir(d) {
        const dirs = ['N','NE','E','SE','S','SW','W','NW'];
        return dirs[Math.round(d / 45) % 8];
    }

    // Mini Map
    function initMap() {
        const map = L.map('map').setView([LAT, LON], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        L.marker([LAT, LON]).addTo(map);
        
        fetch("https://api.rainviewer.com/public/weather-maps.json").then(r=>r.json()).then(d=>{
            if(d.radar && d.radar.past) {
                const last = d.radar.past[d.radar.past.length-1];
                L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${last.time}/256/{z}/{x}/{y}/2/1_1.png`, {opacity:0.8}).addTo(map);
            }
        });
    }

    init();
</script>

</body>
</html>
